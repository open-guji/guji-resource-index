# 香港大学数字图书馆（Digital Repository@HKUL）

<!--
  本文件分两部分：
  - 分割线以上：用户文档，面向普通用户，语言简洁易懂，不含技术细节
  - 分割线以下：开发者文档，面向程序员，包含 API、HTML 解析、下载逻辑等技术细节
-->

香港大学图书馆（HKUL）建设的数字资源平台，汇集了港大图书馆及合作机构的数字化馆藏，涵盖古籍善本、历史照片、手稿、海报、音视频等多种类型。其中最重要的古籍资源为**馮平山圖書館善本書影像庫**，收录宋、元、明、清各朝善本约 116 种、1,025 册。

- 网站链接：https://digitalrepository.lib.hku.hk/
- 分享协议：Copyright © The University of Hong Kong. All Rights Reserved.
- 全站约 313,544 件数字资源（含报刊剪报、政府文献等各类藏品）
- 古籍善本约 116 种（馮平山圖書館善本書影像庫）
- 资源类型：善本古籍、木鱼书、粤剧泥印本、历史手稿、照片等
- 支持 IIIF 协议（Presentation API 2.0），可使用 [bookget](https://github.com/deweizhu/bookget) 下载

## 搜索与浏览

- 搜索页面：https://digitalrepository.lib.hku.hk/catalog?search_field=all_fields&q=
- 在首页搜索栏输入关键词即可搜索，支持选择搜索范围：全部字段（All）、题名（Title）、关键词（Keyword）、创建者（Creator）
- 搜索结果可按以下维度筛选：
  - 藏品集（Collection）
  - 日期（Date）
  - 资源类型（Resource type）
  - 材料类型（Material type）：文本、图像、视频、音频
  - 语言（Language）
  - 主题（Subject）
  - 创建者（Creator）
  - 出版者（Publisher）
  - 地理信息（Country、City、Area、District）
- 无需注册登录即可浏览和查看大部分开放资源（标记为 Open 的藏品）
- 部分资源标记为 "authenticated"，可能需要港大身份认证

### 古籍相关藏品集

直接浏览古籍相关藏品集的快捷方式：

| 藏品集 | 说明 | 数量 |
|--------|------|------|
| Fung Ping Shan Library Rare Books Online（馮平山圖書館善本書影像庫） | 宋、元、明、清善本古籍 | 约 116 种，1,025 册 |
| Wooden-Fish Books（木魚書） | 晚清至民国的民间说唱文本 | 约 230 种以上 |
| 粵劇泥印本特藏 | 粤剧泥印本剧本 | 39 种，198 册 |
| Dr Luo Zhenfu Collection（羅禎符太醫特藏） | 中医手稿 | 待确认 |
| Chinese Department Lecture Notes（中文學院講義系列） | 含《文心雕龍集解》等经典讲义 | 待确认 |

## 每本书能看到什么

| 字段 | 说明 | 示例 |
|------|------|------|
| Title（题名） | 书名，通常中英双语 | 新編方輿勝覽 七十卷 / Xin bian Fang yu sheng lan qi shi juan |
| Creator（著者） | 作者/编者 | 祝穆 (Zhu Mu), active 13th century |
| Date（日期） | 出版或抄写年代 | 1267 |
| Resource Type（资源类型） | 资源的类型 | Book |
| Material Type（材料类型） | 载体类型 | Text / Image |
| Call Number（索书号） | 馆内索书号 | 善 668.5 / 36 |
| Accession Number（入藏号） | 藏品编号 | fpslrbo_B14880829 |
| Collection（藏品集） | 所属藏品集 | Fung Ping Shan Library Rare Books Online |
| Visibility（可见性） | 访问权限 | Open |
| Description（描述） | 内容描述 | 待确认（部分藏品有） |

- 在线阅读：详情页以网格或列表形式展示各册/页的缩略图，点击可查看大图
- 无 PDF 整体下载功能
- 未发现全文 OCR 文字
- 图片查看器嵌入在页面中，支持翻页浏览

## 示例

- 善本详情页（新編方輿勝覽 七十卷，1267 年）：https://digitalrepository.lib.hku.hk/catalog/1c18md13n
- 中医手稿详情页（醫學撮要）：https://digitalrepository.lib.hku.hk/catalog/8k71v868x
- 古籍藏品集浏览：https://digitalrepository.lib.hku.hk/catalog?f%5Bcollection_tesim%5D%5B%5D=Fung+Ping+Shan+Library+Rare+Books+Online&search_field=all_fields&q=

---

# 开发者文档

## 技术平台

该网站基于 **Samvera/Hyrax** 数字仓储框架（Ruby on Rails），前端使用 **Chakra UI** 组件库（可能经过定制），后端搜索基于 **Solr**（可从字段后缀 `_tesim`、`_ssim`、`_ssi` 等推断）。支持 **IIIF Presentation API 2.0**。

## URL 结构

### 详情页
```
https://digitalrepository.lib.hku.hk/catalog/{work_id}
```
- `work_id`：Fedora 对象 ID（如 `1c18md13n`、`8k71v868x`），由字母和数字组成

### IIIF Manifest
```
https://digitalrepository.lib.hku.hk/service/api/iiif/manifest/{work_id}
```

### IIIF Image API
```
https://digitalrepository.lib.hku.hk/service/api/iiif/images/{file_set_id}/full/{size}/0/default.jpg
```
- `file_set_id`：每张图片的文件集 ID（如 `kh04mh193`、`r7823695n`）
- `size`：尺寸参数，`full` 为原尺寸，也可用 `{width},` 格式指定宽度

### 藏品集浏览
```
https://digitalrepository.lib.hku.hk/catalog?f[collection_tesim][]={collection_name}&search_field=all_fields&q=
```

## 搜索 API

基于 Blacklight/Solr 的搜索接口。可在搜索 URL 后追加 `.json` 获取 JSON 格式响应（Blacklight 标准行为，待确认是否开放）：

### 搜索请求
```
GET https://digitalrepository.lib.hku.hk/catalog.json?search_field=all_fields&q={keyword}
```

### 常用参数
| 参数 | 说明 | 示例 |
|------|------|------|
| `q` | 搜索关键词 | `方輿勝覽` |
| `search_field` | 搜索字段范围 | `all_fields` / `title` / `keyword` / `creator` |
| `f[collection_tesim][]` | 按藏品集筛选 | `Fung Ping Shan Library Rare Books Online` |
| `f[resource_type_tesim][]` | 按资源类型筛选 | `Book` |
| `f[material_type_tesim][]` | 按材料类型筛选 | `Text` / `Image` |
| `per_page` | 每页结果数 | `10` / `20` / `50` / `100` |
| `page` | 页码 | `1` |

> 注：JSON API 是否完全公开待确认，Blacklight 默认支持 `.json` 后缀，但部分站点可能禁用。

## 元数据获取

### 方式一：IIIF Manifest

从 IIIF Manifest 中可获取基本的结构信息，但实测发现该站点的 Manifest 元数据字段较少（`label` 和 `metadata` 数组可能为空）。Manifest 主要用于获取图片列表和 Canvas 信息。

### 方式二：HTML 页面解析

详情页为 SPA（Next.js / Chakra UI），HTML 中包含初始化的 JSON 数据。可尝试：
- 解析页面中嵌入的 JSON-LD 或 `__NEXT_DATA__` 脚本标签
- 直接从渲染后的 HTML 提取（需 headless browser）

### 方式三：Solr JSON API（待确认）
```
GET https://digitalrepository.lib.hku.hk/catalog/{work_id}.json
```
如果 Blacklight 的 JSON 端点可用，可直接获取结构化元数据。

### 字段映射

| 中文字段 | Solr 字段名（推测） | IIIF Manifest 路径 |
|---------|---------------------|-------------------|
| 题名 | `title_tesim` | `label` |
| 著者 | `creator_tesim` | `metadata[?].value` (label="Creator") |
| 日期 | `date_tesim` | `metadata[?].value` (label="Date") |
| 资源类型 | `resource_type_tesim` | — |
| 材料类型 | `material_type_tesim` | — |
| 索书号 | `call_number_tesim` | — |
| 入藏号 | `accession_number_tesim` | — |
| 藏品集 | `collection_tesim` | — |
| 可见性 | `visibility_ssi` | — |

> Solr 字段名基于 Hyrax 标准命名推测，`_tesim` = text, English, stored, indexed, multivalued；`_ssi` = string, stored, indexed。

## 下载

### IIIF 下载流程

1. **获取 Manifest**：
   ```
   GET https://digitalrepository.lib.hku.hk/service/api/iiif/manifest/{work_id}
   ```

2. **解析 Canvas 列表**：
   ```
   manifest.sequences[0].canvases[] → 每个 canvas 对应一页
   ```

3. **提取图片 URL**：
   ```
   canvas.images[0].resource.@id → 图片完整 URL
   ```
   典型格式：
   ```
   https://digitalrepository.lib.hku.hk/service/api/iiif/images/{file_set_id}/full/full/0/default.jpg
   ```

4. **可调整尺寸**：
   - 原尺寸：`.../full/full/0/default.jpg`
   - 指定宽度：`.../full/{width},/0/default.jpg`

### bookget 支持

bookget 已支持此网站，源码位于：
- https://github.com/deweizhu/bookget/blob/main/app/hkulib.go

**bookget 关键逻辑：**
- 从详情页 URL 中用正则 `catalog/([A-z0-9]+)` 提取 `work_id`
- 拼接 IIIF Manifest URL：`https://digitalrepository.lib.hku.hk/service/api/iiif/manifest/{work_id}`
- 解析 Manifest 中的 sequences → canvases → images
- 按 canvas 顺序下载图片，支持指定宽度
- 使用 cookie jar 管理会话
- 必需的 HTTP 请求头：
  - `User-Agent`：自定义 UA
  - `Referer`：URL 编码后的请求页面地址

**使用示例：**
```bash
bookget https://digitalrepository.lib.hku.hk/catalog/1c18md13n
bookget https://digitalrepository.lib.hku.hk/catalog/8k71v868x
```

### 图片保护与限制

- 实测 IIIF Manifest 在未登录状态下可能返回不完整数据（结构存在但缺少元数据）
- 图片本身（`/service/api/iiif/images/...`）似乎可以直接访问
- 部分标记为 "authenticated" 的藏品可能需要港大身份认证才能访问
- 未发现明显的水印机制（待确认）
- 未发现 Referer 校验限制（待确认，但 bookget 源码中设置了 Referer 头）
- 图片典型尺寸约 1800×2363 像素（JPEG 格式）
