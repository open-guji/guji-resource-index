# 哈佛大学图书馆 - Chinese Rare Books

哈佛燕京图书馆（Harvard-Yenching Library）的中文善本特藏数字化项目，托管于哈佛大学 CURIOSity 数字馆藏平台，是西方世界最大的中文善本收藏之一。

- 网站链接：https://curiosity.lib.harvard.edu/chinese-rare-books
- 浏览页面：https://curiosity.lib.harvard.edu/chinese-rare-books/browse
- 分享协议：[CC BY 4.0](https://creativecommons.org/licenses/by/4.0/)（[详细条款](https://nrs.lib.harvard.edu/urn-3:hul.ois:hlviewerterms)）
- 约 9,600+ 件数字化古籍，涵盖 13 至 19 世纪
- 资源类型：经史子集善本、明清刻本、手稿、信札等
- 支持 IIIF 协议，可使用 [bookget](https://github.com/deweizhu/bookget) 等工具下载

## 搜索与浏览

在搜索框输入关键词即可搜索，支持中英文：
- 搜索页面：https://curiosity.lib.harvard.edu/chinese-rare-books/catalog?search_field=all_fields&q={关键词}

搜索结果可按以下维度筛选：著者、年代、出版地、出版者、体裁、语种、馆藏机构、丛书/项目、主题。

## 每本书能看到什么

打开一本书的详情页，可以看到：

| 字段 | 说明 | 示例 |
|------|------|------|
| Title | 题名（中英文） | Zhou yi ; 周易 |
| Creator / Contributor | 著者 | 徐舆喬, jin shi 1661, ed. |
| Attribution | 著录信息 | 徐舆喬輯 ; 譚尚忠增輯 |
| Date | 年代（年号+公元） | Qing Qianlong 55 [1790] / 清乾隆55 [1790] |
| Place of Origin | 出版地 | China |
| Publisher | 出版者 | 紉芳齋 |
| Extent | 册数/形制 | 2 v. |
| Language | 语种 | Chinese |
| Subjects | 主题分类 | Chinese classics |
| Notes | 附注（装帧等） | Double leaves, oriental style, in case. |
| Series | 所属丛书/数字化项目 | Harvard-Yenching Library Chinese Rare Books Digitization Project |
| Repository | 馆藏机构 | Harvard-Yenching Library, Harvard University |

每本书都提供 IIIF 查看器在线翻阅，页面上有"Copy Manifest Link"按钮可复制 IIIF manifest 链接。

## 示例

- 详情页：https://curiosity.lib.harvard.edu/chinese-rare-books/catalog/49-990080724750203941
- IIIF 查看器：https://iiif.lib.harvard.edu/manifests/view/drs:53262215

---

# 开发者文档

## URL 结构

### 详情页
```
https://curiosity.lib.harvard.edu/chinese-rare-books/catalog/{collection_prefix}-{HOLLIS_record_id}
```
- `49`：集合前缀（Chinese Rare Books 固定为 49）
- `990080724750203941`：HOLLIS 馆藏记录 ID

### IIIF Manifest
```
https://nrs.harvard.edu/urn-3:FHCL:{NRS_ID}:MANIFEST
```
- `FHCL`：分库代码
- NRS = Name Resolution Service，会 302 跳转到实际 manifest 地址

### IIIF 查看器
```
https://iiif.lib.harvard.edu/manifests/view/drs:{DRS_ID}
```

### 单张图片（IIIF Image API 2.0）
```
https://mps.lib.harvard.edu/assets/images/drs:{IMAGE_ID}/full/full/0/default.jpg
```
缩略图：`/full/,250/0/default.jpg`

## JSON API（Blacklight）

平台基于 Blacklight（Ruby on Rails + Solr），在 URL 末尾加 `.json` 即可获取结构化数据。

### 搜索
```
GET https://curiosity.lib.harvard.edu/chinese-rare-books/catalog.json?q={关键词}&search_field=all_fields&per_page=10&page=1
```

响应包含分页信息（`meta.pages`）和结果数组（`data[]`），每条结果含 title、creator-contributor、date、publisher 等字段。

### 单条记录
```
GET https://curiosity.lib.harvard.edu/chinese-rare-books/catalog/{id}.json
```

**响应结构：**
```json
{
  "data": {
    "id": "49-990080724750203941",
    "attributes": {
      "title": "Zhou yi ; 周易",
      "creator-contributor_tesim": {
        "attributes": {"value": "Xu, Yuqiao...<br />徐舆喬...", "label": "Creator / Contributor"}
      },
      "date_ssim": {
        "attributes": {"value": "Qing Qianlong 55 [1790]", "label": "Date"}
      },
      "publisher_ssim": {
        "attributes": {"value": "紉芳齋,", "label": "Publisher"}
      }
    }
  }
}
```

### 筛选参数（Facets）

| 参数名 | 说明 |
|--------|------|
| `f[creators-contributors_ssim][]` | 著者/贡献者 |
| `f[date_ssim][]` | 年代 |
| `f[place-of-origin_ssim][]` | 出版地 |
| `f[publisher_ssim][]` | 出版者 |
| `f[genre_ssim][]` | 体裁 |
| `f[language_ssim][]` | 语种 |
| `f[repository_ssim][]` | 馆藏机构 |
| `f[series_ssim][]` | 丛书/项目 |
| `f[subjects_ssim][]` | 主题 |

### 字段映射

| 中文 | JSON 属性键 |
|------|------------|
| 题名 | `title` |
| 著者 | `creator-contributor_tesim` |
| 著录 | `attribution_tesim` |
| 年代 | `date_ssim` |
| 出版地 | `place-of-origin_ssim` |
| 出版者 | `publisher_ssim` |
| 册数 | `extent_tesim` |
| 语种 | `language_ssim` |
| 主题 | `subjects_ssim` |
| 附注 | `note_tesim` |
| 丛书 | `series_ssim` |
| 馆藏 | `repository_ssim` |
| 记录号 | `record-id_tesim` |

## HTML 解析

元数据位于 `<dl class="document-metadata dl-invert row">` 中，每个字段为 `<dt>` + `<dd>` 对：

```css
dl.document-metadata dt     /* 字段名 */
dl.document-metadata dd     /* 字段值 */
```

通过 class 名定位特定字段：
```css
.blacklight-full_title_tesim              /* 题名 */
.blacklight-creator-contributor_tesim     /* 著者 */
.blacklight-attribution_tesim            /* 著录信息 */
.blacklight-date_ssim                     /* 年代 */
.blacklight-place-of-origin_ssim         /* 出版地 */
.blacklight-publisher_ssim               /* 出版者 */
.blacklight-extent_tesim                 /* 册数 */
.blacklight-language_ssim                /* 语种 */
.blacklight-subjects_ssim                /* 主题 */
.blacklight-note_tesim                   /* 附注 */
.blacklight-series_ssim                  /* 丛书 */
.blacklight-repository_ssim             /* 馆藏机构 */
.blacklight-record-id_tesim             /* HOLLIS 记录号 */
```

提取 IIIF Manifest 链接的正则：
```regex
copyManifestToClipBoard\('([^']+)'\)
```

## IIIF 下载

支持 **IIIF Presentation API 2.0** 和 **IIIF Image API 2.0**。

### Manifest 结构

```json
{
  "@context": "http://iiif.io/api/presentation/2/context.json",
  "@type": "sc:Manifest",
  "label": "經史鈔 :十種. [China] : 紉芳齋, 清乾隆55 [1790].",
  "sequences": [{
    "canvases": [{
      "label": "(seq. 1)",
      "height": 3094,
      "width": 1798,
      "images": [{
        "resource": {
          "@id": "https://mps.lib.harvard.edu/assets/images/drs:53055078/full/full/0/default.jpg",
          "service": {
            "@id": "https://mps.lib.harvard.edu/assets/images/drs:53055078",
            "profile": "https://iiif.io/api/image/2/level2.json"
          }
        }
      }]
    }]
  }]
}
```

### 图片下载

从 manifest 提取每个 canvas 的 `resource.service.@id`，拼接 IIIF Image API 参数：
```
{service_id}/full/full/0/default.jpg    # 完整尺寸
{service_id}/full/1024,/0/default.jpg   # 限宽1024
{service_id}/info.json                   # 图片信息（dezoomify 用）
```

### 关键域名

| 域名 | 用途 |
|------|------|
| `nrs.harvard.edu` | Manifest 短链接（302 跳转） |
| `nrs.lib.harvard.edu` | Manifest 实际地址 |
| `mps.lib.harvard.edu` | 图片服务（新） |
| `ids.lib.harvard.edu` | 图片服务（旧，部分资源仍用） |
| `iiif.lib.harvard.edu` | IIIF 查看器 + 旧 manifest |
| `curiosity.lib.harvard.edu` | CURIOSity 目录 |

### bookget 支持

bookget 通过专用 `app/harvard.go` 支持，已注册三个域名：
- `iiif.lib.harvard.edu`
- `listview.lib.harvard.edu`
- `curiosity.lib.harvard.edu`

关键逻辑：
1. 提取 DRS ID：`manifests/view/([A-z0-9-_:]+)` 或 `manifests/([A-z0-9-_:]+)`
2. 构建 manifest URL：`https://iiif.lib.harvard.edu/manifests/{drs_id}`
3. 解析 canvas → 提取 `service.@id` → 拼接 `/full/full/0/default.jpg` 下载
4. 支持 dezoomify 高清下载（`info.json`）

相关源码：
- https://github.com/deweizhu/bookget/blob/main/app/harvard.go
- https://github.com/deweizhu/bookget/blob/main/app/iiif.go
- https://github.com/deweizhu/bookget/blob/main/model/iiif/iiif.go
