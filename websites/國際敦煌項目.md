# 國際敦煌項目（International Dunhuang Project / IDP）

<!--
  本文件分两部分：
  - 分割线以上：用户文档，面向普通用户，语言简洁易懂，不含技术细节
  - 分割线以下：开发者文档，面向程序员，包含 API、HTML 解析、下载逻辑等技术细节
-->

國際敦煌項目（IDP）是一项开创性的国际合作项目，1994 年由大英图书馆发起，旨在将丝绸之路东段出土的手稿、绘画、纺织品及其他文物进行保护、编目和数字化，并通过在线数据库向全球用户开放。目前已汇集来自全球 35 家以上合作机构的藏品。

- 网站链接：https://idp.bl.uk/
- 中国镜像站：http://idp.nlc.cn/
- 分享协议：数字化图像供学术研究和个人学习使用，具体条款见各合作机构规定
- 约 143,000 条编目记录、538,000 张以上数字图像（截至 2021 年数据）
- 资源类型：敦煌写卷、佛经手稿、绘画、纺织品、木简、印刷品、拓片
- 不支持 IIIF 协议

## 搜索与浏览

- 搜索页面：https://idp.bl.uk/collection/
- 高级搜索：https://idp.bl.uk/collection/#advanced
- 输入关键词即可搜索，如馆藏号（Or.8210/S.5531）、文物名称、语言等
- 支持按"仅有图片"筛选，快速找到已数字化的文献
- 搜索结果可按以下维度筛选：
  - 馆藏机构（如大英图书馆、中国国家图书馆、法国国家图书馆等）
  - 语言/文字（中文、藏文、梵文、回鹘文、粟特文等 15 种以上）
  - 材质类型（纸本、绢本、木简等）
  - 出土地点（敦煌、吐鲁番、黑水城等）
- 无需注册登录

### 合作机构

IDP 汇集以下主要机构的藏品：
1. 大英图书馆（伦敦）
2. 中国国家图书馆（北京）
3. 俄罗斯科学院东方文献研究所（圣彼得堡）
4. 龙谷大学（京都）
5. 柏林-勃兰登堡科学与人文学院（柏林）
6. 敦煌研究院（敦煌）
7. 法国国家图书馆（巴黎）

## 每本书能看到什么

| 字段 | 说明 | 示例 |
|------|------|------|
| Pressmark | 馆藏号 | Or.8210/S.6983 |
| Title | 题名 | Diamond Sutra |
| Date | 年代 | 868 CE |
| Language/Script | 语言/文字 | Chinese |
| Material | 材质 | Paper |
| Findspot | 出土地点 | Dunhuang, Mogao Caves |
| Collection | 所属馆藏 | Stein Collection |
| Description | 内容描述 | Buddhist sutra scroll |
| Conservation | 保存状态 | 修复记录 |

- 可在线浏览高清图片，支持缩放
- 大部分文献提供正反面扫描图
- 无 PDF 直接下载功能
- 无全文 OCR 文字（部分条目有学者录文）
- 提供教育资源和学习材料

## 示例

- IDP 检索页面：https://idp.bl.uk/collection/
- 金刚经（世界现存最早有明确日期的印刷品，868年）：https://idp.bl.uk/database/oo_scroll_h.a4d?uid=1&recnum=1&index=1
- 中国镜像站搜索：http://idp.nlc.cn/

---

# 开发者文档

## URL 结构

### IDP 主站（idp.bl.uk）

#### 搜索页面
```
https://idp.bl.uk/collection/
```

#### 高级搜索
```
https://idp.bl.uk/collection/#advanced
```

#### 文献详情页（旧版）
```
http://idp.bl.uk/database/oo_scroll_h.a4d?uid={uid};recnum={recnum};index={index}
```
- `uid`：临时会话标识，需先搜索获取，短时间内有效
- `recnum`：记录编号
- `index`：索引编号

### 中国镜像站（idp.nlc.cn）

#### 文献详情页
```
http://idp.nlc.cn/database/oo_scroll_h.a4d?uid={uid};recnum={recnum};index={index}
```
- 参数与主站相同
- `uid` 为临时参数，需先通过搜索获取

## 搜索 API

IDP 新版网站为 SPA 应用，后端 API 结构待进一步确认。

旧版系统使用 `.a4d` 后缀的动态页面（基于 4th Dimension 数据库），不提供标准 REST API。搜索需通过页面表单提交，返回的 URL 包含临时 `uid` 参数。

## 元数据获取

### 旧版详情页

旧版详情页为服务端渲染的 HTML 页面，元数据嵌入在 HTML 中。

关键数据提取方式：
- 图片记录编号嵌入在 JavaScript 变量中：`imageRecnum[n]="12345";`
- 正则提取：`imageRecnum\[\d+\][ \S]?=[ \S]?"(\d+)";`
- 提取后可构造图片 URL

### 字段映射

| 中文字段 | 提取方式 |
|---------|---------|
| 馆藏号 | HTML 解析，详情页标题区域 |
| 题名 | HTML 解析，Description 字段 |
| 年代 | HTML 解析，Date 字段 |
| 语言 | HTML 解析，Language/Script 字段 |
| 出土地点 | HTML 解析，Findspot 字段 |

## 下载

### bookget 支持

bookget 支持 IDP 中国镜像站的图片下载。

- 源码：https://github.com/deweizhu/bookget/blob/main/app/idp.go
- 支持的 URL 格式：
  ```
  http://idp.nlc.cn/database/oo_scroll_h.a4d?uid=xxxx;recnum=0;index=2
  ```

#### 下载流程（基于 bookget 源码分析）

1. **提取会话标识**：从 URL 中提取 `uid` 参数，正则：`uid=([A-Za-z0-9]+)`

2. **获取图片记录编号**：
   - 访问详情页 HTML
   - 解析 JavaScript 中的 `imageRecnum` 数组
   - 正则：`imageRecnum\[\d+\][ \S]?=[ \S]?"(\d+)";`

3. **构造图片 URL**：
   ```
   {scheme}://{host}/image_IDP.a4d?type=loadRotatedMainImage;recnum={image_recnum};rotate=0;imageType=_L
   ```
   - `image_recnum`：从第 2 步提取的图片记录编号
   - `imageType=_L`：大尺寸图片（L = Large）

4. **下载图片**：
   - 使用 Cookie Jar 保持会话状态
   - 文件命名：`0001.jpg`、`0002.jpg` 等零填充格式
   - 仅接受 HTTP 200 响应

#### 必需的 HTTP 请求头

| 请求头 | 值 | 说明 |
|--------|-----|------|
| User-Agent | 自定义浏览器 UA | 需设置合理的 User-Agent |
| Cookie | 会话 Cookie | 通过 Cookie Jar 维护，uid 有时效性 |

### 注意事项

- IDP 的 `uid` 参数是临时的，需先通过搜索操作获取，短时间内失效
- 中国镜像站（idp.nlc.cn）与主站（idp.bl.uk）的 API 结构相同
- 不支持 IIIF 协议，无法使用标准 IIIF 工具下载
- 图片有不同尺寸选项：`_S`（小）、`_M`（中）、`_L`（大）
