# 奥地利国家图书馆（ONB）

<!--
  本文件分两部分：
  - 分割线以上：用户文档，面向普通用户，语言简洁易懂，不含技术细节
  - 分割线以下：开发者文档，面向程序员，包含 API、HTML 解析、下载逻辑等技术细节
-->

奥地利国家图书馆（Österreichische Nationalbibliothek，简称 ONB）是奥地利最大的图书馆，位于维也纳。其数字化平台 ÖNB Digital 提供超过三百万件数字化资源的在线访问，涵盖图书、报纸、照片、图像、手稿、地图等多种类型。馆藏中包含约 1,342 件中文资源，主要为中文古籍（Sinica 馆藏），以历史、语言学类为主，尤以17至18世纪耶稣会在华刊印之西文及中文著作最具特色。其中部分珍品标记为 Cimelia Sinica（编号 Cim. Sin. 1-390），为馆中珍藏。

- 网站链接：https://onb.digital/
- 旧版阅览器：https://digital.onb.ac.at/OnbViewer/viewer.faces?doc=ABO_{id}（已重定向至新版）
- 新版阅览器：https://viewer.onb.ac.at/viewer/!ABO_{id}
- 分享协议：大量公共领域作品以 [CC BY-SA 4.0](https://creativecommons.org/licenses/by-sa/4.0/) 或公共领域标记提供，具体以每件资源页面所示为准
- 中文资源约 1,342 件（以 Sinica 馆藏和 ABO 项目数字化资源为主）
- 资源类型：古籍善本、写本手稿、地图、图片等
- 支持 IIIF 协议（IIIF Image API + IIIF Presentation API），可使用 [bookget](https://github.com/deweizhu/bookget) 等工具下载

## 搜索与浏览

- 搜索页面：https://onb.digital/search
- 在搜索栏输入关键词即可全文搜索（支持中文和西文关键词，如"Sinica"、拼音题名等）
- 搜索结果可按以下维度筛选：
  - **媒体类型**（Medientyp）：报纸、图书、照片、图像、手稿、地图等
  - **时间范围**：通过时间轴滑块选择出版年代
  - **主题词**（Schlagwort）：如日报、摄影、版画、维也纳、戏剧等
  - **语言**（Sprache）：可筛选"Chinesisch"（中文），约 1,342 条
  - **出版地**（Erscheinungsort）：维也纳、莱比锡等
- 不需要注册登录即可搜索和浏览
- 部分高清图片下载可能需要遵循使用条款

**提示**：搜索中文古籍时，建议使用以下关键词组合：
- 语言筛选选择"Chinesisch"
- 搜索"Sinica"或"Sin."
- 使用汉语拼音题名（如"Zhou yi"、"Lunyu"）
- 中文古籍编目多使用汉语拼音转写，中文字符的作者和题名也已录入目录

## 每本书能看到什么

| 字段 | 说明 | 示例 |
|------|------|------|
| 题名（Title） | 书名 | Selectarum Stirpium Americanarum Historia |
| 著者（Author） | 作者/编者 | Nikolaus Joseph von Jacquin |
| 出版年代（Date） | 出版或刊印年代 | 1780 |
| 馆藏编号（Shelfmark） | 馆内索书号 | Sin 354-B ALT SIN / Cim. Sin. 1 |
| 语言（Language） | 文献语言 | Chinese / Latin |
| 出版地（Place） | 出版地点 | Wien / Beijing |
| 数字化项目 | 所属数字化项目 | ABO (Austrian Books Online) |
| 条码（Barcode） | 数字对象唯一标识 | Z175775609 |

- 可在线逐页翻阅高清图片
- 部分资源提供 PDF 整本下载
- 支持通过 IIIF Manifest 在 Mirador 或 Universal Viewer 中查看
- 全文检索的文献可高亮显示匹配位置

## 示例

由于中文古籍在该馆数字化比例有限，以下给出馆藏通用示例：

- 搜索中文资源：https://onb.digital/search （搜索后在语言筛选中选择"Chinesisch"）
- IIIF Manifest 示例（ABO 项目图书）：https://iiif.onb.ac.at/presentation/ABO/+Z165851607/manifest
- IIIF Manifest 示例（REPO 项目）：https://iiif.onb.ac.at/presentation/REPO/7445056/manifest
- Mirador 查看器：https://iiif.onb.ac.at/view/manifest/mirador/ABO/+Z165851607
- Universal Viewer：https://iiif.onb.ac.at/view/manifest/universalviewer/ABO/+Z165851607

---

# 开发者文档

## URL 结构

### 新版搜索平台
```
https://onb.digital/search?searchTerm={keyword}&from={offset}&to={limit}
```
- `searchTerm`：搜索关键词
- `from` / `to`：分页参数

### 旧版阅览器（已重定向）
```
https://digital.onb.ac.at/OnbViewer/viewer.faces?doc=ABO_%2B{barcode}
```
- `%2B` 为 `+` 的 URL 编码
- `barcode`：数字对象的条码标识（如 `Z175775609`）

### 新版阅览器
```
https://viewer.onb.ac.at/viewer/!ABO_%2B{barcode}
```

### IIIF Manifest
```
https://iiif.onb.ac.at/presentation/{projectName}/{id}/manifest
```
- `projectName`：数字化项目名，常见值：
  - `ABO` — Austrian Books Online（书籍）
  - `ANNO` — Austrian Newspapers Online（报纸）
  - `AKON` — Austrian Postcards Online（明信片）
  - `REPO` — 其他数字化对象
- `id`：对象标识符。ABO 项目格式为 `+Z{barcode}`（注意 `+` 需 URL 编码为 `%2B`）

### IIIF Image API
```
https://iiif.onb.ac.at/images/{projectName}/{id}/{imageID}/{region}/{size}/{rotation}/{quality}.{format}
```
- `imageID`：8 位数字的图片标识
- 其余参数遵循 IIIF Image API 2.0 规范

### IIIF Image Info
```
https://iiif.onb.ac.at/images/{projectName}/{id}/{imageID}/info.json
```

### METS 元数据
```
https://iiif.onb.ac.at/mets/{barcode}
```
返回 XML 格式的 METS 结构化元数据。

### MODS 元数据
```
https://iiif.onb.ac.at/mods/{barcode}
```
返回 XML 格式的 MODS 书目元数据。

## 搜索 API

搜索平台 `onb.digital` 是 SPA 应用，后端 API 待确认。但可通过 IIIF 的 Collection API 进行程序化搜索。

### IIIF Collection 创建（搜索功能）
```
POST https://iiif.onb.ac.at/presentation/collection
Content-Type: application/json

{
  "name": "my_collection",
  "description": "search results",
  "searchLimitFrom": 0,
  "searchLimitTo": 50,
  "query": {
    "fulltext": "关键词",
    "person": "作者",
    "title": "题名",
    "language": "chi",
    "yearOfPublication": "1780"
  }
}
```

支持的 Lucene 查询字段：
- `fulltext` — 全文
- `title` — 题名
- `person` — 著者
- `language` — 语言代码
- `yearOfPublication` — 出版年
- `place` — 出版地
- `barcode` — 条码
- `idnr` — 目录编号
- `localSignature` — 馆藏编号
- `pagecount` — 页数
- `country` — 国家

### 获取 Collection
```
GET https://iiif.onb.ac.at/presentation/collection/{collectionName}
Accept: application/json
```

## 元数据获取

### 方式一：IIIF Manifest（推荐）

从 IIIF Manifest 获取元数据是最标准的方式。

```
GET https://iiif.onb.ac.at/presentation/ABO/{id}/manifest
Accept: application/json
```

Manifest 遵循 IIIF Presentation API 2.1 规范，包含 `label`、`metadata`、`sequences`、`canvases` 等字段。

### 方式二：METS/MODS XML

```
GET https://iiif.onb.ac.at/mets/{barcode}
GET https://iiif.onb.ac.at/mods/{barcode}
```

返回结构化的 XML 元数据，字段更丰富。

### 方式三：旧版 OnbViewer API

```
GET https://digital.onb.ac.at/OnbViewer/service/viewer/imageData?doc={bookId}&from=1&to=3000
```
返回 JSON，包含图片元数据列表。此接口被 bookget 使用，但旧版阅览器已重定向，此接口可用性待确认。

### 字段映射

| 中文字段 | IIIF Manifest 路径 | MODS XML 路径 |
|---------|-------------------|---------------|
| 题名 | `label` 或 `metadata[?label="Title"].value` | `//mods:titleInfo/mods:title` |
| 著者 | `metadata[?label="Author"].value` | `//mods:name/mods:namePart` |
| 年代 | `metadata[?label="Date"].value` | `//mods:originInfo/mods:dateIssued` |
| 出版地 | `metadata[?label="Place"].value` | `//mods:originInfo/mods:place` |
| 语言 | `metadata[?label="Language"].value` | `//mods:language/mods:languageTerm` |
| 馆藏编号 | `metadata[?label="Shelfmark"].value` | `//mods:location/mods:shelfLocator` |

## 下载

### 方式一：IIIF（推荐）

ONB 完整实现了 IIIF Image API 和 IIIF Presentation API，这是获取图片的首选方式。

**获取流程：**

1. 获取 IIIF Manifest：
   ```
   GET https://iiif.onb.ac.at/presentation/{projectName}/{id}/manifest
   ```

2. 从 Manifest 的 `sequences[0].canvases` 中提取每页的 canvas

3. 每个 canvas 的 `images[0].resource.service.@id` 即为 IIIF Image Service 地址

4. 拼接完整图片 URL：
   ```
   {service_id}/full/max/0/default.jpg
   ```
   或指定宽度：
   ```
   {service_id}/full/{width},/0/default.jpg
   ```

**Image Info 示例：**
```
GET https://iiif.onb.ac.at/images/{projectName}/{id}/{imageID}/info.json
```

**注意事项：**
- 不建议发送大量并发请求或短时间内密集请求（官方文档明确声明）
- Accept 头可设为 `application/json` 或 `application/ld+json`

### 方式二：bookget 工具

bookget 通过旧版 OnbViewer 的私有 API 下载图片。

- 源码：[onbdigital.go](https://github.com/deweizhu/bookget/blob/main/app/onbdigital.go)
- 输入 URL 格式：`https://digital.onb.ac.at/OnbViewer/viewer.faces?doc=ABO_%2B{barcode}`

**关键逻辑：**
1. 通过正则 `doc=([^&]+)` 从 URL 提取文档 ID
2. 请求图片元数据 API：
   ```
   GET https://{host}/OnbViewer/service/viewer/imageData?doc={bookId}&from=1&to=3000
   ```
3. 解析 JSON 响应，构建图片下载 URL：
   ```
   https://{host}/OnbViewer/image?{queryArgs}&w=2400&q=70
   ```
   - `w=2400`：图片宽度 2400 像素
   - `q=70`：JPEG 质量 70%
4. 使用 Cookie Jar 维持会话状态
5. 支持自定义 User-Agent 和 Cookie 文件

**注意：** 旧版 OnbViewer 已经进行了重定向（301 到 viewer.onb.ac.at），bookget 的这一接口可能需要更新。建议优先使用 IIIF 方式。

### 方式三：IIIF 查看器直接访问

ONB 提供在线 IIIF 查看器，可通过以下 URL 直接在浏览器中查看：
- Mirador：`https://iiif.onb.ac.at/view/manifest/mirador/{projectName}/{id}`
- Mirador 3：`https://iiif.onb.ac.at/view/manifest/mirador3/{projectName}/{id}`
- Universal Viewer：`https://iiif.onb.ac.at/view/manifest/universalviewer/{projectName}/{id}`

### 图片保护

- 无水印（公共领域资源）
- 无 Referer 校验
- 无需认证（公开资源）
- 官方明确要求不要大量并发下载
