# 国書データベース（国書數據庫）

<!--
  本文件分两部分：
  - 分割线以上：用户文档，面向普通用户，语言简洁易懂，不含技术细节
  - 分割线以下：开发者文档，面向程序员，包含 API、HTML 解析、下载逻辑等技术细节
-->

国书数据库（Database of Pre-Modern Japanese Works / Union Catalogue Database of Japanese Texts）是日本国文学研究资料馆（NIJL）运营的古典籍综合数据库。2023 年 3 月由原「日本古典籍総合目録データベース」和「新日本古典籍総合データベース」整合而成，收录了日本近代以前著述的书籍的书志信息与图像。

- 网站链接：https://kokusho.nijl.ac.jp/
- 英文界面：https://kokusho.nijl.ac.jp/?ln=en
- 分享协议：NIJL 所藏资料以 [CC BY-SA 4.0](https://creativecommons.org/licenses/by-sa/4.0/) 提供；其他机构所藏资料的许可条件因资料而异（Public Domain / CC 各版本 / Rights Statements / 保留所有权利），具体见各资料详情页
- 约 160 万条书志/所在信息，其中约 30 万件附有原本图像
- 资源类型：日本近代以前的写本、刊本（含部分明治以后日本书籍和汉籍）
- 支持 IIIF 协议（Presentation API 2.0），可使用 [bookget](https://github.com/deweizhu/bookget) 等工具下载
- 联系邮箱：kokusho@nijl.ac.jp

## 搜索与浏览

- 首页搜索：https://kokusho.nijl.ac.jp/
- 无需注册登录，免费使用

数据库提供 6 种搜索方式：

1. **简单搜索**：在首页搜索框输入关键词，选择搜索范围为「书志」「著作」或「著者」
2. **书志详细搜索**：可按题名、著者、出版/书写年代、请求记号、分类等字段组合检索；支持部分一致、完全一致、前方一致、后方一致等匹配方式
3. **著作详细搜索**：检索著作典据数据（统一题名级别），支持分面筛选
4. **著者详细搜索**：检索著者典据记录，包括别名
5. **图像标签搜索**：检索已标注的图像标签（仅限部分资料）
6. **全文搜索**：检索已翻刻的现代字文本（仅限部分资料），结果中高亮显示匹配片段

搜索结果支持分面（facet）筛选，可按所藏机构、分类、年代等维度收窄。

## 每本书能看到什么

数据库有三个层级：**书志**（个别资料）、**著作**（作品级别）、**著者**（人物级别）。用户点击搜索结果进入书志详情页，可看到以下字段：

| 字段 | 说明 | 示例 |
|------|------|------|
| 書誌ID | 数据库中的唯一编号 | 200013882 |
| 統一書名 | 代表性书名 | 伊勢物語 |
| 記載書名 | 资料上实际记载的书名 | 清讀／松之調 |
| 記載著者 | 资料上记载的著者名及角色 | 佐々木 |
| 巻数 | 卷册数量 | 1巻 |
| 制作手段 | 刊（刻本）/ 写（写本）/ 混（混合） | 写 |
| 書写事項 | 抄写者、抄写年代 | — |
| 出版事項 | 出版者、出版年代 | — |
| 形態 | 页数、尺寸、纸质 | — |
| 所蔵 | 所藏机构名称、文库名、请求记号 | 国文学研究資料館 |
| 分類 | 分类类目 | — |
| DOI | 持久标识符 | https://doi.org/10.20730/200013882 |
| 外部链接 | CiNii Books、人文学オープンデータ共同利用センター等 | — |

- 有图像的资料：详情页内嵌 Mirador 3 阅读器，支持缩放、翻页、缩略图导航、颜色/方向调整、全屏模式
- 可逐页下载图像：点击阅读器右上角三点菜单，选择下载按钮，选择分辨率后在新标签页打开保存
- 阅读器下方显示 IIIF Manifest URL，可复制到其他 IIIF 兼容阅读器中使用
- 部分资料有全文翻刻文字

引用格式示例：
> 『伊勢物語』（国文学研究資料館所蔵）出典：国書データベース，https://doi.org/10.20730/200013710

## 示例

- 书志详情页：https://kokusho.nijl.ac.jp/biblio/200013882
- 著作详情页：https://kokusho.nijl.ac.jp/work/450000
- 在线阅读（Mirador 阅读器）：https://kokusho.nijl.ac.jp/app/mirador/200013882/1/1?ln=ja
- IIIF Manifest：https://kokusho.nijl.ac.jp/biblio/200013882/manifest

---

# 开发者文档

## URL 结构

### 书志详情页
```
https://kokusho.nijl.ac.jp/biblio/{biblio_id}
```
- `biblio_id`：书志 ID，纯数字，如 `200013882`

### 著作详情页
```
https://kokusho.nijl.ac.jp/work/{work_id}
```

### 著者详情页
```
https://kokusho.nijl.ac.jp/author/{author_id}
```

### Mirador 阅读页面
```
https://kokusho.nijl.ac.jp/app/mirador/{biblio_id}/{volume}/{page}?ln=ja
```
- `volume`：卷号（从 1 开始）
- `page`：页号（从 1 开始）

有时阅读器加载的是外部 IIIF Manifest（如国立国会图书馆的资料）：
```
https://kokusho.nijl.ac.jp/app/mirador/{biblio_id}/1/1?ln=en&manifest=https://www.dl.ndl.go.jp/api/iiif/{ndl_id}/manifest.json
```

### IIIF Manifest
```
https://kokusho.nijl.ac.jp/biblio/{biblio_id}/manifest
```
返回 IIIF Presentation API 2.0 格式的 JSON。

### IIIF Image API
```
https://kokusho.nijl.ac.jp/api/iiif/{biblio_id}/v4/{collection}/{item_prefix}/{item_prefix}-{page_num}.tif/{region}/{size}/{rotation}/{quality}.{format}
```
示例（完整尺寸 JPG）：
```
https://kokusho.nijl.ac.jp/api/iiif/200013882/v4/NIIP/054-0228/054-0228-00001.tif/full/full/0/default.jpg
```

## 搜索 API

网站是 SPA 单页应用，搜索通过后端 API 实现。根据 bookget 源码，已知的 API 端点如下：

### 书志详情 API
```
GET https://kokusho.nijl.ac.jp/api/biblioDetail/{biblio_id}?t={timestamp}
```
- `biblio_id`：书志 ID
- `t`：时间戳（Unix 毫秒，用于绕过缓存）
- 返回 JSON，包含 `manifest` 字段指向 IIIF Manifest URL

其他搜索 API 端点未公开文档化。可通过浏览器开发者工具（Network 面板）抓包获取实际请求。由于是 SPA，WebFetch 无法直接抓取页面渲染内容。

## 元数据获取

### 方式一：通过 IIIF Manifest 获取基础元数据

请求 `https://kokusho.nijl.ac.jp/biblio/{biblio_id}/manifest` 获取 IIIF Manifest JSON。

Manifest 结构（Presentation API 2.0）：

```json
{
  "@context": "http://iiif.io/api/presentation/2/context.json",
  "@id": "https://kokusho.nijl.ac.jp/biblio/200013882/manifest",
  "@type": "sc:Manifest",
  "label": "清讀／松之調",
  "metadata": [
    { "label": "Author", "value": "佐々木" },
    { "label": "Title", "value": "清讀／松之調" },
    { "label": "DOI", "value": "10.20730/200013882" }
  ],
  "attribution": "国文学研究資料館",
  "license": "https://creativecommons.org/publicdomain/mark/1.0/",
  "viewingDirection": "right-to-left",
  "viewingHint": "individuals",
  "sequences": [{
    "@type": "sc:Sequence",
    "canvases": [{
      "label": "1",
      "width": 5616,
      "height": 3744,
      "images": [{
        "resource": {
          "service": {
            "@id": "https://kokusho.nijl.ac.jp/api/iiif/200013882/v4/NIIP/054-0228/054-0228-00001.tif"
          }
        }
      }]
    }]
  }]
}
```

### 方式二：通过 biblioDetail API 获取

```
GET https://kokusho.nijl.ac.jp/api/biblioDetail/{biblio_id}?t={timestamp}
```
返回的 JSON 包含完整的书志元数据和 manifest URL。具体 JSON 结构待确认（需浏览器抓包）。

### 字段映射

| 中文字段 | IIIF Manifest 路径 |
|---------|-------------------|
| 题名 | `label` 或 `metadata[?label="Title"].value` |
| 著者 | `metadata[?label="Author"].value` |
| DOI | `metadata[?label="DOI"].value` |
| 许可协议 | `license` |
| 所藏机构 | `attribution` |
| 阅读方向 | `viewingDirection`（`right-to-left` = 日本传统从右到左） |
| 图像数量 | `sequences[0].canvases.length` |

注意：IIIF Manifest 中的元数据字段相对有限（通常只有 Title、Author、DOI），完整的书志信息（出版事项、形态、分类等）需要通过 biblioDetail API 获取。

## 下载

### IIIF 方式（推荐）

1. 获取 Manifest：`GET https://kokusho.nijl.ac.jp/biblio/{biblio_id}/manifest`
2. 解析 `sequences[0].canvases[]`，提取每个 canvas 的图像服务 ID：
   ```
   canvases[i].images[0].resource.service.@id
   ```
3. 拼接图像 URL：
   ```
   {service_id}/full/full/0/default.jpg    # 原始尺寸
   {service_id}/full/1024,/0/default.jpg   # 宽度 1024px
   {service_id}/full/,800/0/default.jpg    # 高度 800px
   ```

### bookget 支持

bookget 已支持此网站，相关源码：
- https://github.com/deweizhu/bookget/blob/main/app/kokusho.go

关键逻辑：
1. 从 URL 中提取 `biblio_id`（正则：`biblio/([A-Za-z0-9_-]+)`）
2. 调用 `https://kokusho.nijl.ac.jp/api/biblioDetail/{biblio_id}?t={timestamp}` 获取 manifest URL
3. 请求 manifest，解析 canvases 获取 Image Service ID
4. 两种下载模式：
   - **普通模式**：直接拼接 `{service_id}/full/full/0/default.jpg` 下载
   - **DZI 模式**：请求 `{service_id}/info.json`，通过 dezoomify-rs 下载高分辨率拼接图像
5. 多卷资料自动创建 `0001`-`NNNN` 子目录
6. 需要的 HTTP 请求头：
   - `User-Agent`：自定义
   - `Referer`：URL 编码后的来源页面
   - DZI 模式额外需要 `Origin` 头

使用方法：
```bash
bookget https://kokusho.nijl.ac.jp/biblio/200013882
```

### 注意事项

- 部分资料的 IIIF Manifest 实际指向外部机构（如国立国会图书馆 `www.dl.ndl.go.jp`），此时图像需从对应机构的 IIIF 服务下载
- 不同资料的许可协议不同，下载前请确认详情页显示的使用条件
- 图像分辨率较高（示例为 5616x3744），注意存储空间
- 网站使用 Google Analytics 和 Matomo 分析，大量自动化请求可能触发限制
