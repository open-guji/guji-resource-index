# 柏林国立图书馆（Staatsbibliothek zu Berlin）

<!--
  本文件分两部分：
  - 分割线以上：用户文档，面向普通用户，语言简洁易懂，不含技术细节
  - 分割线以下：开发者文档，面向程序员，包含 API、HTML 解析、下载逻辑等技术细节
-->

德国柏林国立图书馆（全称 Staatsbibliothek zu Berlin -- Preussischer Kulturbesitz），隶属于普鲁士文化遗产基金会，是德国最大的综合性图书馆。其东亚部自 17 世纪起系统收集中文典籍，目前已数字化约 1,937 种中文古籍（含善本、手稿），是欧洲最重要的中文古籍数字化馆藏之一。2024 年与台湾中央研究院合作完成了 OCR 全文识别，超过 1.21 亿汉字可全文检索。

- 网站链接：https://digital.staatsbibliothek-berlin.de/
- 分享协议：1920 年前出版物采用 [Public Domain Mark 1.0](https://creativecommons.org/publicdomain/mark/1.0/)；1920 年后出版物可能采用其他协议
- 约 1,937 种中文古籍（Sinica 分类），另有 977 种中医手稿（Unschuld Collection，已数字化 603 种）
- 资源类型：善本（刻本、活字本）、手稿、地图、铜版画
- 支持 IIIF 协议，可使用 [bookget](https://github.com/deweizhu/bookget) 等工具下载

## 搜索与浏览

- 中文古籍搜索页面：https://digital.staatsbibliothek-berlin.de/suche?category=Sinica
- 全部数字馆藏搜索页面：https://digital.staatsbibliothek-berlin.de/suche
- 在搜索框输入中文关键词即可搜索（支持繁体中文），多字词需用引号括起，如 `"周易"`
- 可按分类（category）筛选：`Sinica`（中文典籍）、`Ostasiatica`（东亚文献）等
- 另有 [CrossAsia 全文检索](http://sbb.berlin/e6gqn) 可搜索 OCR 全文，支持中文汉字、日文汉字、韩文汉字，无需引号
- 无需注册登录即可浏览和下载

### 特色馆藏

- **早期中文收藏（Libri sinici）**：17 世纪起收集的中文刻本与手稿，馆藏号以 `Libri sin.` 开头
- **Unschuld 中医手稿收藏**：977 种 16-20 世纪中医手稿，详见 [Chinese Medical Manuscripts](https://themen.crossasia.org/chinese-medical-manuscripts/?lang=en)
- **柏林蒙古地图**：181 幅清末蒙古手绘地图
- **战争铜版画**：乾隆帝军事战役铜版画 5 套共 64 幅

## 每本书能看到什么

| 字段 | 说明 | 示例 |
|------|------|------|
| 题名 | 书名（中文原题及拉丁转写） | 己卯年四季條例 [乾隆24年 (=1759)] |
| 替代题名 | 简化题名或拉丁转写 | 四季条例 / KI-TIAO-LI |
| 馆藏号 | 馆内索书号 | Libri sin. 496-4 |
| 物理描述 | 装帧、尺寸、行数 | 綫裝 1冊, 23 cm, 版框 19.6 x 11.6 cm, 8行 |
| 出版年代 | 出版年份 | 1830 |
| 语言 | 文本语种 | 中文 (zh) |
| 数字化日期 | 扫描完成年份 | 2013 |
| 分类 | 所属馆藏分类 | Historische Drucke, Ostasiatica, Sinica |
| PURL | 永久链接 | http://resolver.staatsbibliothek-berlin.de/SBB0000D06B00000000 |

- 可在线逐页翻阅高清扫描图片
- 有 OCR 全文的典籍可点击 "Full text" 图标查看逐页文字
- 可直接下载单页图片（JPG/PNG/TIFF），也可通过 IIIF 获取
- 支持 [Hypothes.is](https://hypothes.is/) 标注功能，可协助改进 OCR 质量

## 示例

- 详情页（己卯年四季條例）：https://digital.staatsbibliothek-berlin.de/werkansicht?PPN=PPN3343671770
- 中文古籍分类浏览：https://digital.staatsbibliothek-berlin.de/suche?category=Sinica
- PURL 永久链接示例：http://resolver.staatsbibliothek-berlin.de/SBB0000D06B00000000

---

# 开发者文档

## URL 结构

### 详情页（阅读器页面）
```
https://digital.staatsbibliothek-berlin.de/werkansicht?PPN={PPN_ID}
```
- `PPN`：Pica Production Number，每件数字化作品的唯一标识符，如 `PPN3343671770`
- 可附加 `&PHYSID=PHYS_0001` 跳转到指定页面
- 可附加 `&lang=en` 切换英文界面

### 搜索页面
```
https://digital.staatsbibliothek-berlin.de/suche?category=Sinica
https://digital.staatsbibliothek-berlin.de/suche?queryString=aut:李壯
```
- `category`：按馆藏分类筛选（`Sinica`、`Ostasiatica` 等）
- `queryString`：搜索表达式，支持字段前缀如 `aut:` (作者)

### PURL 永久链接
```
http://resolver.staatsbibliothek-berlin.de/{RESOLVER_ID}
```
- `RESOLVER_ID` 格式如 `SBB0000D06B00000000`，会重定向到实际详情页

### IIIF Manifest
```
https://content.staatsbibliothek-berlin.de/dc/{PPN_ID}/manifest
```
- 返回 IIIF Presentation API manifest JSON
- 示例：`https://content.staatsbibliothek-berlin.de/dc/PPN3343671770/manifest`

### IIIF 图片 URL
```
https://content.staatsbibliothek-berlin.de/dc/{PPN_ID}-{PAGE_ID}/{region}/{size}/{rotation}/default.{format}
```
- `PPN_ID`：作品 PPN 编号
- `PAGE_ID`：8 位数字页码，如 `00000001`
- `region`：裁剪区域，`full` 为全图，或 `x,y,w,h` 坐标
- `size`：尺寸，`full` 或 `max` 为原始大小，`1200,` 为宽 1200 像素等比缩放
- `rotation`：旋转角度，通常为 `0`
- `format`：`jpg`、`png`、`tif`

示例：
```
# 全尺寸 JPG
https://content.staatsbibliothek-berlin.de/dc/PPN3343671770-00000001/full/max/0/default.jpg
# 宽 1200px 缩略图
https://content.staatsbibliothek-berlin.de/dc/PPN3343671770-00000001/full/1200,/0/default.jpg
# 缩略图 PNG（150px 宽）
https://content.staatsbibliothek-berlin.de/dc/PPN3343671770-00000001/full/150,/0/default.png
# 原始 TIFF
https://content.staatsbibliothek-berlin.de/dc/PPN3343671770-00000001/full/full/0/default.tif
```

## 搜索 API

### OAI-PMH 接口

SBB 通过 OAI-PMH 协议提供元数据批量检索。

**端点**：`https://oai.sbb.berlin/`（新）或 `http://digital.staatsbibliothek-berlin.de/oai`（旧）

**常用请求**：
```
# 列出支持的元数据格式
https://oai.sbb.berlin/?verb=ListMetadataFormats

# 列出所有集合（分类）
https://oai.sbb.berlin/?verb=ListSets

# 获取中文古籍列表（如有 Sinica set）
https://oai.sbb.berlin/?verb=ListIdentifiers&metadataPrefix=oai_dc&set=sinica

# 获取全部数字化资源列表
https://oai.sbb.berlin/?verb=ListIdentifiers&metadataPrefix=mets&set=all

# 获取单条记录（Dublin Core）
https://oai.sbb.berlin/?verb=GetRecord&metadataPrefix=oai_dc&identifier=oai:digital.staatsbibliothek-berlin.de:PPN3343671770

# 获取单条记录（METS）
https://oai.sbb.berlin/?verb=GetRecord&metadataPrefix=mets&identifier=oai:digital.staatsbibliothek-berlin.de:PPN3343671770
```

- 支持 `oai_dc`（Dublin Core）和 `mets`（METS/MODS）两种元数据格式
- 分页通过 resumptionToken 实现，每页约 10 条记录
- 无需认证

### 页面搜索

数字门户使用 Meteor 框架构建（SPA 单页应用），搜索结果通过客户端 JavaScript 渲染。直接抓取 HTML 无法获取内容，需使用 OAI-PMH 或 METS API 获取元数据。

## 元数据获取

### METS/MODS XML

```
https://content.staatsbibliothek-berlin.de/dc/{PPN_ID}.mets.xml
```
- 返回完整的 METS/MODS 格式元数据
- 示例：`https://content.staatsbibliothek-berlin.de/dc/PPN3343671770.mets.xml`

### 字段映射

| 中文字段 | METS/MODS XPath |
|---------|-----------------|
| 题名 | `//mods:titleInfo/mods:title` |
| 替代题名 | `//mods:titleInfo[@type='alternative']/mods:title` |
| 馆藏号 | `//mods:location/mods:shelfLocator` |
| 物理描述 | `//mods:physicalDescription/mods:extent` |
| 出版年代 | `//mods:originInfo/mods:dateIssued[@encoding='w3cdtf']` |
| 语言 | `//mods:language/mods:languageTerm[@type='code']` |
| 数字 PPN | `//mods:recordInfo/mods:recordIdentifier[@source='gbv-ppn']` |
| PURL | `//mods:identifier[@type='purl']` |
| 分类 | `//mods:classification[@authority='zvdd']` |
| 物理位置 | `//mods:location/mods:physicalLocation` |
| 数字化日期 | `//mods:originInfo[@eventType='digitization']/mods:dateCaptured` |
| 许可证 | `//mods:accessCondition` |

### METS fileSec 结构

METS 文件中 `<fileSec>` 包含三个 `<fileGrp>`：

| fileGrp USE | 格式 | URL 模式 | 说明 |
|-------------|------|---------|------|
| PRESENTATION | TIFF | `file:///goobi/tiff001/sbb/{PPN}/{seq}.tif` | 内部存储路径，不可外部访问 |
| THUMBS | PNG | `https://content.staatsbibliothek-berlin.de/dc/{PPN}-{seq}/full/150,/0/default.png` | 150px 宽缩略图 |
| DEFAULT | JPG | `https://content.staatsbibliothek-berlin.de/dc/{PPN}-{seq}/full/max/0/default.jpg` | 全尺寸 JPG |

## 下载

### IIIF 下载

SBB 完整支持 IIIF Image API 和 Presentation API。

**下载流程**：
1. 从详情页 URL 提取 PPN（正则 `PPN=([A-Za-z0-9_-]+)`）
2. 请求 IIIF Manifest：`https://content.staatsbibliothek-berlin.de/dc/{PPN}/manifest`
3. 解析 manifest 中的 canvases，获取每页的 image resource URL
4. 每个 image resource URL 格式为 `https://content.staatsbibliothek-berlin.de/dc/{PPN}-{PAGE}/full/max/0/default.jpg`
5. 可替换 `max` 为具体宽度（如 `1200,`），替换 `jpg` 为 `png` 或 `tif`

**直接构造图片 URL**（无需解析 manifest）：
```
# 从 METS 获取总页数后，按序号构造
https://content.staatsbibliothek-berlin.de/dc/{PPN}-{PAGE_SEQ}/full/max/0/default.jpg
```
- PAGE_SEQ 为 8 位零填充数字，从 00000001 开始

### bookget 支持

bookget 已内置支持，源码：[berlin.go](https://github.com/deweizhu/bookget/blob/main/app/berlin.go)

**使用方式**：
```bash
bookget https://digital.staatsbibliothek-berlin.de/werkansicht?PPN=PPN3343671770
```

**关键实现细节**（berlin.go）：
- PPN 提取正则：`PPN=([A-z0-9_-]+)`
- Manifest URL：`https://content.staatsbibliothek-berlin.de/dc/{PPN}/manifest`
- 使用 IIIF + DZI (Deep Zoom Image) 混合下载
- 图片元数据查询：`https://content.staatsbibliothek-berlin.de/?action=metsImage&metsFile={PPN}&divID=PHYS_{pageId}&dzi=true`
- 支持自定义 Cookie、User-Agent、Referer 请求头
- 禁用 SSL 证书验证
- 支持并发下载和断点续传

### OCR 数据

```
# 单页 ALTO XML
https://content.staatsbibliothek-berlin.de/dc/{PPN}-{PAGE_SEQ}.ocr.xml

# 全文 OCR 打包下载（ZIP）
https://content.staatsbibliothek-berlin.de/dc/{PPN}.ocr.zip
```

### 认证与限制

- 无需登录或认证即可下载图片和元数据
- 无已知速率限制（但建议合理控制并发）
- 无水印
- 无 Referer 校验（bookget 代码中仍设置 Origin/Referer 以防万一）
- 1920 年前出版物为公共领域，可自由使用
