# 香港中文大学图书馆 - 中国古籍库

香港中文大学图书馆数码典藏（CUHK Digital Repository）中的"中国古籍库"，自2006年起对馆藏善本古籍进行数字化，是香港地区规模最大的中文古籍数字化馆藏之一。已注册于 OpenDOAR、ROAR、OCLC WorldCat OAIster 等开放获取平台。

- 网站链接：https://repository.lib.cuhk.edu.hk/sc/collection/chi-rarebook
- 分享协议：[CC BY-NC-ND 4.0](https://creativecommons.org/licenses/by-nc-nd/4.0/)（允许非商业使用，禁止演绎）
- 约 1,100 部善本古籍、6,000+ 部普通古籍，合计近百万页全文影像
- 资源类型：善本（元至清乾隆年间刊本）、普通古籍、线装书
- 不支持 IIIF 协议（网站内部使用 IIIF 提供图片，但无公开 manifest）
- 支持 [bookget](https://github.com/deweizhu/bookget) 下载（需通过浏览器绕过 AWS WAF 验证）

## 搜索与浏览

- 古籍库浏览页面：https://repository.lib.cuhk.edu.hk/sc/collection/chi-rarebook
- 全站搜索：在页面顶部搜索框输入关键词即可搜索，支持中英文
- 也可通过 Islandora 搜索路径搜索：https://repository.lib.cuhk.edu.hk/sc/islandora/search/
- 搜索结果可按以下维度筛选：题名、著者、主题、年代、语种
- 支持按典藏分类浏览：中国古籍库、珍贵资料数字化、中医药典籍、岭南文库等
- 无需注册登录，所有内容开放获取

## 每本书能看到什么

| 字段 | 说明 | 示例 |
|------|------|------|
| Title / 題名 | 书名（中英文） | 周易: 八卷, 卷首, 卷末 |
| Creator / 著者 | 作者/编者 | （待确认） |
| Date / 日期 | 出版年代 | （待确认） |
| Publisher / 出版者 | 出版者/刻印者 | （待确认） |
| Extent / 形態 | 册数/卷数 | （待确认） |
| Subject / 主題 | 主题分类 | （待确认） |
| Language / 語言 | 语种 | Chinese |
| Identifier / 識別號 | 馆藏编号 | cuhk-793592 |

每本书提供在线翻阅功能（Internet Archive BookReader 或 IIIF 查看器），可逐页浏览影像。平台基于 Islandora（Drupal + Fedora），使用 MODS 元数据标准。

## 示例

- 详情页（新URL格式）：https://repository.lib.cuhk.edu.hk/en/item/cuhk-793592
- 详情页（旧URL格式）：https://repository.lib.cuhk.edu.hk/sc/islandora/object/cuhk%3A3270169
- 在线阅读：https://repository.lib.cuhk.edu.hk/sc/item/cuhk-412225#page/1/mode/2up
- 古籍库列表：https://repository.lib.cuhk.edu.hk/collection/cuhk-rarebook?display=list

---

# 开发者文档

## URL 结构

### 详情页（新格式）
```
https://repository.lib.cuhk.edu.hk/{lang}/item/cuhk-{id}
```
- `lang`：语言代码，`en`（英文）、`sc`（简体中文）、`tc`（繁体中文）
- `id`：数字标识符，如 `793592`、`412225`、`1166074`

### 详情页（旧格式，Islandora 原生）
```
https://repository.lib.cuhk.edu.hk/{lang}/islandora/object/cuhk%3A{id}
```
- PID 格式为 `cuhk:{id}`，URL 中冒号编码为 `%3A`

### 元数据页面
```
https://repository.lib.cuhk.edu.hk/{lang}/islandora/object/cuhk%3A{id}/metadata
```

### 阅读页面
```
https://repository.lib.cuhk.edu.hk/{lang}/item/cuhk-{id}#page/{page_num}/mode/2up
```
- `page_num`：页码（从1开始）
- `mode`：显示模式，`2up`（双页）、`1up`（单页）

### IIIF 图片（内部使用）
```
https://repository.lib.cuhk.edu.hk/iiif/2/{identifier}/{region}/{size}/{rotation}/{quality}.{format}
```
- 遵循 IIIF Image API 2.0 规范
- `identifier`：图片标识符（URL 编码的 PID）

### 典藏集合
```
https://repository.lib.cuhk.edu.hk/{lang}/collection/chi-rarebook          # 中国古籍库
https://repository.lib.cuhk.edu.hk/{lang}/collection/cuhk-rarebook/precious  # 珍贵资料
https://repository.lib.cuhk.edu.hk/{lang}/collection/chimed                 # 中医药典籍
https://repository.lib.cuhk.edu.hk/{lang}/collection/lingnan-book           # 岭南文库
```

## 搜索 API

平台基于 Islandora（Drupal + Fedora + Solr），搜索使用 Solr 索引。

### Islandora 搜索
```
https://repository.lib.cuhk.edu.hk/{lang}/islandora/search/{query}
```
- 支持 MODS 字段限定搜索，如：
  - `mods_name_personal_namePart_merge_ms:"杨洁."` — 按著者搜索

### OAI-PMH（待确认）
```
https://repository.lib.cuhk.edu.hk/oai2?verb=ListRecords&metadataPrefix=oai_dc&set=chi-rarebook
```
- 标准 OAI-PMH 端点，但目前可能被 WAF 拦截

## 元数据获取

### 平台架构

网站使用 **Islandora**（Drupal + Fedora Commons）构建：
- 元数据标准：**MODS**（Metadata Object Description Schema）
- 搜索引擎：Solr
- 数据存储：Fedora Commons
- 前端框架：Drupal 7（旧版 Islandora）

### AWS WAF 保护

**注意**：网站部署了 AWS WAF（Web Application Firewall），所有页面和 API 端点都需要先通过 JavaScript 验证才能访问。
- 检测特征：响应中包含 `window.awsWafCookieDomainList` 和 `AwsWafIntegration`
- 普通 HTTP 请求（curl 等）会被拦截，返回 403 或 WAF 验证页面
- 需要通过浏览器完成 WAF 验证后，使用获得的 Cookie 访问

### 字段映射

基于 MODS 标准和 Islandora Solr 索引：

| 中文字段 | Solr 字段（推测） | MODS 路径 |
|---------|------------------|-----------|
| 题名 | `mods_titleInfo_title_ms` | `mods:titleInfo/mods:title` |
| 著者 | `mods_name_personal_namePart_merge_ms` | `mods:name[@type='personal']/mods:namePart` |
| 日期 | `mods_originInfo_dateIssued_ms` | `mods:originInfo/mods:dateIssued` |
| 出版者 | `mods_originInfo_publisher_ms` | `mods:originInfo/mods:publisher` |
| 形态 | `mods_physicalDescription_extent_ms` | `mods:physicalDescription/mods:extent` |
| 主题 | `mods_subject_topic_ms` | `mods:subject/mods:topic` |
| 语种 | `mods_language_languageTerm_ms` | `mods:language/mods:languageTerm` |
| 识别号 | `mods_identifier_local_ms` | `mods:identifier[@type='local']` |
| 资源类型 | `mods_typeOfResource_ms` | `mods:typeOfResource` |

**注意**：由于 AWS WAF 保护，无法直接抓取页面验证以上字段。Solr 字段名为基于 Islandora 标准配置的推测值。

## 下载

### IIIF（内部使用）

网站内部使用 IIIF Image API 2.0 提供图片服务，但不提供公开的 IIIF Manifest。

图片 URL 格式：
```
https://repository.lib.cuhk.edu.hk/iiif/2/{identifier}/full/full/0/default.jpg
```

### bookget 支持

bookget 通过 `app/cuhk.go` 支持此网站。

**关键逻辑**：
1. 提取 Book ID：从 URL 中通过正则 `/item/([^#/]+)` 或 `/object/([^#/]+)` 提取标识符
2. 语言转换：将中文URL中的 `hk/sc/` 替换为 `hk/en/`
3. WAF 处理：使用 GUI 浏览器组件（bookget-gui）通过共享内存完成 WAF 验证
4. Canvas 提取：从页面响应中解析 JSON 获取图片标识符列表
5. 图片下载：构建 IIIF URL `https://{host}/iiif/2/{identifier}/{format}` 下载每页图片

**注意**：由于 AWS WAF 保护，必须使用 bookget-gui（浏览器组件）才能完成验证和下载。普通 HTTP 请求无法绕过 WAF。

相关源码：
- https://github.com/deweizhu/bookget/blob/main/app/cuhk.go

### 图片保护

- AWS WAF 验证：所有请求必须先通过 JavaScript 验证
- 需要有效的 WAF Cookie 才能访问图片
- 无水印（待确认）
- 无 Referer 校验（待确认）
