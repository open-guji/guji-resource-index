# 越南国家图书馆汉喃古籍数字图书馆

<!--
  本文件分两部分：
  - 分割线以上：用户文档，面向普通用户，语言简洁易懂，不含技术细节
  - 分割线以下：开发者文档，面向程序员，包含 API、HTML 解析、下载逻辑等技术细节
-->

越南国家图书馆（National Library of Vietnam, NLV）建设的汉喃古籍在线数字图书馆，正式名称为"Kho tang thu tich co Han Nom"（汉喃古书籍宝库）。收录越南国家图书馆所藏的汉文（Han）与喃字（Nom）古籍文献，基于 Greenstone 数字图书馆软件搭建。这是越南国家层面的汉喃文献数字化项目，由越南国家图书馆与越南喃字保存基金会（VNPF）自 2006 年起合作推进。

- 网站链接：http://hannom.nlv.gov.vn/
- 越南国家图书馆主页：https://nlv.gov.vn/
- 馆藏汉喃古籍总量约 5,200 部
- 已数字化约 1,258 部（约 192,000 页图像）
- 资源类型：汉文与喃字手稿、刻本（Do 纸手工印刷）
- 不支持 IIIF 协议
- 支持越南语和英语界面
- 无需注册登录，免费访问
- 注意：该网站服务器不稳定，可能出现无法访问的情况

## 搜索与浏览

- 搜索页面：http://hannom.nlv.gov.vn/hannom/cgi-bin/hannom?a=q&e=-------vi-20--1--txt-txIN%7CtxME------
- 在搜索页面输入关键词（汉字或越南语罗马字）即可搜索
- 可按文献名称列表浏览：http://hannom.nlv.gov.vn/hannom/cgi-bin/hannom?a=cl&cl=CL1&e=-------vi-20--1--txt-txIN%7CtxME------
- 支持按题名（txIN）和元数据（txME）字段搜索
- 无需注册登录

## 每本书能看到什么

| 字段 | 说明 | 示例 |
|------|------|------|
| 题名 | 汉字书名 + 越南语罗马字 | 易经 - Dich kinh (q.03) |
| 卷次 | 分卷信息 | q.03（第3卷） |
| 年代 | 出版/抄写年代 | 1929、1884 等 |
| 页面图像 | 逐页扫描的古籍图像 | 支持在线浏览 |

注：由于网站服务器不稳定，部分页面元数据的完整字段列表待确认。从已知文献看，元数据信息相对简略，以题名和图像为主。

- 可在线逐页浏览扫描图像
- 无 PDF 下载功能
- 无全文文字（OCR）

## 示例

- 文献页面：http://hannom.nlv.gov.vn/hannom/cgi-bin/hannom?a=d&d=BNTwEHieafeoO
- 另一文献：http://hannom.nlv.gov.vn/hannom/cgi-bin/hannom?a=d&d=BNTwEHieafYPy
- 搜索页面：http://hannom.nlv.gov.vn/hannom/cgi-bin/hannom?a=q&e=-------vi-20--1--txt-txIN%7CtxME------
- 按名称浏览：http://hannom.nlv.gov.vn/hannom/cgi-bin/hannom?a=cl&cl=CL1&e=-------vi-20--1--txt-txIN%7CtxME------

## 相关资源

越南喃字保存基金会数字化的同一批馆藏，也可通过以下渠道访问：
- Nom Foundation 数字图书馆：https://lib.nomfoundation.org/collection/1/ （更稳定）
- 东京大学 SAT IIIF 图像服务器：https://dzkimgs.l.u-tokyo.ac.jp/omekas/s/vnpf-sat/page/about （支持 IIIF）
- 哥伦比亚大学图书馆（2021 年接收 VNPF 档案）

---

# 开发者文档

## URL 结构

网站基于 Greenstone 数字图书馆软件，所有页面通过 CGI 脚本生成。

### 文献详情页
```
http://hannom.nlv.gov.vn/hannom/cgi-bin/hannom?a=d&d={document_id}
```
- `a=d`：文献显示模式
- `document_id`：文献唯一标识符，如 `BNTwEHieafeoO`、`CdjlbdgGlQXzVijn`

部分 URL 带有附加编码参数：
```
http://hannom.nlv.gov.vn/hannom/cgi-bin/hannom?a=d&d={document_id}&e=-------vi-20--1--txt-txIN%7CtxME------
```
- `e` 参数：Greenstone 编码参数，控制语言（vi = 越南语）、显示数量（20）和搜索字段（txIN = 题名, txME = 元数据）

### 搜索页
```
http://hannom.nlv.gov.vn/hannom/cgi-bin/hannom?a=q&e=-------vi-20--1--txt-txIN%7CtxME------
```
- `a=q`：搜索模式

### 分类浏览
```
http://hannom.nlv.gov.vn/hannom/cgi-bin/hannom?a=cl&cl=CL1&e=-------vi-20--1--txt-txIN%7CtxME------
```
- `a=cl`：分类列表模式
- `cl=CL1`：分类标识

### 图片服务
```
http://hannom.nlv.gov.vn/hannom/cgi-bin/imageserver/imageserver.pl?color=all&ext=jpg&oid={BookId}.{CanvasId}&key=&width={width}&crop=0,0,{width},{height}
```
- 图片通过 `imageserver.pl` CGI 脚本提供
- `oid`：由 `BookId.CanvasId` 组成
- `width` / `height`：请求的图片尺寸
- `crop`：裁剪参数，格式为 `x,y,width,height`

## 搜索 API

无公开 JSON API。搜索通过 Greenstone CGI 接口进行，返回 HTML 页面。

搜索请求格式：
```
GET http://hannom.nlv.gov.vn/hannom/cgi-bin/hannom?a=q&r=1&hs=1&e=-------vi-20--1--txt-txIN%7CtxME------&q={keyword}
```
返回 HTML 页面，需解析搜索结果列表。

## 元数据获取

Greenstone 生成的 HTML 页面，元数据嵌入页面中。由于服务器不稳定，具体 HTML 结构待确认。

### 关键 JavaScript 变量

根据 bookget 源码（`hannomnlv.go`），文献页面中包含以下 JavaScript 变量：

```javascript
var documentOID = '{BookId}';  // 文献标识符
```

页面图像信息通过 JavaScript 对象提供：
```javascript
'{CanvasId}':{'w':{width},'h':{height}}
```
其中 `CanvasId` 为图像标识，`w` 和 `h` 为图像原始宽高。

### 字段映射

| 中文字段 | 提取方式 |
|---------|---------|
| 题名 | HTML 页面标题（汉字 - 越南语罗马字格式） |
| 文献 ID | JavaScript 变量 `documentOID` |
| 图像列表 | 正则匹配 `'([^']+)':\{'w':([0-9]+),'h':([0-9]+)\}` |

## 下载

### IIIF
本站不支持 IIIF 协议。但同一批文献可通过东京大学 SAT IIIF 图像服务器访问：
- https://dzkimgs.l.u-tokyo.ac.jp/omekas/s/vnpf-sat/page/about

### bookget 支持
bookget 支持此网站，相关源码：
- https://github.com/deweizhu/bookget/blob/main/app/hannomnlv.go

下载流程（根据 bookget 源码分析）：

1. 访问文献页面，从 HTML 中提取 `documentOID`（正则：`var documentOID = '([^']+)'`）
2. 从页面中提取图片服务 API 端点（正则：`imageserverPageTileImageRequest`），默认为：
   ```
   /hannom/cgi-bin/imageserver/imageserver.pl?color=all&ext=jpg
   ```
3. 从页面中提取所有 Canvas 信息（正则：`'([^']+)':\{'w':([0-9]+),'h':([0-9]+)\}`），获取每页的 CanvasId、宽度、高度
4. 构造图片下载 URL：
   ```
   {apiUrl}&oid={BookId}.{CanvasId}&key=&width={width}&crop=0,0,{width},{height}
   ```
5. 使用 HTTP GET 请求下载图片

注意事项：
- 需设置 User-Agent 请求头
- 支持 Cookie 认证（可选）
- 服务器不稳定，可能出现连接拒绝（ECONNREFUSED）
- bookget 中 `getVolumes()`、`getBody()`、`postBody()` 方法尚未实现
- 建议控制并发下载速度，避免对服务器造成过大压力
