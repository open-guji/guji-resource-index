# 庆应义塾大学图书馆

<!--
  本文件分两部分：
  - 分割线以上：用户文档，面向普通用户，语言简洁易懂，不含技术细节
  - 分割线以下：开发者文档，面向程序员，包含 API、HTML 解析、下载逻辑等技术细节
-->

庆应义塾大学媒体中心数字馆藏（Keio D Collections）是日本庆应义塾大学图书馆建设的数字化平台，公开展示其所藏的贵重资料和特殊馆藏，包括中国古典籍、日本国书、浮世绘版画、西方早期印刷品（含古腾堡圣经）等珍贵文献。

- 网站链接：https://dcollections.lib.keio.ac.jp/ja
- 分享协议：禁止未经许可复制或转载网站内容（需通过联系页面申请）
- 主要馆藏：漢籍（元代以前）、国书（元和9年/1623年以前）、浮世绘约1,500件（高桥收藏）+约880件（波恩收藏）、Google图书馆合作项目约23,000册
- 资源类型：善本古籍（漢籍、国书）、浮世绘版画、西洋摇篮本、古文书（对马宗家文书、相良家文书等）、医学古籍（解体新书等）
- 支持 IIIF 协议，可使用 [bookget](https://github.com/deweizhu/bookget) 等工具下载

## 搜索与浏览

- 搜索页面：https://dcollections.lib.keio.ac.jp/ja（首页提供全馆藏搜索）
- 可按馆藏分类浏览：漢籍、国书、浮世绘、古文书、西洋古籍等20余个专题
- 漢籍按四部分类（经、史、子、集）浏览：https://dcollections.lib.keio.ac.jp/ja/kanseki
- 浮世绘专题：https://dcollections.lib.keio.ac.jp/ja/ukiyoe
- 支持日文和英文双语界面
- 无需注册登录即可浏览和阅读

## 每本书能看到什么

| 字段 | 说明 | 示例 |
|------|------|------|
| 题名 | 书名 | 大般若波羅蜜多經 600巻 存巻511 |
| 著者 | 作者/译者 | 唐釈玄奘 訳 |
| 刊行信息 | 出版地与年代 | 平江府 磧砂延聖院 宋末刊 |
| 装帧 | 物理形态 | 折本 30.7×11.5cm 1帖 |
| 请求号 | 馆藏编号 | 110X@24@1 |
| 著录出处 | 出自哪部目录 | 『和漢貴重書目録』c208 |

- 可通过 Universal Viewer（IIIF 阅读器）在线翻阅高清图片
- 部分馆藏提供 PDF 下载
- 页面提供"IIIF Manifest"按钮，方便在其他 IIIF 阅读器中打开

## 示例

- 漢籍详情页：https://dcollections.lib.keio.ac.jp/ja/kanseki/110x-24-1
- 国书详情页：https://dcollections.lib.keio.ac.jp/en/kanseki/39-34-1
- 浮世绘专题：https://dcollections.lib.keio.ac.jp/ja/ukiyoe

---

# 开发者文档

## URL 结构

### 详情页
```
https://dcollections.lib.keio.ac.jp/ja/{collection}/{item_id}
```
- `collection`：馆藏分类，如 `kanseki`（漢籍）、`kokusho`（国书）、`ukiyoe`（浮世绘）
- `item_id`：资料编号，如 `110x-24-1`

### IIIF Manifest
```
https://dcollections.lib.keio.ac.jp/sites/default/files/iiif/{COLLECTION_CODE}/{ITEM_ID}/manifest.json
```
- `COLLECTION_CODE`：大写缩写，如 `KAN`（漢籍）
- `ITEM_ID`：大写编号，如 `110X-24-1`
- 示例：`https://dcollections.lib.keio.ac.jp/sites/default/files/iiif/KAN/110X-24-1/manifest.json`

### 图片服务
```
https://iiif.lib.keio.ac.jp/iipsrv/{COLLECTION_CODE}/{ITEM_ID}/tif/{page}.tif
```
- 使用 IIPImage 服务器
- IIIF Image API 2.0 Level 1
- 示例：`https://iiif.lib.keio.ac.jp/iipsrv/KAN/110X-24-1/tif/1.tif/full/full/0/default.jpg`

## 搜索 API

无公开搜索 API，需通过页面搜索。网站基于 Drupal 构建，搜索通过前端表单提交。

## 元数据获取

网站为传统服务端渲染（Drupal CMS）。详情页的元数据直接嵌入 HTML 中。

也可从 IIIF Manifest JSON 中提取元数据：
- `label`：题名
- `metadata` 数组：包含各字段键值对

### 字段映射（从 IIIF Manifest）

| 中文字段 | 提取方式 |
|---------|---------|
| 题名 | `manifest.label` |
| 著者 | `manifest.metadata[?label="著者"].value` |
| 年代 | `manifest.metadata[?label="刊行年"].value` |
| 装帧 | `manifest.metadata[?label="形態"].value` |
| 请求号 | `manifest.metadata[?label="請求記号"].value` |

## 下载

### IIIF 方式（推荐）

1. 获取 Manifest URL：`https://dcollections.lib.keio.ac.jp/sites/default/files/iiif/{CODE}/{ID}/manifest.json`
2. 解析 manifest 中的 `sequences[0].canvases`
3. 每个 canvas 的 `images[0].resource.service.@id` 为图片服务地址
4. 拼接 `/{size}/{rotation}/{quality}.{format}` 获取图片
   - 全尺寸：`/full/full/0/default.jpg`

IIIF Presentation API 版本：2.0
IIIF Image API 版本：2.0 Level 1
阅读方向：right-to-left

### bookget 支持

bookget 有专门的 Keio 处理模块：
- 源码：https://github.com/deweizhu/bookget/blob/main/app/keio.go
- 注意：该模块处理的是斯道文庫旧版系统（`db2.sido.keio.ac.jp`），Manifest URL 格式为：
  ```
  https://db2.sido.keio.ac.jp/iiif/manifests/kanseki/{bookId}/{childId}/manifest.json
  ```
- 对于新版 dcollections 站点，可使用 bookget 的通用 IIIF 模块（`iiif.go`）直接传入 manifest URL

### 注意事项

- 图片无水印
- 无需特殊 HTTP 头
- PDF 下载链接在详情页可直接获取
