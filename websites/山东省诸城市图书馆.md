# 山东省诸城市图书馆

<!--
  本文件分两部分：
  - 分割线以上：用户文档，面向普通用户，语言简洁易懂，不含技术细节
  - 分割线以下：开发者文档，面向程序员，包含 API、HTML 解析、下载逻辑等技术细节
-->

山东省诸城市图书馆自建的馆藏特色古籍数据库，整理收集包含馆藏古籍、地志杂记、地方名贤、寓居名人、历代名宦、诸城刘氏、四库文献、仕录谱牒等 8 个主题，共计 1,053 册古籍文献，提供在线阅读。

- 古籍数据库：http://124.134.220.209:8100/index.php
- 官网主站：http://www.zcslib.com/
- 分享协议：未明确标注
- 约 1,053 册古籍（数据库已上线部分）
- 馆藏古籍总量：859 种 4,644 册，善本 161 种 1,011 册
- 地方文献：38 部 108 册（诸城地方文献）
- 58 部入选《山东省珍贵古籍名录》，82 部入选《潍坊市珍贵古籍名录》
- 资源类型：善本、普通古籍、地方志、族谱、四库文献
- 不支持 IIIF 协议
- 支持 [bookget](https://github.com/deweizhu/bookget) 下载

## 搜索与浏览

- 入口页面：http://124.134.220.209:8100/index.php
- 按 8 个主题分类浏览：馆藏古籍、地志杂记、地方名贤、寓居名人、历代名宦、诸城刘氏、四库文献、仕录谱牒
- 点击分类进入列表，再点击进入具体古籍详情页
- 无需注册登录

## 每本书能看到什么

| 字段 | 说明 | 示例 |
|------|------|------|
| 题名 | 书名 | 待确认 |
| 卷册 | 该书包含的分卷/分册 | 待确认 |
| 在线阅读 | 内嵌阅读器逐页翻阅 | 待确认 |

- 提供逐页图片在线阅读（reader.php）
- 无 OCR 全文文字
- 无 PDF 整册下载

## 示例

- 详情页：`http://124.134.220.209:8100/index.php?ac=detail&id=400757`

## 相关出版物

诸城市图书馆于 2023 年出版《诸城古籍名录图录》（山东大学出版社），汇集了图书馆、博物馆、档案馆等 6 个单位的古籍藏品，收录 1912 年以前古籍 822 种 4,970 册、民国线装书 155 种 1,234 册，合计 977 种 6,204 册。

## 当前状态

古籍数字资源服务器（124.134.220.209:8100）在外网可能无法直接访问（ECONNREFUSED），可能需要从国内网络访问。官网 zcslib.com 同样在境外无法正常连接。

---

# 开发者文档

## URL 结构

### 首页/分类列表
```
http://124.134.220.209:8100/index.php
```

### 详情页
```
http://124.134.220.209:8100/index.php?ac=detail&id={book_id}
```
- `book_id`：古籍编号（纯数字），如 `400757`

### 卷册目录页
```
http://124.134.220.209:8100/index.php?ac=catalog&id={book_id}
```
- 返回该书所有卷册的链接列表

### 阅读页
```
http://124.134.220.209:8100/reader.php{params}
```
- 具体参数从目录页中的链接提取

### 图片 URL
```
http://124.134.220.209:8100/images/book/{bid}/{cid}/{page_number}{extension}
```
- `bid`：书籍标识（从阅读页 JavaScript 变量 `BID` 获取）
- `cid`：章节/卷册标识（从阅读页 JavaScript 变量 `CID` 获取）
- `page_number`：页码
- `extension`：图片扩展名（从阅读页 JavaScript 变量 `imgtype` 获取）

## 搜索 API

无公开搜索 API，需通过页面分类浏览。

## 元数据获取

详情页为传统服务端渲染 HTML（PHP 生成）。

### 卷册目录提取

从目录页（`index.php?ac=catalog&id={book_id}`）中提取各卷册链接：

正则：
```
href="./reader.php([^"]+?)"
```
匹配结果为各卷册阅读页的 URL 参数。

### 阅读页变量提取

阅读页（reader.php）内嵌 JavaScript 变量，包含下载所需的关键信息：

| 变量 | 正则 | 说明 |
|------|------|------|
| BID | `var\s+BID\s+=\s+'([A-z0-9]+)'` | 书籍标识 |
| CID | `var\s+CID\s+=\s+'([A-z0-9]+)'` | 卷册标识 |
| imgtype | `var\s+imgtype\s+=\s+'([A-z.]+)'` | 图片扩展名 |
| PAGES | `var\s+PAGES\s+=\s+([0-9]+)` | 总页数 |

## 下载

### bookget 支持

- 源码：[app/zhucheng.go](https://github.com/deweizhu/bookget/blob/main/app/zhucheng.go)
- 命令示例：`bookget "http://124.134.220.209:8100/index.php?ac=detail&id=400757"`
- 下载格式：逐页图片（非 PDF）

### 下载流程

1. 从详情页 URL 提取 `id` 参数（正则 `&id=(\d+)`）
2. GET 目录页 `index.php?ac=catalog&id={book_id}`，解析所有 `reader.php` 链接
3. 逐一 GET 各阅读页，从 JavaScript 中提取 `BID`、`CID`、`imgtype`、`PAGES` 四个变量
4. 拼接图片 URL：`{scheme}://{host}/images/book/{BID}/{CID}/{page_number}{imgtype}`
5. 使用并发下载（WaitGroup + queue）逐页下载图片
6. 每个卷册创建独立目录

### 必需 HTTP 请求头

| Header | 值 |
|--------|-----|
| User-Agent | 配置项 |
| Cookie | 需维持 Cookie 会话（CookieJar） |

### 保护措施

- Cookie 会话保持：使用 CookieJar 管理会话
- 无水印（待确认）
- 无明确的 Referer 校验（待确认）
