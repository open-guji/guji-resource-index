# 国立公文书馆（国立公文書館 デジタルアーカイブ）

<!--
  本文件分两部分：
  - 分割线以上：用户文档，面向普通用户，语言简洁易懂，不含技术细节
  - 分割线以下：开发者文档，面向程序员，包含 API、HTML 解析、下载逻辑等技术细节
-->

日本国立公文书馆（National Archives of Japan）的数字档案系统，由日本内阁府下属的国立公文书馆建设运营。馆藏包括行政文书、司法文书、法人文书以及重要的**内阁文库**（内閣文庫）收藏。内阁文库是日本政府自江户幕府时代积累的图书收藏，藏有大量珍贵的日本古典籍（和书）、中国古典籍（汉籍）和西洋书籍，是研究中日古籍的重要资源。

- 网站链接：https://www.digital.archives.go.jp/
- 英文版：https://www.digital.archives.go.jp/index_e.html
- 分享协议：[CC0 1.0 公共领域](https://creativecommons.org/publicdomain/zero/1.0/)（大部分资料）
- 目录约 419 万条记录，其中约 35 万件已数字化（约 22.5%）
- 资源类型：行政公文、司法文书、古典籍（和书、汉籍）、古地图、绘卷、重要文化财
- 部分资源支持 IIIF 协议（以地图、绘卷等大幅面资料为主），可使用 Mirador、Universal Viewer 等查看器浏览
- 无需注册即可搜索、浏览、下载

## 搜索与浏览

- 搜索页面（日文）：https://www.digital.archives.go.jp/DAS/meta/default
- 搜索页面（英文）：https://www.digital.archives.go.jp/DAS/meta/default?IS_STYLE=eng
- 横断检索（跨机构）：https://www.digital.archives.go.jp/globalfinder/cgi/start

### 搜索方式

- **关键词搜索**：输入关键词即可搜索，支持布尔运算符（AND、OR、NOT）
- **高级搜索**：可按题名、著者、关联资料等字段检索，最多可组合 5 个条件
- **高级筛选条件**：日期范围（日本年号）、资料群/系列、利用限制、保管场所、请求号、移管来源、IIIF 对应图片有无
- **组织沿革图搜索**：通过日本政府机构变迁图查找相关资料
- **大成类典结构搜索**：按「太政類典」编制体系浏览
- **横断检索**：可同时搜索亚洲历史资料中心等关联机构

### 浏览方式

可按资料群层次浏览，主要分为：
- 行政文书（61 个子资料群）
- 司法文书（5 个子资料群）
- 法人文书（32 个子资料群）
- 寄赠/寄托文书（50 个子资料群）
- **内阁文库**（3 个子资料群：和书、汉籍、洋书）

还可按"特色资料"浏览：宪法相关、重要文化财公文书、重要文化财国绘图、重要文化财和书、重要文化财汉籍等。

## 每本书能看到什么

| 字段 | 说明 | 示例 |
|------|------|------|
| 题名 | 书名/文件名 | 明月記 |
| 著者 | 作者/编者 | 藤原定家 |
| 请求号 | 馆内管理编号 | 特１０５－０００２ |
| 年代 | 成书年代范围 | 治承04年～文暦02年 |
| 形态 | 写本/刊本 | 写本 |
| 数量 | 册数 | 19冊 |
| 书写年代 | 抄写/出版年代 | 享保15年～享保20年 |
| 言语 | 使用语言 | 日本語 |
| 旧蔵者 | 原藏书来源 | 紅葉山文庫 |
| 公开状态 | 是否公开 | 公開 |
| 二次利用 | 再利用许可 | 可：CC0 1.0 |
| 所属资料群 | 层级分类路径 | 内閣文庫 > 和書 > 和書(多聞櫓文書を除く) |

- 可在线以 JPEG 格式逐页翻阅图片
- 可下载 JPEG 格式图片，也可下载 PDF 格式
- 部分资料支持 IIIF 高精细图像浏览
- 搜索结果支持 CSV 导出（上限 1000 条）
- 无全文 OCR 文字

## 示例

- 内阁文库首页（资料群浏览）：https://www.digital.archives.go.jp/fonds/2308962.html
- 明月记（藤原定家日记，写本）：https://www.digital.archives.go.jp/file/1272005
- 日本书纪（刊本）：https://www.digital.archives.go.jp/file/1271243
- 万叶考（贺茂真渊著）：https://www.digital.archives.go.jp/file/1238259
- 旧式详情页示例：https://www.digital.archives.go.jp/das/meta/F1000000000000047547.html
- 图片浏览页示例：https://www.digital.archives.go.jp/DAS/meta/listPhoto?LANG=default&BID=F1000000000000047547

---

# 开发者文档

## URL 结构

2021 年系统经历了重大改版（云化、IIIF 支持、OAI-PMH 支持），目前新旧两套 URL 并存。

### 新版 URL（2021 年改版后）

```
# 资料群（Fonds）页面
https://www.digital.archives.go.jp/fonds/{fonds_id}.html

# 簿册/件（File）详情页 —— 对应一部完整的书或一组文件
https://www.digital.archives.go.jp/file/{file_id}.html

# 单件（Item）详情页 —— 对应簿册中的单个条目
https://www.digital.archives.go.jp/item/{item_id}.html

# 图片浏览（带页码）
https://www.digital.archives.go.jp/img/{file_id}/{page_number}
```

- `fonds_id`：资料群 ID，如 `2308962`（内阁文库）
- `file_id`：簿册 ID，如 `1272005`（明月記）
- `item_id`：单件 ID，如 `704552`
- `page_number`：页码（从 1 开始），可直接定位到具体页

新版 URL 均为持久 URI（Persistent URI），可用于引用。

### 旧版 DAS URL（仍可访问）

```
# 搜索页面
https://www.digital.archives.go.jp/DAS/meta/default
https://www.digital.archives.go.jp/DAS/meta/default?IS_STYLE=eng

# 详情页
https://www.digital.archives.go.jp/DAS/meta/Detail_{metadata_id}
https://www.digital.archives.go.jp/das/meta/{metadata_id}.html

# 图片列表/浏览
https://www.digital.archives.go.jp/DAS/meta/listPhoto?LANG={lang}&BID={metadata_id}&ID={image_id}&NO={page}&TYPE={type}

# 缩略图
https://www.digital.archives.go.jp/DAS/meta/delegate?md={metadata_id}
```

参数说明：
- `metadata_id`：以 `F` 开头的长 ID，如 `F1000000000000047547`
- `LANG`：语言，`default`（日文）或 `eng`（英文）
- `BID`：Bundle ID，等同于 metadata_id
- `ID`：图片 ID，以 `M` 开头（可选）
- `NO`：页码（可选）
- `TYPE`：格式类型 —— `PDF`、`dljpeg`（下载 JPEG）
- `DL_TYPE`：下载类型，如 `pdf`
- `CN`：页数参数

### IIIF Manifest

```
https://www.digital.archives.go.jp/api/iiif/{image_identifier}/manifest.json
```

- `image_identifier`：图片标识符，可在支持 IIIF 的资料的图片浏览页面底部找到
- 仅部分资料支持 IIIF（主要为地图、绘卷等大幅面资料）
- 搜索时可勾选"IIIF対応画像 → 有"来筛选支持 IIIF 的资料

## 搜索 API

### DAS 搜索接口

搜索通过 DAS 系统的传统 URL 参数方式进行，无独立 JSON API。

```
GET https://www.digital.archives.go.jp/DAS/meta/default?IS_STYLE={lang}&IS_KIND=detail&DB_ID=G9100001EXTERNAL&GRP_ID=G9100001&IS_TAG_S1={field}&IS_KEY_S1={keyword}&IS_LGC_S1=AND
```

主要参数：
- `IS_STYLE`：`default`（日文）或 `eng`（英文）
- `IS_KIND`：搜索类型，`detail` 为详细搜索
- `IS_TAG_S1` ~ `IS_TAG_S5`：搜索字段标签（最多 5 个条件）
- `IS_KEY_S1` ~ `IS_KEY_S5`：对应的搜索关键词
- `IS_LGC_S1` ~ `IS_LGC_S5`：逻辑运算符（`AND`、`OR`、`NOT`）
- `IS_EXTSCH`：限定资料群 ID（如限定在内阁文库内搜索）
- `IS_SORT_FLD`：排序字段
- `IS_SORT_KND`：排序方向（`asc`/`desc`）

搜索字段（`IS_TAG_Sn`）常见值：
- `eadid`：资料 ID
- 待确认：题名、著者等具体字段标签值

### OAI-PMH 接口

2021 年改版后支持 OAI-PMH 协议，用于元数据批量获取。具体端点 URL 待确认，预计为标准格式：

```
https://www.digital.archives.go.jp/oai?verb=ListRecords&metadataPrefix=oai_dc
```

元数据格式：RDF，使用 Dublin Core 和 EAD（Encoded Archival Description）标准。元数据授权为 CC0。

### Japan Search 集成

国立公文书馆的元数据通过 OAI-PMH 每周自动同步到 [Japan Search](https://jpsearch.go.jp/)，可通过 Japan Search 的 API 间接检索。

## 元数据获取

### 新版页面（/file/ 和 /item/）

新版详情页为服务端渲染的 HTML 页面。元数据字段在页面中以表格形式呈现。

### 字段映射

| 中文字段 | 日文字段名 | 提取方式 |
|---------|-----------|---------|
| 题名 | タイトル | 页面 HTML 中的表格行 |
| 著者 | 作成者 | 页面 HTML 中的表格行 |
| 请求号 | 請求番号 | 页面 HTML 中的表格行 |
| 年代 | 年代域 | 页面 HTML 中的表格行 |
| 形态 | 写本/刊本 等 | 页面 HTML 中的表格行 |
| 数量 | 数量 | 页面 HTML 中的表格行 |
| 言语 | 言語 | 页面 HTML 中的表格行 |
| 旧蔵者 | 旧蔵者 | 页面 HTML 中的表格行 |
| 公开状态 | 公開 | 页面 HTML 中的表格行 |
| 二次利用 | 二次利用 | 页面 HTML 中的表格行 |
| 资料群 | 資料群階層 | 面包屑导航 / 页面 HTML |
| 持久 URI | URI | 页面 HTML，如 `https://www.digital.archives.go.jp/file/{id}` |
| 元数据 ID | — | 旧版为 `F` 开头 ID，可在旧版页面或 URL 中获取 |

注意：具体的 HTML 选择器可能随页面改版变化，建议以实际页面结构为准。页面为传统服务端渲染，非 SPA，可直接抓取 HTML。

## 下载

### 1. IIIF（部分资料）

支持 IIIF 的资料可通过标准 IIIF Image API 下载高精细图片：

```
# Manifest
https://www.digital.archives.go.jp/api/iiif/{identifier}/manifest.json

# 从 manifest 解析出的 Image API 端点下载图片
{image_service_id}/{region}/{size}/{rotation}/{quality}.{format}
```

流程：
1. 在搜索中筛选"IIIF対応画像 → 有"
2. 打开图片浏览页，在页面底部找到 Manifest URI
3. 获取 manifest.json，解析 `sequences[0].canvases[].images[].resource.service.@id` 获取 Image Service ID
4. 按 IIIF Image API 规范拼接下载 URL

推荐查看器：Mirador、Universal Viewer、IIIF Curation Viewer

### 2. JPEG 直接下载（大部分资料）

大部分资料可通过旧版 DAS 接口下载 JPEG：

```
# 下载单张 JPEG（通过 listPhoto 接口）
https://www.digital.archives.go.jp/DAS/meta/listPhoto?BID={metadata_id}&ID={image_id}&TYPE=dljpeg&LANG=default

# 下载 PDF（含多页）
https://www.digital.archives.go.jp/DAS/meta/listPhoto?BID={metadata_id}&TYPE=PDF&DL_TYPE=pdf&CN=1&LANG=default
```

### 3. bookget 支持情况

bookget 的 wiki 中列出了国立公文书馆，给出了如下 URL 格式：

```
https://www.digital.archives.go.jp/DAS/meta/listPhoto?LANG=default&BID=F1000000000000095447&ID=&NO=&TYPE=
```

但 bookget 源码中**没有专门的处理模块**（无 `naikaku.go` 或 `kobunsho.go`），`archive.go` 文件处理的是 archive.org 而非国立公文书馆。由于部分资料支持 IIIF，可能通过 bookget 的通用 IIIF 模块（`iiif.go`）下载 IIIF 支持的资料。

### 4. 注意事项

- 大部分资料为 CC0 公共领域，可自由使用
- 系统在 2021 年从 PDF 默认切换为 JPEG 默认格式，PDF 为后端动态转换生成
- 新版系统图片 URL 格式为 `/img/{file_id}/{page}`，具体图片资源的获取方式待确认
- 无水印保护（CC0 资料）
- 无需特殊请求头（无 Referer 校验等）
- 横断检索接口与主搜索接口独立，端点为 `/globalfinder/cgi/start`
