# 国立国会图书馆デジタルコレクション（NDL Digital Collections）

<!--
  本文件分两部分：
  - 分割线以上：用户文档，面向普通用户，语言简洁易懂，不含技术细节
  - 分割线以下：开发者文档，面向程序员，包含 API、HTML 解析、下载逻辑等技术细节
-->

日本国立国会图书馆（National Diet Library, NDL）运营的数字化资源平台，是日本规模最大的数字图书馆之一。馆藏涵盖日本古典籍、中国古籍（和刻本及传入日本的汉籍）、近代图书、期刊、官报、博士论文等，全文检索对象资料已超过 300 万件。

- 网站链接：https://dl.ndl.go.jp/
- 分享协议：大量古典籍标记为 [PDM（Public Domain Mark）](https://creativecommons.org/publicdomain/mark/1.0/)，即公共领域作品；部分资料有访问限制
- 约 300 万件以上数字化资料（其中互联网公开的古典籍约 35 万件）
- 资源类型：古典籍（和刻本、汉籍、写本）、近代图书、期刊杂志、官方公报、博士论文、地图、音乐等
- 支持 IIIF 协议（v2），可使用 [bookget](https://github.com/deweizhu/bookget) 等工具下载

## 搜索与浏览

- 搜索页面：https://dl.ndl.go.jp/
- 在首页搜索框输入关键词即可搜索，支持日文和中文关键词
- 支持详细检索（详細検索），可按以下字段组合搜索：题名、著者、出版者、出版年份、NDC 分类号等
- 搜索结果可按以下维度筛选：
  - 资料类型（图书、期刊、古典籍、官报、博士论文等）
  - 公开范围（互联网公开、图书馆送信、馆内限定）
  - 出版年代
  - 语言
  - 著作权状态（PDM / 保护期间内等）
- 无需注册即可浏览互联网公开的资料；部分资料（图书馆送信资料）需要通过日本图书馆或个人认证账号访问
- NDL Search（https://ndlsearch.ndl.go.jp/）是统合检索入口，可跨库搜索包括数字馆藏在内的全部 NDL 资源

## 每本书能看到什么

| 字段 | 说明 | 示例 |
|------|------|------|
| 题名 | 书名（含卷次） | 平妖傳8巻40回.[1] |
| 著者 | 作者/编者 | 明羅貫中撰, 明馮夢龍補 |
| 出版年 | 出版/刊刻年代 | 嘉慶17刊(書業堂藏板) |
| W3CDTF 年份 | 标准化西历年份 | 1812 |
| 语言 | 文献语言 | chi（中文）/ jpn（日文） |
| 请求记号 | 馆内索取号 | 寄別13-46 |
| 书志 ID | 书目记录编号 | 000007726189 |
| DOI | 数字对象标识符 | 10.11501/2592420 |
| PID | 永久标识符 | info:ndljp/pid/2592420 |
| 著作权 | 权利状态 | PDM（公共领域） |
| 资料类型 | 分类 | Book, ChineseClassicalBook |
| 集合 | 所属专题 | 古典籍資料（貴重書等） |

- 可在线翻阅高清扫描图片，内置 IIIF 兼容阅读器
- 互联网公开资料可通过 IIIF Image API 获取任意分辨率图片
- 支持全文检索（OCR 文字）
- 可将 IIIF Manifest 导入 Mirador 等第三方 IIIF 阅读器

## 示例

- 详情页（中国古籍·平妖传）：https://dl.ndl.go.jp/pid/2592420
- 详情页（日本古典籍·源氏物語）：https://dl.ndl.go.jp/pid/2545997
- 带页码的阅读页：https://dl.ndl.go.jp/pid/2532360/1/1
- IIIF Manifest：https://dl.ndl.go.jp/api/iiif/2592420/manifest.json

---

# 开发者文档

## URL 结构

### 详情页
```
https://dl.ndl.go.jp/pid/{book_id}
```
- `book_id`：NDL 的永久标识符数字部分（PID 数字），如 `2592420`

### 带页码的阅读页
```
https://dl.ndl.go.jp/pid/{book_id}/{volume}/{page}
```
- `volume`：卷册号（从 1 开始）
- `page`：页码（从 1 开始）

### IIIF Manifest
```
https://dl.ndl.go.jp/api/iiif/{book_id}/manifest.json
```
- 返回 IIIF Presentation API v2 格式的 JSON

### IIIF Image API
```
https://dl.ndl.go.jp/api/iiif/{book_id}/{image_id}/{region}/{size}/{rotation}/{quality}.{format}
```
- `image_id`：图片标识符，格式为 `R0000001`、`R0000002` 等（7 位数字，左补零）
- 遵循 IIIF Image API 2.0 规范，Level 1 兼容
- 示例（获取全尺寸 JPEG）：`https://dl.ndl.go.jp/api/iiif/2592420/R0000001/full/full/0/default.jpg`

## 搜索 API

NDL 提供多个搜索 API，但注意：数字馆藏（dl.ndl.go.jp）本身是 SPA 应用，其前端搜索通过内部 API 驱动。公开的标准 API 通过 NDL Search（ndlsearch.ndl.go.jp）提供。

### NDL Search SRU API
```
GET https://ndlsearch.ndl.go.jp/api/sru?operation=searchRetrieve&query={CQL_query}&maximumRecords={count}
```
- 查询语法：CQL 1.2（Contextual Query Language）
- 参数需 UTF-8 URL 编码
- 响应格式：XML（DC-NDL RDF）
- 示例：搜索数字馆藏中的古典籍，可用 `dpid=ndl-dl` 限定数据源

### NDL Search OpenSearch API
```
GET https://ndlsearch.ndl.go.jp/api/opensearch?title={关键词}&cnt={数量}&dpid=ndl-dl
```
- `title`：题名关键词（UTF-8 编码）
- `cnt`：返回结果数
- `dpid`：数据提供者 ID，`ndl-dl` 表示数字馆藏
- `ndc`：NDC 分类号（前方一致匹配）
- 响应格式：RSS 2.0（XML）

### NDL Search OAI-PMH（批量采集）
```
GET https://ndlsearch.ndl.go.jp/api/oaipmh?verb=ListRecords&metadataPrefix=dcndl_rdf&set=ndl-dl
```
- 用于批量获取元数据

### 缩略图 API
```
GET https://ndlsearch.ndl.go.jp/thumbnail/{book_id}.jpg
```
- 返回 JPEG 格式缩略图

### 注意事项
- NDL 会限制并发访问，大量连续请求可能被封禁 IP
- 非商业用途一般无需申请；商业用途需向 NDL 提交申请
- 元数据采用 CC BY 4.0 许可

## 元数据获取

NDL 数字馆藏的详情页是 SPA 应用，HTML 中不包含实际元数据。需通过后端 API 获取。

### 方式一：Item API（数字馆藏内部 API）
```
GET https://dl.ndl.go.jp/api/item/search/info:ndljp/pid/{book_id}
```
- 返回 JSON，包含完整元数据和内容信息
- 无需认证，但建议设置合理的 User-Agent 和 Referer

### 方式二：IIIF Manifest
```
GET https://dl.ndl.go.jp/api/iiif/{book_id}/manifest.json
```
- `metadata` 数组中包含主要书目字段

### 方式三：TOC API（目录结构）
```
GET https://dl.ndl.go.jp/api/meta/search/toc/facet/{book_id}
```
- 返回 JSON，包含该 PID 下的卷册层级结构

### 字段映射

#### Item API 字段映射（JSON 路径）

| 中文字段 | JSON 路径 | 示例值 |
|---------|---------|--------|
| PID | `item.pid` | `info:ndljp/pid/2592420` |
| 数字 ID | `item.itemId` | `2592420` |
| 语言 | `item.meta.0065Dk[0]` | `chi` |
| 题名（片假名） | `item.meta.0311Dtct[0]` | `ヘイヨウデン 8カン 40カイ` |
| 著者 | `item.meta.0010Dtct[]` | 明羅貫中撰, 明馮夢龍補 |
| 资料类型 | `item.meta.0078Dk[]` | `["Book","ChineseClassicalBook"]` |
| 出版信息 | `item.meta.0058Dod[]` | `嘉慶17刊(書業堂藏板)` |
| 著作权 | `item.rights.code` | `pdm` |
| 公开状态 | `item.publishStatus` | `approved` |
| 缩略图 | `item.thumbnail` | （路径字符串） |
| 所属集合 | `item.collections[]` | `["A00008"]` |

注意：`meta` 中的字段名使用内部编码（如 `0065Dk`），不同资料类型可能包含不同字段。

#### IIIF Manifest 字段映射

| 中文字段 | Manifest 中的 label | 示例值 |
|---------|-------------------|--------|
| PID | Persistent ID | `info:ndljp/pid/2592420` |
| 题名 | Title | `平妖傳8巻40回.[1]` |
| 著者 | Creator | `明羅貫中撰\|\|明馮夢龍補` |
| 出版年 | Date | `嘉慶17刊(書業堂藏板)` |
| 标准年份 | Date (W3CDTF) | `1812` |
| 请求记号 | Call Number | `寄別13-46` |
| 书志 ID | Bibliographic ID | `000007726189` |
| DOI | DOI | `10.11501/2592420` |
| 访问限制 | Access Restrictions | `PDM` |
| URL | URL | `https://dl.ndl.go.jp/info:ndljp/pid/2592420` |

## 下载

### IIIF 下载（推荐）

NDL 数字馆藏完整支持 IIIF v2，这是获取图片的最佳方式。

**Manifest URL 格式：**
```
https://dl.ndl.go.jp/api/iiif/{book_id}/manifest.json
```

**Image API Service ID 格式（从 manifest 中提取）：**
```
https://dl.ndl.go.jp/api/iiif/{book_id}/{image_id}
```

**从 manifest 到图片 URL 的完整流程：**
1. 获取 manifest：`GET https://dl.ndl.go.jp/api/iiif/{book_id}/manifest.json`
2. 解析 `sequences[0].canvases[]`，每个 canvas 对应一页
3. 在每个 canvas 中，取 `images[0].resource.service.@id` 获得 Image API 的 service ID
4. 拼接图片 URL：`{service_id}/full/full/0/default.jpg`（获取全尺寸 JPEG）
5. 也可使用 IIIF Image API 参数控制尺寸，如 `{service_id}/full/1024,/0/default.jpg`（宽 1024 像素）

**图片 ID 命名规则：**`R` + 7 位数字（从 `R0000001` 开始递增）

**图片尺寸：** 原始扫描分辨率通常很高（示例：5456 x 5063 像素）

### bookget 支持

bookget 对 NDL 有专门支持，源码：[ndljp.go](https://github.com/deweizhu/bookget/blob/main/app/ndljp.go)

**使用方式：**
```bash
# 方式一：传入详情页 URL
bookget "https://dl.ndl.go.jp/pid/2592420"

# 方式二：传入 IIIF Manifest URL（走通用 IIIF 流程）
bookget "https://dl.ndl.go.jp/api/iiif/2592420/manifest.json"
```

**bookget 关键下载逻辑（ndljp.go）：**
1. 从 URL 中用正则 `/pid/([A-Za-z0-9]+)` 提取 `book_id`
2. 调用 TOC API `https://dl.ndl.go.jp/api/meta/search/toc/facet/{book_id}` 获取卷册列表
   - 如果有 `children`，则每个 child 的 `id` 是一个卷册
   - 如果没有 `children`，则 `book_id` 本身就是唯一的卷册
3. 对每个卷册，调用 Item API `https://dl.ndl.go.jp/api/item/search/info:ndljp/pid/{volume_id}` 获取 `iiifManifestUrl`
4. 获取 IIIF Manifest，解析 `sequences[0].canvases[].images[].resource.service.@id`
5. 拼接图片 URL：`{service_id}/{format}`（format 由配置决定，默认 `full/full/0/default.jpg`）
6. 多线程下载，支持 Cookie 和自定义请求头

### HTTP 请求注意事项

- **User-Agent**：建议设置为常见浏览器 UA
- **Referer**：bookget 使用 URL 编码后的 API 地址作为 Referer
- **Cookie**：使用 CookieJar 维持会话
- **无水印**：互联网公开的 PDM 资料图片无水印
- **无 Referer 校验**：IIIF Image API 端点未发现严格的 Referer 校验
- **并发限制**：建议控制并发数，避免被限流
