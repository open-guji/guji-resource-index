# 早稻田大学图书馆古典籍总合数据库

<!--
  本文件分两部分：
  - 分割线以上：用户文档，面向普通用户，语言简洁易懂，不含技术细节
  - 分割线以下：开发者文档，面向程序员，包含 API、HTML 解析、下载逻辑等技术细节
-->

早稻田大学图书馆（早稲田大学図書館）建设的「古典籍総合データベース」，是日本规模最大的大学古籍数字化平台之一。收录约 30 万件古典籍资料，包含 2 件国宝和 5 件重要文化财，涵盖日本古典文学、中国古籍汉籍、历史文献、绘画、地图等各领域，提供详细书志信息和高清彩色图像。

- 网站链接：https://www.wul.waseda.ac.jp/kotenseki/
- 英文版：https://www.wul.waseda.ac.jp/kotenseki/index_en.html
- 分享协议：个人研究、课堂教学、学术论文可免费使用（需注明出处）；出版、商用需[申请许可](https://www.waseda.jp/library/user/using-images/)
- 约 300,000 件古典籍
- 资源类型：和古书、汉籍善本、手稿、绘画、地图、拓片等
- 部分馆藏支持 IIIF 协议，可使用 [bookget](https://github.com/deweizhu/bookget) 等工具下载
- 另有 PDF 格式直接下载
- 无需注册登录

## 搜索与浏览

- 简单搜索页面：https://www.wul.waseda.ac.jp/kotenseki/index.html
- 详细搜索页面：https://www.wul.waseda.ac.jp/kotenseki/advanced_search.html
- 在首页搜索框输入关键词即可搜索，如「周易」「杉田玄白」等
- 详细搜索支持按以下字段检索：
  - 全项目（所有字段）
  - 标题（タイトル）
  - 著者/作者
  - 出版事项
  - 关键词
- 可通过 IIIF 筛选项，仅显示有 IIIF 高清图像的资料
- 搜索结果每页可显示 10、30、50、100、500 条
- 无需注册登录，完全公开访问
- 也可通过早稻田大学 OPAC 系统（WINE / Primo）检索古典籍

## 每本书能看到什么

| 字段 | 日文标签 | 示例 |
|------|---------|------|
| 请求记号 | 請求記号 | リ08 01899 |
| 题名 | タイトル | 二十一史論賛. 巻之7-36 / 沈国元 批評 |
| 著者 | 著者/作者 | 沈 国元 |
| 出版信息 | 出版事項 | [出版地不明] : 大来堂, [出版年不明] |
| 形态 | 形態 | 18冊 ; 26cm |
| 内容说明 | 内容等 | 朱筆書き入れあり、虫損あり、唐装... |
| 关键词 | キーワード | 古典籍 / 歴史－中国史 |
| 公开者 | 公開者 | 早稲田大学図書館 |

- 每本书提供缩略图预览和在线图像浏览（通过 archive 页面翻阅）
- 部分资料提供 PDF 下载（按卷/册分别下载）
- 部分资料支持 IIIF 高清查看器（通过早稻田文化资源数据库的 Universal Viewer）
- 无 OCR 全文文字

## 示例

- 详情页（多卷本）：https://www.wul.waseda.ac.jp/kotenseki/html/ri08/ri08_01899/index.html
- 详情页（单件）：https://www.wul.waseda.ac.jp/kotenseki/html/chi06/chi06_04710/index.html
- 图像浏览页（含 PDF 下载）：https://archive.wul.waseda.ac.jp/kosho/ri08/ri08_01899/
- IIIF 查看器：https://archive.waseda.jp/archive/iiif-viewer/uv?manifest=https://iiif.archive.waseda.jp/iiif/manifest/ktnsk/chi06_04710/manifest.json&lang=jp

---

# 开发者文档

## URL 结构

### 详情页（书志信息页）
```
https://www.wul.waseda.ac.jp/kotenseki/html/{collection_code}/{item_id}/index.html
```
- `collection_code`：馆藏分类代码，如 `ri08`、`chi06`、`i04`、`ro12`、`bunko08`、`bunko31` 等
- `item_id`：资源唯一标识，格式为 `{collection_code}_{序号}`，如 `ri08_01899`、`chi06_04710`

### 图像/文件浏览页（archive 目录）
```
https://archive.wul.waseda.ac.jp/kosho/{collection_code}/{item_id}/
```
- 该页面列出该书所有卷册的缩略图、HTML 阅读页和 PDF 下载链接

### 卷册页面（多卷本）
```
https://archive.wul.waseda.ac.jp/kosho/{collection_code}/{item_id}/{item_id}_{volume_number}/
```
- `volume_number`：四位数字，如 `0001`、`0002` ... `0018`
- 每卷内有：
  - `{item_id}_{volume_number}.html` — HTML 阅读页（含逐页图片链接）
  - `{item_id}_{volume_number}.pdf` — PDF 下载

### 单页图片 URL
```
https://archive.wul.waseda.ac.jp/kosho/{collection_code}/{item_id}/{item_id}_{volume_number}/{item_id}_{volume_number}_{page_number}.jpg
```
- `page_number`：四位数字页码，如 `0001`、`0002`
- 缩略图后缀为 `_p{page_number}s.jpg`（如 `ri08_01899_0001_p0001s.jpg`）

### IIIF Manifest（部分资料）
```
https://iiif.archive.waseda.jp/iiif/manifest/ktnsk/{item_id}/manifest.json
```
- `ktnsk` 为古典籍数据库的集合代码
- 注意：多卷本的 manifest URL 规则待确认，可能需要逐卷指定

### IIIF Image API
```
https://iiif.archive.waseda.jp/iiif/image/ktnsk/{item_id}/{image_identifier}/{region}/{size}/{rotation}/{quality}.{format}
```
- 遵循 IIIF Image API 2.0 标准
- 完整图片示例：`https://iiif.archive.waseda.jp/iiif/image/ktnsk/chi06_04710/{filename}/full/full/0/default.jpg`

### IIIF 查看器
```
https://archive.waseda.jp/archive/iiif-viewer/uv?manifest={manifest_url}&lang=jp
```

## 搜索 API

搜索通过 `search.php` 的 GET 请求实现（服务端渲染，返回 HTML）：

```
https://www.wul.waseda.ac.jp/kotenseki/search.php?{参数}
```

已知参数：
| 参数 | 说明 | 示例 |
|------|------|------|
| `cndbn` | 书名/标题 | `周易` |
| `cndtp` | 类型筛选，`iiif` 表示仅 IIIF 资料 | `iiif` |
| `btnSearch` | 搜索按钮（固定值） | `検索` |

详细搜索的其他参数（推测，待确认）：
| 参数 | 说明 |
|------|------|
| `cndan` | 著者/作者 |
| `cndky` | 关键词 |
| `cndpb` | 出版事项 |
| `p` | 页码 |
| `rpa` | 每页显示条数（10/30/50/100/500） |

无 JSON API，搜索结果需解析 HTML。

## 元数据获取

详情页为传统服务端渲染 HTML，元数据可直接从 HTML 解析。

详情页结构：`index.html` 使用表格布局，包含书志信息字段。

### 字段映射

| 中文字段 | 日文标签 | 提取方式 |
|---------|---------|---------|
| 请求记号 | 請求記号 | HTML 表格行文本 |
| 题名 | タイトル | HTML 表格行，含链接到 OPAC 检索 |
| 著者 | 著者/作者 | HTML 表格行，含链接到 OPAC 检索 |
| 出版信息 | 出版事項 | HTML 表格行文本 |
| 形态 | 形態 | HTML 表格行文本 |
| 内容说明 | 内容等 | HTML 表格行文本 |
| 关键词 | キーワード | HTML 表格行文本 |
| 公开者 | 公開者 | HTML 表格行文本（固定为「早稲田大学図書館」） |

OPAC 链接格式（可从详情页提取）：
```
https://waseda.primo.exlibrisgroup.com/discovery/search?query=title,contains,{encoded_title}&vid=81SOKEI_WUNI:WINE
```

### 通过 IIIF Manifest 获取元数据

对于支持 IIIF 的资料，manifest.json 中的 `metadata` 数组包含结构化的元数据：
- `attribution`：固定为「早稲田大学図書館 (Waseda University Library)」
- `license`：`https://www.waseda.jp/library/user/using-images/`
- `metadata[]`：包含 Creator、Publisher、Date、Description、Notes 等字段
- `viewingDirection`：`right-to-left`（传统东亚阅读方向）

## 下载

### 方式一：直接下载 PDF（推荐，最简单）

从 archive 目录页获取 PDF 链接：
1. 访问 `https://archive.wul.waseda.ac.jp/kosho/{collection_code}/{item_id}/`
2. 解析页面获取每卷 PDF 链接
3. PDF URL 格式：`https://archive.wul.waseda.ac.jp/kosho/{collection_code}/{item_id}/{item_id}_{volume}/{item_id}_{volume}.pdf`

### 方式二：直接下载 JPG 图片

从卷册 HTML 页面解析图片链接：
1. 访问卷册 HTML 页：`https://archive.wul.waseda.ac.jp/kosho/{collection_code}/{item_id}/{item_id}_{volume}/{item_id}_{volume}.html`
2. 用正则提取图片链接：`href=["'](.+?)\.jpg["']\s+target="_blank">`
3. 构建完整图片 URL 下载

### 方式三：IIIF 下载（部分资料）

1. 获取 manifest：`https://iiif.archive.waseda.jp/iiif/manifest/ktnsk/{item_id}/manifest.json`
2. 解析 `sequences[0].canvases[]`
3. 每个 canvas 的图片 service：`images[0].resource.service.@id`
4. 拼接 IIIF Image API URL：`{service_id}/full/full/0/default.jpg`
5. IIIF Image API 支持 level1 compliance（支持 region、size、rotation 参数）

注意：
- 并非所有古典籍都有 IIIF manifest，搜索时可用 `cndtp=iiif` 筛选
- 多卷本的 IIIF manifest 可能只覆盖部分卷册，具体规则待确认
- IIIF 图片可获取原始分辨率（如 3456x5184）

### 方式四：bookget 工具

bookget 直接支持早稻田大学图书馆。输入 archive 目录页 URL 即可自动下载。

相关源码：
- https://github.com/deweizhu/bookget/blob/main/app/waseda.go

bookget 下载逻辑：
1. 解析 archive 目录页 HTML，用正则 `href=["'](.+?)\.html["']` 提取各卷 HTML 链接
2. 访问每卷 HTML 页，用正则 `(?i)href=["'](.+?)\.jpg["']\s+target="_blank">\d+</A>` 提取图片链接
3. 支持多线程并发下载（可配置线程数）
4. 按卷册创建子目录，图片按顺序编号（`0001.jpg`、`0002.jpg`...）
5. 支持断点续传（跳过已下载文件）

bookget 输入 URL 示例：
```
https://archive.wul.waseda.ac.jp/kosho/ri08/ri08_01899/
```

### 注意事项

- 无需特殊请求头（无 Referer 校验、无 Cookie 要求）
- 图片无水印
- 下载无需登录认证
- 部分大型 PDF 文件体积较大（可达 50MB+）
