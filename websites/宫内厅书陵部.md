# 宫内厅书陵部（宮内庁書陵部）

<!--
  本文件分两部分：
  - 分割线以上：用户文档，面向普通用户，语言简洁易懂，不含技术细节
  - 分割线以下：开发者文档，面向程序员，包含 API、HTML 解析、下载逻辑等技术细节
-->

日本宫内厅（皇室事务管理机构）下属的书陵部负责管理皇室传承的古典籍、古文书及公文档案。其数字化资源通过两个系统公开：一是官方的「書陵部所蔵資料目録・画像公開システム」，提供图书寮文库和宫内公文书馆两大馆藏的目录检索与图像浏览；二是庆应义塾大学代为建设的「宮内庁書陵部収蔵漢籍集覧」，专门收录书陵部所藏的汉籍（中国古典籍），并提供 IIIF 标准的全文影像。

- 官方系统：https://shoryobu.kunaicho.go.jp/
- 汉籍集览（庆应大学）：https://db2.sido.keio.ac.jp/kanseki/
- 分享协议：图像可免费浏览和下载，但二次利用（出版、网站刊载、放映等）需向宫内厅书陵部图书寮文庫提出申请；汉籍集览的书志数据著作权归宮内庁書陵部蔵漢籍研究会，引用时需注明出处
- 官方系统约 84,820 件资料（截至 2026 年 2 月），其中仅部分有数字化图像
- 资源类型：古典籍（和书、汉籍）、古文书、历史公文书、陵墓关联资料、照片帖等
- 官方系统不支持 IIIF 协议（使用专有查看器）
- 汉籍集览支持 IIIF 协议，可使用 [bookget](https://github.com/deweizhu/bookget) 等工具下载

## 搜索与浏览

### 官方系统（shoryobu.kunaicho.go.jp）

该系统包含三个馆藏分区，各自独立检索：

1. **图书寮文库**（図書寮文庫）：皇室历代传承的古典籍和古文书
   - 搜索页面：https://shoryobu.kunaicho.go.jp/Toshoryo
2. **宫内公文书馆**（宮内公文書館）：宫内省/宫内厅的行政公文档案
   - 搜索页面：https://shoryobu.kunaicho.go.jp/Kobunsho
3. **陵墓课**（陵墓課）：天皇陵墓相关资料
   - 搜索页面：https://shoryobu.kunaicho.go.jp/Ryobo

搜索方式：
- 自由检索：输入关键词，可选择"全部包含"、"任意包含"或"排除"
- 高级检索（详細検索）：按题名、题名读音、函架番号、著者、刊写信息、所属家等字段组合检索
- 分类浏览：按约 30 个大类（文学、历史、宗教、法制、艺术、地理等）层级浏览
- 可筛选"仅有图像的资料"
- 无需注册登录

### 汉籍集览（db2.sido.keio.ac.jp/kanseki）

- 搜索页面：https://db2.sido.keio.ac.jp/kanseki/T_bib_search.php
- 提供"目录检索"和"书志检索"两种模式
- 可按题目、异名、著者、刊写、工名、传来、印文、函架番号等字段检索
- 可按经、史、子、集等四部分类浏览
- 无需注册登录

## 每本书能看到什么

### 官方系统

| 字段 | 说明 | 示例 |
|------|------|------|
| 資料名（题名） | 书名 | 源氏物語（青表紙本系） |
| 函架番号 | 馆藏编号 | 553・10 |
| 枝番号 | 分册编号 | 0000 |
| 分類 | 所属分类 | 232 文学 > 日本文学 > 物語・説話集 |
| 著者 | 作者/编者 | 紫式部 |
| 書写者/校合者 | 抄写人/校勘人 | 近衛政家、三条西実隆 |
| 刊写 | 刊本或写本 | 寄合書（合写本） |
| 数量 | 册数 | 60巻 |
| マイクロ | 缩微胶卷信息 | 11組42リール |

- 可在线翻阅高清图像（专有查看器，支持缩放、旋转、全屏）
- 可下载单页图像（查看器内提供下载按钮）
- 无全文文字（OCR）
- 无 PDF 整本下载

### 汉籍集览

| 字段 | 说明 | 示例 |
|------|------|------|
| 題目 | 书名 | 周易 |
| 異名 | 别名 | 待确认 |
| 著者 | 作者 | 待确认 |
| 刊写 | 刊本/写本 | 待确认 |
| 工名 | 刻工名 | 待确认 |
| 伝来 | 传承来源 | 待确认 |
| 印文 | 藏书印内容 | 待确认 |
| 函架番号 | 馆藏编号 | 待确认 |
| 部・類 | 四部分类 | 经部・易類 |

- 可在线翻阅全文影像（IIIF 查看器）
- 书志数据可自由引用（需注明出处）

## 示例

### 官方系统
- 详情页（源氏物語）：https://shoryobu.kunaicho.go.jp/Toshoryo/Detail/1000629260000
- 阅读页（源氏物語第47帖）：https://shoryobu.kunaicho.go.jp/Toshoryo/Viewer/1000629260047/5356c94e3bab46f4839bce4fcefb696d
- 晴富卿记详情页：https://shoryobu.kunaicho.go.jp/Toshoryo/Detail/1000134960005

### 汉籍集览
- 书志详情页：https://db2.sido.keio.ac.jp/kanseki/bib_frame?id=006754
- 全文影像浏览：https://db2.sido.keio.ac.jp/kanseki/bib_image?id=006754
- 检索页面：https://db2.sido.keio.ac.jp/kanseki/T_bib_search.php

---

# 开发者文档

本网站实际上由两套独立系统组成，技术架构完全不同：

1. **官方系统**（shoryobu.kunaicho.go.jp）：ASP.NET MVC 应用，使用专有图像查看器，不支持 IIIF
2. **汉籍集览**（db2.sido.keio.ac.jp/kanseki）：PHP 应用，支持 IIIF，bookget 已支持

## URL 结构

### 官方系统（shoryobu.kunaicho.go.jp）

#### 首页 / 分区入口
```
https://shoryobu.kunaicho.go.jp/                    # 首页
https://shoryobu.kunaicho.go.jp/Toshoryo             # 图书寮文库
https://shoryobu.kunaicho.go.jp/Kobunsho             # 宫内公文书馆
https://shoryobu.kunaicho.go.jp/Ryobo                # 陵墓课
```

#### 详情页
```
https://shoryobu.kunaicho.go.jp/Toshoryo/Detail/{item_id}
https://shoryobu.kunaicho.go.jp/Kobunsho/Detail/{item_id}
```
- `item_id`：13位数字编号，如 `1000629260000`
- 作品级 ID 末尾通常为 `0000`，分册级 ID 末尾为序号（如 `0001`、`0047`）

#### 图像查看器
```
https://shoryobu.kunaicho.go.jp/Toshoryo/Viewer/{item_id}/{image_set_id}
```
- `item_id`：同上，13位数字编号
- `image_set_id`：32位十六进制 GUID，如 `5356c94e3bab46f4839bce4fcefb696d`

#### 缩略图
```
https://shoryobu.kunaicho.go.jp/Toshoryo/Thumbnail/{image_set_id}/{image_id}.jpg
```
- `image_set_id`：32位 GUID
- `image_id`：32位 GUID

#### 搜索结果（带参数的详情页）
```
https://shoryobu.kunaicho.go.jp/Toshoryo/Detail/{item_id}?index={n}&sort=Title&searchtype=Freeword
```

#### 画廊
```
https://shoryobu.kunaicho.go.jp/Gallery/{gallery_id}?start={offset}&rows={count}
```

#### 发行物 / PDF
```
https://shoryobu.kunaicho.go.jp/Publication/{category}/{pub_id}/{file_id}
https://shoryobu.kunaicho.go.jp/Publication/PDF/{category}/{filename}.pdf
```

### 汉籍集览（db2.sido.keio.ac.jp/kanseki）

#### 书志详情页
```
https://db2.sido.keio.ac.jp/kanseki/bib_frame?id={book_id}
```
- `book_id`：6位数字编号，如 `006754`

#### 全文影像页
```
https://db2.sido.keio.ac.jp/kanseki/bib_image?id={book_id}
```

#### IIIF Manifest
```
https://db2.sido.keio.ac.jp/iiif/manifests/kanseki/{book_id}/{book_id}-{vol_id}/manifest.json
```
- `book_id`：如 `007387`
- `vol_id`：3位或4位零填充卷号，如 `001`、`0001`
- 卷号是否为4位取决于页面中隐藏字段 `isFolid4Digit` 的值

#### 检索页
```
https://db2.sido.keio.ac.jp/kanseki/T_bib_search.php      # 书志检索
https://db2.sido.keio.ac.jp/kanseki/search_bib_result      # 分类检索结果
```

## 搜索 API

### 官方系统

待确认。官方系统为传统服务端渲染页面（ASP.NET MVC），搜索通过表单 POST 提交。未发现公开的 JSON API。搜索参数包括：

- `searchType`：`Freeword`（自由检索）或 `Advanced`（高级检索）
- `title`：题名
- `titleReading`：题名读音
- `author`：著者
- 其他字段待确认

### 汉籍集览

无公开的 JSON 搜索 API。检索通过 PHP 表单提交（`T_bib_search.php`），返回 HTML 结果页面。

## 元数据获取

### 官方系统

服务端渲染 HTML 页面。元数据嵌入在详情页 HTML 中，需 HTML 解析提取。具体的 CSS 选择器和 HTML 结构待确认（需使用浏览器开发者工具进一步分析）。

### 汉籍集览

书志详情页（`bib_frame?id=`）和全文影像页（`bib_image?id=`）均为服务端渲染 HTML。IIIF manifest 中也包含部分元数据。

#### 从 IIIF manifest 获取元数据

manifest 文件位于：
```
https://db2.sido.keio.ac.jp/iiif/manifests/kanseki/{book_id}/{book_id}-{vol_id}/manifest.json
```
manifest 遵循 IIIF Presentation API v2 格式，`metadata` 数组中包含书志字段。

### 字段映射

#### 官方系统（HTML 解析）

| 中文字段 | 提取方式 |
|---------|---------|
| 题名 | 待确认（HTML 页面解析） |
| 函架番号 | 待确认 |
| 著者 | 待确认 |
| 分类 | 待确认 |
| 刊写 | 待确认 |
| 数量 | 待确认 |

#### 汉籍集览（IIIF manifest）

| 中文字段 | 提取方式 |
|---------|---------|
| 题目 | manifest `label` 字段 |
| 其他元数据 | manifest `metadata` 数组中的键值对 |

## 下载

### 官方系统（shoryobu.kunaicho.go.jp）

**不支持 IIIF。** 使用专有图像查看器。

图像查看方式：
- 查看器页面地址：`/Toshoryo/Viewer/{item_id}/{image_set_id}`
- 查看器内建下载按钮，可逐页下载图像
- 缩略图地址：`/Toshoryo/Thumbnail/{image_set_id}/{image_id}.jpg`

图像保护措施：
- 使用专有 JavaScript 查看器（非标准的 OpenSeadragon/Mirador）
- 高清图像通过查看器动态加载，具体的瓦片（tile）加载机制待确认
- 无 Referer 校验（待确认）
- 无明显水印

bookget 不支持此系统。如需批量获取，需进一步逆向分析查看器的网络请求，确定图像瓦片或原图的 URL 规则。

### 汉籍集览（db2.sido.keio.ac.jp/kanseki）

**支持 IIIF Presentation API v2 + Image API。**

从 manifest 到图片的完整流程：

1. 访问书志页面 `bib_frame?id={book_id}`，解析页面中的 `data-folid` 属性获取各卷号
2. 检查隐藏字段 `isFolid4Digit` 确定卷号位数（3位或4位）
3. 构造 manifest URL：
   ```
   https://db2.sido.keio.ac.jp/iiif/manifests/kanseki/{book_id}/{book_id}-{vol_id}/manifest.json
   ```
4. 解析 manifest 中 `sequences[0].canvases[].images[].resource.service.@id` 获取 IIIF Image API 的 service ID
5. 拼接图片 URL：
   - 普通 JPEG：`{service_id}/{region}/{size}/{rotation}/{quality}.{format}`
   - 默认格式：`{service_id}/full/full/0/default.jpg`
   - info.json（用于 dezoomify-rs 高清下载）：`{service_id}/info.json`

manifest URL 示例：
```
https://db2.sido.keio.ac.jp/iiif/manifests/kanseki/007387/007387-001/manifest.json
```

必需的 HTTP 请求头：
- `Referer`：需设置为经过 URL 编码的请求页面地址
- `User-Agent`：需设置标准浏览器 UA

### bookget 支持

bookget 已支持汉籍集览系统。相关源码：
- 路由注册：`Router["db2.sido.keio.ac.jp"] = app.NewKeio()`
- 下载逻辑：https://github.com/deweizhu/bookget/blob/main/app/keio.go

使用方法：
```bash
bookget "https://db2.sido.keio.ac.jp/kanseki/bib_frame?id=006754"
```

关键实现细节（来自源码分析）：
- 从 `bib_frame` 页面提取 `data-folid` 列表和 `isFolid4Digit` 标志
- 卷号格式：`{book_id}-{zero_padded_vol_id}`（3位或4位零填充）
- 支持两种下载模式：
  - 普通模式：直接下载 JPEG（`{service_id}/{format}`）
  - DZI 模式（`UseDzi=true`）：通过 dezoomify-rs 下载高清瓦片并拼合
- DZI 模式需设置 `Origin` 和 `Referer` 头
