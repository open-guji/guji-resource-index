# 普林斯顿大学图书馆 - East Asian Library

<!--
  本文件分两部分：
  - 分割线以上：用户文档，面向普通用户，语言简洁易懂，不含技术细节
  - 分割线以下：开发者文档，面向程序员，包含 API、HTML 解析、下载逻辑等技术细节
-->

普林斯顿大学东亚图书馆（East Asian Library and the Gest Collection）的数字化项目，托管于 Digital PUL（Princeton University Library 数字馆藏平台）。该馆的盖斯特（Gest）中文善本收藏是北美最重要的中文古籍收藏之一，以明版书和传统中医典籍见长。原始盖斯特收藏约 100,000 卷（册），其中 40% 为手稿、早期印本和善本，仅明版书即达 24,000 卷。

- 网站链接：https://dpul.princeton.edu/eastasian
- 主目录：https://catalog.princeton.edu/
- 善本目录：https://gest.princeton.edu/rarebook.htm
- 分享协议：待确认（页面未明确标注统一协议）
- 约 560 件数字化藏品（东亚图书馆专题），其中中文约 520 件
- 资源类型：善本、手稿、地图、画册、卷轴、拓片、甲骨文、敦煌写本
- 支持 IIIF 协议，可使用 [bookget](https://github.com/deweizhu/bookget) 等工具下载

## 搜索与浏览

Digital PUL 东亚专题提供搜索和分面浏览功能：

- 搜索页面：https://dpul.princeton.edu/eastasian
- 在页面顶部搜索框输入关键词即可搜索，支持中英文
- 搜索结果可按以下维度筛选：展品标签（Exhibit Tags）、著者（Creator）、主题（Subject）、语种（Language）、年代（Date）
- 无需注册登录，全部内容公开访问

此外，还可通过以下方式查找中文善本：
- 普林斯顿大学主目录 https://catalog.princeton.edu/ 搜索，馆藏位置标注为「Special Collections - East Asian Library Rare Books」的即为善本
- 中文善本专用目录 https://gest.princeton.edu/rarebook.htm 可按著者、善本分类浏览

### 子集/专题

| 专题名 | 数量 | 说明 |
|--------|------|------|
| All Exhibit Items | 约 560 件 | 全部数字化展品 |
| Scrolls | 10 件 | 卷轴 |
| Ephemera | 2 件 | 临时性印刷品 |
| Block Prints of the Chinese Revolution | 1 件 | 中国革命木版画 |
| Microfilms | 631 件 | 缩微胶卷 |

## 每本书能看到什么

打开一本书的详情页，可以看到：

| 字段 | 说明 | 示例 |
|------|------|------|
| Title | 题名 | 本草綱目 |
| Creator | 著者 | Li, Shizhen, 1518-1593 |
| Date | 年代 | 1655 |
| Language | 语种 | Chinese |
| Subject | 主题分类 | Chinese Medicine |
| Extent | 册数/形制 | 12 v. |
| Description | 描述 | Ming dynasty edition |
| Collection | 所属集合 | Treasures of the East Asian Library |
| Rights | 权利声明 | 待确认 |

每件藏品都提供 IIIF 查看器（Universal Viewer）在线翻阅，页面左下角有 IIIF 图标，可点击获取 IIIF manifest 链接。

- 不提供直接 PDF 下载
- 不提供全文文字（OCR）

## 示例

- 东亚馆藏数字展品总览：https://dpul.princeton.edu/eastasian
- 主目录详情页示例：https://catalog.princeton.edu/catalog/9940468523506421
- DPUL 详情页示例：https://dpul.princeton.edu/catalog/99915a8b423b596e47540e3feeee19b8
- IIIF Manifest 示例：https://figgy.princeton.edu/concern/scanned_resources/b7b38129-0454-4167-9211-6706b95e1c33/manifest

---

# 开发者文档

## 系统架构

普林斯顿数字图书馆由多个系统协同工作：

| 系统 | 域名 | 功能 |
|------|------|------|
| Digital PUL (DPUL) | dpul.princeton.edu | 面向用户的数字馆藏展示，基于 Spotlight/Blacklight |
| Orangelight | catalog.princeton.edu | 主馆藏目录（Blacklight） |
| Figgy | figgy.princeton.edu | 数字资产管理系统，提供 IIIF manifest 和 GraphQL API |
| IIIF Image Server | iiif.princeton.edu/loris/ | Loris IIIF 图片服务 |

技术栈：Ruby on Rails + Blacklight/Spotlight + Solr + PostgreSQL + Redis + RabbitMQ

## URL 结构

### DPUL 详情页
```
https://dpul.princeton.edu/catalog/{resource_id}
```
- `resource_id`：资源 ID，如 `99915a8b423b596e47540e3feeee19b8`

### 主目录详情页
```
https://catalog.princeton.edu/catalog/{bib_id}
```
- `bib_id`：书目记录 ID，如 `9940468523506421`

### IIIF Manifest（Figgy）
```
https://figgy.princeton.edu/concern/scanned_resources/{figgy_id}/manifest
```
- `figgy_id`：Figgy 内部资源 UUID，如 `b7b38129-0454-4167-9211-6706b95e1c33`

### IIIF 图片（Loris）
```
https://iiif.princeton.edu/loris/{image_id}/full/full/0/default.jpg
```

## 搜索 API

### DPUL 搜索（Blacklight JSON API）

DPUL 基于 Blacklight/Spotlight，理论上支持在 URL 末尾加 `.json` 获取 JSON 响应：

```
GET https://dpul.princeton.edu/catalog.json?q={关键词}&per_page=10&page=1
```

注意：DPUL 已部署 Cloudflare Turnstile 防护，程序化访问可能被拦截。

### Allsearch API

普林斯顿大学提供统一搜索 API（Allsearch），含 DPUL 数字馆藏搜索：

```
GET https://allsearch-api.princeton.edu/search/dpul?query={关键词}
```

**响应结构：**
```json
{
  "number": 42,
  "records": [
    {
      "title": "...",
      "creator": "...",
      "publisher": "...",
      "id": "...",
      "type": "Book",
      "url": "https://dpul.princeton.edu/catalog/...",
      "collection": "Treasures of the East Asian Library"
    }
  ],
  "more": "https://dpul.princeton.edu/catalog?q=..."
}
```

其他可用的 Allsearch 端点：
- `/search/catalog` — 搜索主目录（catalog.princeton.edu）
- `/search/dpul` — 搜索数字馆藏（dpul.princeton.edu）
- `/search/pulmap` — 搜索地图资源

API 文档：https://allsearch-api.princeton.edu/api-docs/index.html

### Figgy GraphQL API

Figgy 提供 GraphQL API，可通过主目录的书目 ID 查询 IIIF manifest URL：

```
POST https://figgy.princeton.edu/graphql
Content-Type: application/json

{
  "query": "query { resource(id: \"{bib_id}\") { ... on ScannedResource { manifestUrl } ... on ScannedMap { manifestUrl } } }",
  "variables": { "id": "{bib_id}" }
}
```

bookget 中的实际用法：从 `catalog.princeton.edu/catalog/{bib_id}` 提取 bib_id（正则 `catalog/([A-z\d]+)`），然后查询 Figgy GraphQL 获取 `manifestUrl`。

## 元数据获取

### 方式一：Allsearch API
最简便的方式，直接返回 JSON，包含 title、creator、publisher、type、url、collection 等基本字段。

### 方式二：DPUL Blacklight JSON
在详情页 URL 后加 `.json` 获取完整元数据（可能被 Cloudflare 拦截）：
```
GET https://dpul.princeton.edu/catalog/{resource_id}.json
```

### 方式三：DPUL HTML 解析
DPUL 基于 Blacklight，元数据位于详情页 HTML 中，但受 Cloudflare 防护。若可访问，元数据在标准 Blacklight `<dl>` 结构中。

### 方式四：Figgy GraphQL
可获取最详细的元数据和 IIIF manifest URL。

### 字段映射

| 中文字段 | Allsearch JSON 路径 | 说明 |
|---------|---------------------|------|
| 题名 | `records[].title` | 书名 |
| 著者 | `records[].creator` | 作者 |
| 出版者 | `records[].publisher` | 出版者 |
| 类型 | `records[].type` | 资源类型（Book 等） |
| 馆藏集合 | `records[].collection` | 所属专题集合 |
| 详情链接 | `records[].url` | DPUL 详情页 URL |

## 下载

### IIIF 下载

支持 **IIIF Presentation API 2.0**（部分资源可能为 v3）和 **IIIF Image API**。

**获取 Manifest 的方式：**

1. **从 DPUL 页面**：阅读页面左下角有 IIIF 图标，点击可获取 manifest URL
2. **从 DPUL HTML**：正则匹配 `manifest=(.+?)&` 提取 manifest URL
3. **从主目录（catalog.princeton.edu）**：通过 Figgy GraphQL 查询 manifestUrl
4. **直接构造**：`https://figgy.princeton.edu/concern/scanned_resources/{figgy_id}/manifest`

**Manifest 结构（IIIF v2）：**
```json
{
  "@context": "http://iiif.io/api/presentation/2/context.json",
  "@type": "sc:Manifest",
  "sequences": [{
    "canvases": [{
      "images": [{
        "resource": {
          "service": {
            "@id": "https://iiif.princeton.edu/loris/...",
            "profile": "http://iiif.io/api/image/2/level2.json"
          }
        }
      }]
    }]
  }]
}
```

**图片下载：**
从 manifest 提取每个 canvas 的 `images[].resource.service.@id`（即 IIIF Image Service ID），拼接 IIIF Image API 参数：
```
{service_id}/full/full/0/default.jpg     # 完整尺寸
{service_id}/full/1024,/0/default.jpg    # 限宽 1024
{service_id}/info.json                    # 图片信息（dezoomify 用）
```

### bookget 支持

bookget 通过 `app/princeton.go` 支持普林斯顿大学图书馆，已注册的域名：
- `catalog.princeton.edu`
- `dpul.princeton.edu`

**关键逻辑：**
1. **DPUL 路径**：从 HTML 中用正则 `manifest=(.+?)&` 提取 manifest URL
2. **主目录路径**：从 URL 中提取 bib_id（正则 `catalog/([A-z\d]+)`），查询 Figgy GraphQL 获取 manifest URL
3. 解析 manifest，判断是否包含多卷（子 manifest）
4. 遍历 canvas → 提取 `resource.service.@id` → 拼接格式参数下载
5. 支持 dezoomify 高清下载（通过 `info.json`）
6. 支持 IIIF v2 和 v3 两种 manifest 格式

**相关源码：**
- https://github.com/deweizhu/bookget/blob/main/app/princeton.go
- https://github.com/deweizhu/bookget/blob/main/app/iiif.go

### 关键域名

| 域名 | 用途 |
|------|------|
| `dpul.princeton.edu` | 数字馆藏展示平台（Spotlight/Blacklight） |
| `catalog.princeton.edu` | 主馆藏目录（Orangelight/Blacklight） |
| `figgy.princeton.edu` | 数字资产管理 + GraphQL API + IIIF Manifest |
| `iiif.princeton.edu/loris/` | Loris IIIF 图片服务器 |
| `allsearch-api.princeton.edu` | 统一搜索 API |

### 注意事项

- DPUL 已部署 **Cloudflare Turnstile** 验证，自动化访问可能被拦截
- 建议优先使用 Allsearch API 或 Figgy GraphQL 获取数据，避免直接爬取 DPUL 页面
- 图片下载走 IIIF 标准协议，无需额外认证
- 部分资源可能有访问限制（如敦煌写本等特殊藏品）
