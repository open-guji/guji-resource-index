# 大英图书馆（British Library）

<!--
  本文件分两部分：
  - 分割线以上：用户文档，面向普通用户，语言简洁易懂，不含技术细节
  - 分割线以下：开发者文档，面向程序员，包含 API、HTML 解析、下载逻辑等技术细节
-->

大英图书馆（British Library）是英国的国家图书馆，位于伦敦，藏有大量东方手稿和珍贵文献。其数字化馆藏包括中文手稿、敦煌文献、古地图、拓片等，通过在线平台向全球用户开放浏览。大英图书馆同时主持"国际敦煌项目"（IDP），提供丝绸之路出土文献的数字化检索与浏览。

- 网站链接：https://www.bl.uk/
- 手稿阅读器：http://www.bl.uk/manuscripts/
- 国际敦煌项目（IDP）：https://idp.bl.uk/
- 档案与手稿目录：https://searcharchives.bl.uk/
- 分享协议：大部分数字化图像供学术研究和个人学习使用，具体条款见 [使用条款](https://www.bl.uk/about-us/terms-and-conditions)
- 中文相关藏品规模：超过 10 万册中文印刷书籍、约 2,500 种期刊、大量中文手稿及敦煌文献
- 资源类型：手稿、敦煌写卷、古地图、拓片、印刷古籍
- 支持 IIIF 协议，可使用 [bookget](https://github.com/deweizhu/bookget) 等工具下载

## 搜索与浏览

大英图书馆的中文古籍资源分散在多个平台，主要有以下入口：

### 1. 档案与手稿目录（Archives and Manuscripts Catalogue）

- 搜索页面：https://searcharchives.bl.uk/
- 支持全文搜索、按馆藏号（shelfmark）搜索、按题名搜索
- 搜索结果可按以下维度筛选：
  - 馆藏类别（Collection Area）：如 Oriental Manuscripts（东方手稿）
  - 语言（Language）：可选中文等
  - 主题（Subject）
  - 人名（Name）
  - 地点（Place）
  - 资料类型（Material Type）
  - 是否有数字化内容（Digitised content → 选 "Yes (available)"）
- 无需注册登录

### 2. 手稿阅读器（Digitised Manuscripts Viewer）

- 入口：http://www.bl.uk/manuscripts/
- 可直接通过馆藏号（如 Or 8210/P.2）打开对应手稿
- 提供逐页浏览功能
- 注意：2023 年大英图书馆遭受网络攻击后，部分数字化内容可能暂时不可用

### 3. 国际敦煌项目（IDP）

- 搜索页面：https://idp.bl.uk/collection/
- 高级搜索：https://idp.bl.uk/collection/#advanced
- 可按"有图片"筛选、按馆藏号搜索
- 收录来自全球 35 家合作机构的敦煌及丝绸之路文献
- 大部分为中文写本，也包含梵文、藏文、回鹘文等 15 种以上语言文字
- 无需注册登录

## 每本书能看到什么

### 手稿阅读器 / 档案目录中的元数据

| 字段 | 说明 | 示例 |
|------|------|------|
| Title | 题名 | Diamond Sutra |
| Shelfmark | 馆藏号 | Or 8210/P.2 |
| Date | 年代 | 868 CE |
| Language | 语言 | Chinese |
| Collection Area | 馆藏类别 | Oriental Manuscripts |
| Description | 内容描述 | The world's earliest dated printed book |
| Material Type | 资料类型 | Manuscript / Printed text |
| Subject | 主题 | Buddhism |
| Place | 相关地点 | Dunhuang |
| Provenance | 来源 | Stein Collection |

- 可在线逐页翻阅高清图片
- 新平台使用 IIIF 通用查看器（Universal Viewer）浏览
- 旧手稿阅读器使用 Deep Zoom 技术浏览
- 无 PDF 直接下载功能
- 无全文 OCR 文字

## 示例

- 金刚经（世界现存最早有明确日期的印刷品，868年）：
  - 旧阅读器：http://www.bl.uk/manuscripts/Viewer.aspx?ref=or_8210/p.2
  - 详情页：http://www.bl.uk/manuscripts/FullDisplay.aspx?ref=Or_8210/P.2
- IDP 检索页面：https://idp.bl.uk/collection/
- 档案目录检索示例：https://searcharchives.bl.uk/?f%5Bcollection_area_ssim%5D%5B%5D=Oriental+Manuscripts
- 新 IIIF 查看器示例：https://iiif.bl.uk/uv/#?manifest=https://bl.digirati.io/iiif/ark:/81055/vdc_100104060212.0x000001

---

# 开发者文档

## URL 结构

### 旧手稿阅读器

#### 详情页
```
http://www.bl.uk/manuscripts/FullDisplay.aspx?ref={shelfmark}
```
- `shelfmark`：馆藏号，如 `Or_8210/P.2`，空格用下划线替代

#### 阅读页
```
http://www.bl.uk/manuscripts/Viewer.aspx?ref={shelfmark_with_folio}
```
- `shelfmark_with_folio`：馆藏号加卷页标识，如 `or_8210/p.2` 或 `or_6814!1_fs001r`
- 注意：此处馆藏号使用小写，`!` 分隔不同部分

### 新 IIIF 查看器

#### 查看器页面
```
https://iiif.bl.uk/uv/#?manifest=https://bl.digirati.io/iiif/ark:/81055/{ark_id}
```
- `ark_id`：ARK 标识符，如 `vdc_100104060212.0x000001`

#### IIIF Manifest
```
https://api.bl.uk/metadata/iiif/ark:/81055/{ark_id}/manifest.json
```
- `ark_id`：同上
- 获取方式：在查看器中点击 "share" 链接，右键 IIIF 图标复制链接
- 链接中 `?` 后的查询参数可去掉

### 档案与手稿目录

#### 搜索
```
https://searcharchives.bl.uk/?q={keyword}
```

#### 筛选搜索
```
https://searcharchives.bl.uk/?f[{facet_name}][]={value}
```
- 常用 facet：
  - `collection_area_ssim`：馆藏类别（如 `Oriental+Manuscripts`）
  - `language_ssim`：语言
  - `digitized_bsi`：是否数字化（`true`）

### 国际敦煌项目（IDP）

#### 搜索页面
```
https://idp.bl.uk/collection/
```

#### 高级搜索
```
https://idp.bl.uk/collection/#advanced
```

## 搜索 API

### 档案与手稿目录

目录基于 Blacklight/Solr 框架，支持在 URL 末尾加 `.json` 获取 JSON 格式结果（待确认，需实际测试）。

常规搜索参数：
- `q`：搜索关键词
- `f[facet_name][]`：筛选条件
- `page`：分页

### IDP 搜索 API

IDP 网站为 SPA 应用，后端 API 待确认。

## 元数据获取

### 旧手稿阅读器

旧手稿阅读器（`www.bl.uk/manuscripts/`）为传统服务端渲染页面。

- `FullDisplay.aspx` 页面包含元数据字段
- 具体 HTML 结构待确认（受网络攻击影响，页面可能有变化）

### 新 IIIF 平台

通过 IIIF Manifest JSON 获取元数据：

```
GET https://api.bl.uk/metadata/iiif/ark:/81055/{ark_id}/manifest.json
```

返回标准 IIIF Presentation API 3.0 格式的 JSON，包含：
- `label`：题名
- `metadata`：元数据数组，每项含 `label` 和 `value`
- `sequences[].canvases[]`：页面列表，每页含图片资源

### 字段映射

| 中文字段 | 提取方式 |
|---------|---------|
| 题名 | IIIF Manifest → `label` |
| 馆藏号 | IIIF Manifest → `metadata` 中 label 为 "Shelfmark" 的项 |
| 年代 | IIIF Manifest → `metadata` 中 label 为 "Date" 的项 |
| 语言 | IIIF Manifest → `metadata` 中 label 为 "Language" 的项 |
| 来源 | IIIF Manifest → `metadata` 中 label 为 "Provenance" 的项 |

## 下载

### IIIF 方式（新平台）

1. **获取 Manifest**：
   ```
   GET https://api.bl.uk/metadata/iiif/ark:/81055/{ark_id}/manifest.json
   ```

2. **从 Manifest 中提取图片**：
   - 遍历 `sequences[0].canvases[]`
   - 每个 canvas 的 `images[0].resource.service["@id"]` 为 IIIF Image API 的 service ID
   - 拼接完整图片 URL：`{service_id}/full/max/0/default.jpg`

3. **IIIF Image API 格式**：
   ```
   {service_id}/{region}/{size}/{rotation}/{quality}.{format}
   ```
   - 下载最大尺寸：`/full/max/0/default.jpg`
   - 下载指定宽度：`/full/{width},/0/default.jpg`

### bookget 方式（旧手稿阅读器）

bookget 支持旧版手稿阅读器（`www.bl.uk/manuscripts/`）的下载。

- 源码：https://github.com/deweizhu/bookget/blob/main/app/bluk.go
- 支持的 URL 格式：
  ```
  http://www.bl.uk/manuscripts/Viewer.aspx?ref=or_8210/p.2
  ```

#### 下载流程（基于 bookget 源码分析）

1. **解析馆藏号**：从 URL 参数 `ref` 中提取馆藏号标识，正则：`Viewer.aspx\?ref=([\S]+)`

2. **获取页面列表**：
   - 访问 Viewer.aspx 页面
   - 解析 HTML 中隐藏的表单字段 `PageList`（`<input>` 元素）
   - 该字段的值为管道符 `|` 分隔的页面标识列表
   - 过滤掉分隔符 `##`

3. **构造图片 URL**：
   - 使用 DZI（Deep Zoom Image）代理接口：
     ```
     http://www.bl.uk/manuscripts/Proxy.ashx?view={canvas_id}.xml
     ```
   - `canvas_id` 为从 PageList 中提取的每个页面标识

4. **下载图片**：
   - 使用 `dezoomify-rs` 工具解析 DZI XML 并拼合瓦片图像（Deep Zoom 方式）
   - 或直接 HTTP 下载（普通方式）

#### 必需的 HTTP 请求头

| 请求头 | 值 | 说明 |
|--------|-----|------|
| User-Agent | 自定义 | 需设置合理的浏览器 UA |
| Referer | URL 编码后的来源页面 | 需要正确的 Referer |
| Origin | `http://www.bl.uk` | dezoomify 下载时需要 |
| Cookie | 可选，通过 cookie 文件传入 | 用于保持会话 |

### 注意事项

- 2023 年底大英图书馆遭受网络攻击，部分旧平台服务中断或迁移，旧手稿阅读器的可用性需实际测试
- 新平台逐步迁移到 IIIF 标准，建议优先使用 IIIF Manifest 方式
- Google 扫描的印刷书籍不支持 IIIF 分享功能
- IDP（敦煌项目）为独立平台，下载方式与主站不同，待确认
