# 東京国立博物館

东京国立博物馆拥有两套独立的数字资源系统：一是"研究情報アーカイブズ"（Research Information Archives），包含数字图书馆（デジタルライブラリー）和图像搜索（画像検索）；二是通过国立文化财机构的 ColBase 统合检索系统提供馆藏文物图像。本文档主要记录数字图书馆及 ColBase 两个平台。

- 数字图书馆：https://webarchives.tnm.jp/dlib/
- 图像搜索：https://webarchives.tnm.jp/imgsearch/
- ColBase（统合检索）：https://colbase.nich.go.jp/
- E国宝（国宝/重要文化财高清）：参见 [E国宝文档](E国宝.md)
- 分享协议：数字图书馆的图像可免费用于非商业目的（需满足利用条件）；商业利用需通过"TNM Image Archives"申请
- 数字图书馆收录：2,924 种、5,698 册（和书、洋书、汉籍）
- ColBase 总数：约 14 万件（含四馆一研究所）
- 资源类型：和古书（日本古籍）、汉籍（中国古籍）、洋书（西方古籍）、文物图像、历史照片、古地图
- 不支持 IIIF 协议（数字图书馆使用 Zoomify 分块加载方式）
- ColBase/E国宝 支持 IIIF 协议（参见 [E国宝文档](E国宝.md)）

## 数字图书馆（デジタルライブラリー）

### 搜索与浏览

- 搜索页面：https://webarchives.tnm.jp/dlib/
- 支持按关键词、题名、著者名搜索
- 可按资源类型筛选：和书、洋书、汉籍
- 可仅显示有插图的资料
- 无需注册登录

### 每本书能看到什么

| 字段 | 说明 | 示例 |
|------|------|------|
| 資料番号 | 馆藏编号 | 052-4-15 |
| 資料名 | 书名 | 傷寒論 |
| 著者等 | 作者/编者 | (漢)張仲景 撰 (日)外神重宏 和解 |
| 出版地 | 出版地点 | 京都 |
| 出版者 | 出版机构 | 書肆屋則八 |
| 時代 | 年代 | 安政4年[1857] |
| 員数 | 册数 | 1冊 |
| 寸法 | 尺寸 | 26cm |
| 形状 | 装帧形式 | 和綴 |
| 一般注記 | 备注 | 含"江戸医学館"印记 |

- 配有 Leaflet + Zoomify 深度缩放图像查看器，支持缩放和拖拽
- 支持缩略图导航和页面滑块
- 支持键盘快捷键操作（首页/上一页/下一页/末页）
- 可打印图片
- 无 PDF 下载
- 无全文文字（OCR）

### 示例

- 数字图书馆详情页：https://webarchives.tnm.jp/dlib/detail/615
- 数字图书馆检索：https://webarchives.tnm.jp/dlib/search

## ColBase

ColBase 是国立文化财机构的馆藏统合检索系统，收录东京、京都、奈良、九州四座国立博物馆及奈良文化财研究所等机构的馆藏。

- 搜索页面：https://colbase.nich.go.jp/
- 支持多语言（日语、英语、中文、韩语）
- 可按名称、时代、分类、指定等级（国宝/重要文化财）等筛选
- 图像可免费下载使用（需注明来源）
- 无需注册登录

ColBase 的技术细节详见 [E国宝文档](E国宝.md)，两者同属国立文化财机构体系。

---

# 开发者文档

## URL 结构

### 数字图书馆 - 详情页
```
https://webarchives.tnm.jp/dlib/detail/{book_id}
```
- `book_id`：数字标识符，如 `615`

### 数字图书馆 - 搜索页
```
https://webarchives.tnm.jp/dlib/search
```

### 图像搜索
```
https://webarchives.tnm.jp/imgsearch/
https://webarchives.tnm.jp/imgsearch/advancedSearch    # 高级搜索
https://webarchives.tnm.jp/imgsearch/search?invnum=A-  # 按收藏编号搜索
```

### ColBase - 作品页
```
https://colbase.nich.go.jp/collection_items/{institution}/{item_id}?locale={lang}
```
- `institution`：机构代码，如 `tnm`（东京国立博物馆）
- `item_id`：收藏编号，如 `TB-1568`
- `locale`：语言代码，如 `ja`、`en`、`zh`

## 搜索 API

### 数字图书馆
数字图书馆搜索为服务端渲染，搜索结果在 HTML 中返回，无公开 JSON API。

### ColBase
ColBase 为 Nuxt.js SPA 应用，页面内容通过 JavaScript 动态加载。WebFetch 无法直接抓取渲染后的内容。具体后端 API 端点待进一步逆向分析。

## 元数据获取

### 数字图书馆

详情页为服务端渲染的 HTML，元数据以表格形式展示，可直接解析 HTML 提取。

**图片列表 API：**

```
GET https://webarchives.tnm.jp/dlib/pages/{book_id}
```

返回 JSON 数组，每个元素包含：
- `imageType`：图片类型
- `imageid`：图片标识符
- `ready`：是否可用
- `id`：内部 ID
- `path`：图片路径

**图片属性：**

```
GET https://webarchives.tnm.jp/dlib/img/{book_id}/tiles/{imageid}/ImageProperties.xml
```

返回 Zoomify 格式的 XML 图片属性信息，包含分块参数。

### 字段映射

| 中文字段 | 提取方式 |
|---------|---------|
| 資料番号 | HTML 详情页解析 |
| 資料名 | HTML 详情页解析 |
| 著者 | HTML 详情页解析 |
| 图片列表 | JSON API `/dlib/pages/{book_id}` |
| 图片分块信息 | XML `/dlib/img/{book_id}/tiles/{imageid}/ImageProperties.xml` |

## 下载

### 数字图书馆（Zoomify 分块方式）

数字图书馆不支持 IIIF，使用 Leaflet + Zoomify 分块加载方式。

**下载流程：**

1. 获取图片列表：`GET /dlib/pages/{book_id}` -> JSON 数组
2. 获取每张图片的 Zoomify 属性：`GET /dlib/img/{book_id}/tiles/{imageid}/ImageProperties.xml`
3. 根据属性中的分块信息拼接完整图片（或使用 dezoomify 工具）

**图片 URL 模式：**
```
https://webarchives.tnm.jp/dlib/img/{book_id}/tiles/{imageid}/    # Zoomify 分块目录
https://webarchives.tnm.jp/dlib/img/{book_id}/thumb/{filename}    # 缩略图
https://webarchives.tnm.jp/dlib/img/{book_id}/medium/{filename}   # 中等分辨率
```

### bookget 支持

bookget 已内置东京国立博物馆数字图书馆支持。

- 源码：https://github.com/deweizhu/bookget/blob/main/app/tnm.go
- bookget wiki：https://github.com/deweizhu/bookget/wiki/04.%E5%8F%AF%E7%94%A8%E7%9A%84%E7%BD%91%E7%AB%99URL
- 用法示例：
  ```
  bookget "https://webarchives.tnm.jp/dlib/detail/615"
  ```

**bookget 关键逻辑（tnm.go）：**

1. 用正则 `/dlib/detail/([A-z0-9_-]+)` 从 URL 提取 `book_id`
2. 请求 `/dlib/pages/{book_id}` 获取 JSON 图片列表
3. 对每张图片，构造 Zoomify 属性 URL `/dlib/img/{book_id}/tiles/{imageid}/ImageProperties.xml`
4. 使用 IIIF 下载器（dezoomify 模式）下载深度缩放图片
5. 文件名格式：`%04d.ext`

**必需的 HTTP 请求头：**

| Header | 值 |
|--------|---|
| `User-Agent` | 可配置 |
| `Referer` | 详情页 URL（需 URL encode） |
| `Origin` | 从 Referer 提取 |

### ColBase / E国宝

ColBase 和 E国宝 使用 IIIF 协议，详细的 IIIF 下载方法参见 [E国宝文档](E国宝.md)。

- eMuseum 源码：https://github.com/deweizhu/bookget/blob/main/app/emuseum.go
- IIIF Manifest 格式：`https://emuseum.nich.go.jp/iiifapi/{book_id}/manifest.json`

### 图片保护

- 数字图书馆：无水印，需设置 Referer 头
- ColBase：无水印，需设置 Referer 头
- 数字图书馆返回 HTTP 202 表示图片正在生成中，需等待后重试
