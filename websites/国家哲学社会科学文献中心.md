# 国家哲学社会科学文献中心（古籍）

<!--
  本文件分两部分：
  - 分割线以上：用户文档，面向普通用户，语言简洁易懂，不含技术细节
  - 分割线以下：开发者文档，面向程序员，包含 API、HTML 解析、下载逻辑等技术细节
-->

国家哲学社会科学文献中心（NCPSSD）由中国社会科学院图书馆建设维护，是国家级哲学社会科学学术资源平台。其古籍板块收录了中国社会科学院图书馆馆藏古籍的扫描影像，按经、史、子、集、志五部分类，面向社会免费开放。

- 网站链接：https://www.ncpssd.cn/Literature/ancientbooklist?nav=5
- 主站地址：https://www.ncpssd.cn/
- 旧域名：https://www.ncpssd.org/（已迁移至 ncpssd.cn）
- 建设单位：中国社会科学院图书馆
- 约 19,880 部古籍，超过 150 万张影像
- 资源类型：善本、普通古籍、方志
- 不支持 IIIF 协议
- 支持 [bookget](https://github.com/deweizhu/bookget) 下载（需 cookie 鉴权）

## 搜索与浏览

- 古籍列表页：https://www.ncpssd.cn/Literature/ancientbooklist?nav=5
- 在古籍列表页上方有搜索框，输入书名关键词即可搜索
- 支持高级搜索（布尔表达式：AND、OR、NOT），可按题名、著者、出版者、出版日期、条码号等字段组合查询
- 浏览方式：按经、史、子、集、志五部分类浏览
  - 经部：约 2,315 部
  - 史部：约 4,837 部
  - 子部：约 3,034 部
  - 集部：约 2,103 部
  - 方志：约 3,116 部
- 列表支持切换文字列表/图片缩略图两种显示模式
- 列表支持按默认排序、时间排序
- 需要注册登录后才能在线阅读和下载全文；浏览列表和查看基本信息不需要登录
- 注册方式：手机号注册，免费

## 每本书能看到什么

| 字段 | 说明 | 示例 |
|------|------|------|
| 题名 | 书名 | 古今韻攷四卷 |
| 著者 | 作者/编者 | （清）李因篤 撰 |
| 出版者 | 刻印机构 | 待确认 |
| 出版日期 | 刊刻年代 | 待确认 |
| 卷数 | 全书卷册数 | 四卷 |
| 分类 | 经/史/子/集/志 | 经部 |
| 条码号 | 馆藏条码编号 | 70017604 |

- 登录后可在线翻阅古籍影像（PDF 格式）
- 登录后可下载 PDF 全文
- 无 OCR 全文文字
- 无特殊阅读功能（对照阅读、AI 标点等）

## 示例

- 古籍列表（经部）：https://www.ncpssd.cn/Literature/ancientbooklist?nav=5
- 详情页示例：https://www.ncpssd.cn/Literature/articleinfo?id=GJ402771&type=Ancient&typename=%E5%8F%A4%E7%B1%8D&nav=5&barcodenum=70017604
- PDF 在线阅读示例：https://www.ncpssd.org/Literature/fullTextRead?filePath=https%3A%2F%2Fft.ncpssd.org%2Fpdf%2Fgetn%2Fancient%2Fpdf%2F70017386.pdf

---

# 开发者文档

## URL 结构

### 古籍列表页

```
https://www.ncpssd.cn/Literature/ancientbooklist?nav=5
```
- `nav=5`：固定参数，表示古籍板块

### 详情页

```
https://www.ncpssd.cn/Literature/articleinfo?id={article_id}&type=Ancient&typename=%E5%8F%A4%E7%B1%8D&nav=5&barcodenum={barcode_num}
```
- `id`：文章/古籍 ID，如 `GJ402771`
- `type`：固定值 `Ancient`
- `typename`：固定值 `古籍`（URL 编码）
- `nav`：固定值 `5`
- `barcodenum`：馆藏条码号，如 `70017604`

### PDF 在线阅读页

```
https://www.ncpssd.org/Literature/fullTextRead?filePath={encoded_pdf_url}
```
- `filePath`：URL 编码后的 PDF 文件地址

### PDF 文件直接地址

```
https://ft.ncpssd.org/pdf/getn/ancient/pdf/{barcode_num}.pdf
```
- `barcode_num`：条码号，如 `70017386`

## 搜索 API

网站为传统多页面渲染 + JavaScript 增强，古籍搜索的具体 API 端点待确认。从页面行为观察：

- 列表页可能通过表单提交或 AJAX 请求进行搜索和分页
- 高级搜索支持布尔表达式（AND、OR、NOT）
- 筛选维度：题名、分类、卷数、条码号、著者、出版者、出版日期、索书号

具体搜索 API 的请求格式和响应结构待进一步抓包确认。

## 元数据获取

网站整体不是纯 SPA，但详情页可能有部分动态加载内容。WebFetch 对详情页返回了主站首页内容，说明详情页的实际数据可能通过 JavaScript 动态渲染加载。

### 已知 API 端点

根据 bookget 源码 (`ncpssd.go`) 分析：

**获取阅读地址：**
```
GET https://www.ncpssd.cn/Literature/readurl?id={bookId}&type=3
```
- 请求头需要：`X-Requested-With: XMLHttpRequest`
- 响应中包含 `url` 字段，即 PDF 的可读地址

**获取下载签名：**
```
POST https://www.ncpssd.cn/common/getMinioSign
```
- Content-Type: `application/json; charset=utf-8`
- 响应 JSON 结构：
```json
{
  "result": true,
  "code": 200,
  "data": "签名token字符串",
  "succee": true
}
```

### bookId 提取

从页面 URL 中提取 bookId 有两种方式：
- 查询参数方式：URL 中的 `barcodenum=([A-Za-z0-9_-]+)` 参数
- 路径方式：PDF 路径中的 `pdf/([A-Za-z0-9_-]+)\.pdf`

### 字段映射

| 中文字段 | 提取方式 |
|---------|---------|
| 题名 | 详情页 HTML 解析（待确认具体选择器） |
| 著者 | 详情页 HTML 解析（待确认具体选择器） |
| 分类 | URL 参数或页面分类标签 |
| 条码号 | URL 参数 `barcodenum` |
| 文章ID | URL 参数 `id` |

> 由于详情页为动态渲染，静态抓取无法获取元数据。可能需要通过其他 API 端点获取元数据，或使用浏览器自动化工具。具体元数据 API 待确认。

## 下载

### bookget 支持

bookget 已支持 NCPSSD 古籍下载。源码位于：
- https://github.com/deweizhu/bookget/blob/main/app/ncpssd.go

**使用方式：**

1. 在网站注册账号并登录
2. 创建 `cookie.txt` 文件（参考 bookget wiki 第 07 节 Cookie 鉴权说明）
3. 输入古籍 URL 即可下载

**支持的 URL 格式：**
```
https://www.ncpssd.cn/Literature/articleinfo?id=GJ402771&type=Ancient&typename=%E5%8F%A4%E7%B1%8D&nav=5&barcodenum=70017604
```
```
https://www.ncpssd.org/Literature/fullTextRead?filePath=https%3A%2F%2Fft.ncpssd.org%2Fpdf%2Fgetn%2Fancient%2Fpdf%2F70017386.pdf
```

### 下载逻辑（基于 bookget 源码分析）

1. 从 URL 中提取 `barcodenum`（即 bookId）
2. 调用 `GET /Literature/readurl?id={bookId}&type=3` 获取 PDF 阅读地址
   - 需要 Cookie 鉴权
   - 需要请求头 `X-Requested-With: XMLHttpRequest`
3. 如果返回的 URL 包含 `fullTextRead?filePath=`，则从中提取实际 PDF 地址
4. 调用 `POST /common/getMinioSign` 获取下载签名 token
5. 使用签名 token 下载 PDF 文件
   - 必需请求头：
     - `Referer`：来源页面地址
     - `Origin`：来源域名
     - `site: npssd`（注意不是 ncpssd）
     - `sign: {token}`（从 MinioSign 接口获得的签名）
6. 文件保存为 `{bookId}.pdf`

### 注意事项

- 下载并发度设为 1（单线程下载）
- 需要登录态（Cookie），未登录无法获取阅读地址
- PDF 文件托管在 `ft.ncpssd.org` 域名下，使用 MinIO 对象存储
- 签名 token 有时效性，需在下载前实时获取
- 新域名 ncpssd.cn 和旧域名 ncpssd.org 的 API 行为可能存在差异，建议以 ncpssd.cn 为准
