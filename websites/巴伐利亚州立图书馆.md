# 巴伐利亚州立图书馆（BSB）

<!--
  本文件分两部分：
  - 分割线以上：用户文档，面向普通用户，语言简洁易懂，不含技术细节
  - 分割线以下：开发者文档，面向程序员，包含 API、HTML 解析、下载逻辑等技术细节
-->

巴伐利亚州立图书馆（Bayerische Staatsbibliothek，简称 BSB）位于德国慕尼黑，是欧洲最重要的综合性研究图书馆之一。其东亚收藏包括约 233,500 册中文印本和 3,500 件中文手稿，是中国以外收藏1900年以前中文文献最多的欧洲图书馆之一。慕尼黑数字化中心（MDZ）负责数字化工作，2011-2015 年间在德国研究联合会（DFG）资助下完成了约 12,000 册最珍贵中文古籍的编目和全文数字化，后又通过与 Google 合作完成了另外约 15,000 册的数字化。目前大部分1870年以前出版的中文馆藏均可在线浏览。

- 网站链接：https://www.digitale-sammlungen.de/（主站）/ https://ostasien.digitale-sammlungen.de/（东亚专题）
- 分享协议：多数古籍标注 [No Copyright - Non-Commercial (NoC-NC 1.0)](https://rightsstatements.org/page/NoC-NC/1.0/)，具体见各数字对象页面
- 约 27,000+ 册已数字化中文古籍（含印本和手稿），超过 200 万张扫描图片
- 资源类型：善本古籍、手稿（含敦煌写本）、瑶族手稿、佛教/道教典籍、明代殿版及藩府刻本、基督教传教士出版物
- 支持 IIIF 协议，可使用 [bookget](https://github.com/deweizhu/bookget) 等工具下载

### 珍贵馆藏

- 约 20 种宋元刻本（960-1368）
- 100 余种明刻本（1368-1644），其中部分为海内外孤本
- 3 件唐代敦煌写卷（618-907）
- 约 2,800 件瑶族宗教手稿（来自中国南方、泰国、老挝、越南）
- 毛晋刊刻十七史全套

## 搜索与浏览

本馆有两个在线入口，功能互补：

### 主站 MDZ（digitale-sammlungen.de）

- 搜索页面：https://www.digitale-sammlungen.de/en/search
- 可在"元数据"（题名、著者、出版地等）和"全文"两个范围中搜索
- 支持中文原文和拼音检索
- 搜索支持通配符（`*` 和 `?`）、短语搜索（引号）、布尔运算（AND / OR / NOT）、邻近搜索（`~`）、模糊搜索等
- 可通过筛选器 `features:"iiif"` 只显示支持 IIIF 的数字对象
- 无需注册登录即可搜索和浏览

### 东亚专题站（ostasien.digitale-sammlungen.de）

- 搜索页面：https://ostasien.digitale-sammlungen.de/search?locale=cn
- 专为东亚古籍设计的界面，支持中文、德文、英文三种语言
- 搜索类型：自由搜索、按著者/人名、按题名、按索书号
- 支持中文原字和拉丁转写（拼音）检索，输入拉丁字母时有自动补全
- 可按出版日期、题名、著者/人名排序浏览
- 无需注册登录

### OPAC 联合目录

- OPAC 搜索：https://opacplus.bsb-muenchen.de/discovery/search?vid=49BVB_BSB:VU1&lang=en
- 可检索全部馆藏（含未数字化的），数字化项目会提供在线浏览链接

## 每本书能看到什么

| 字段 | 说明 | 示例 |
|------|------|------|
| 题名 | 书名（拼音 + 原文） | Ping zhu yuan hai zi ping da quan / 评注渊海子平大全 |
| 著者 | 作者/编者 | Guanghanzi (广寒子) |
| 出版信息 | 出版地、书坊、年代 | Fuzhou: Chan shan shu lin, Lao hui xian tang [1812] |
| 卷册 | 卷数与册数 | 4 juan, 3 ce |
| 语言 | 语种 | Chinese (中文) |
| 馆藏信息 | 馆藏地及索书号 | Munchen, Bayerische Staatsbibliothek -- L.sin. C 255-1/3 |
| 版本注记 | 版本说明 | Yong an tang cang ban |
| 文献类型 | 载体类型 | Book (书) |
| 权利声明 | 使用许可 | No Copyright - Non-Commercial (NoC-NC/1.0) |

- 使用内嵌的 Mirador 3 阅读器在线逐页浏览高清图片
- 可下载 PDF（低分辨率，可选全本或指定页码范围）
- 可通过 DaFo 服务订购 300 ppi 高分辨率 JPEG（需填写邮箱，最快24小时生成，保留2周）
- 部分文献有 OCR 全文（hOCR 格式）

## 示例

- 东亚专题站详情页：https://ostasien.digitale-sammlungen.de/view/bsb11129280?locale=cn
- MDZ 主站详情页：https://www.digitale-sammlungen.de/en/view/bsb11129280?page=,1
- OPAC 目录记录：https://opacplus.bsb-muenchen.de/discovery/search?vid=49BVB_BSB:VU1&lang=en

---

# 开发者文档

## URL 结构

### 东亚专题站详情页
```
https://ostasien.digitale-sammlungen.de/view/{bsb_id}/{page}
```
- `bsb_id`：BSB 数字对象标识符，格式为 `bsb` + 8位数字，如 `bsb11129280`
- `page`：起始页码（从1开始），如 `/1`

### MDZ 主站详情页
```
https://www.digitale-sammlungen.de/en/view/{bsb_id}?page=,{page}
```
- `bsb_id`：同上
- `page`：起始页码

### IIIF Manifest
```
https://api.digitale-sammlungen.de/iiif/presentation/v2/{bsb_id}/manifest
```
示例：https://api.digitale-sammlungen.de/iiif/presentation/v2/bsb11129280/manifest

### IIIF Image API
```
https://api.digitale-sammlungen.de/iiif/image/v2/{image_id}/{region}/{size}/{rotation}/{quality}.{format}
```
- `image_id`：格式为 `{bsb_id}_{5位页码}`，如 `bsb11129280_00001`
- `region`：裁剪区域，`full` 为完整图片
- `size`：输出尺寸，`full` 为原始尺寸
- `rotation`：旋转角度，`0` 为不旋转
- `quality`：质量，`default` 为默认
- `format`：格式，`jpg` / `png`

示例（获取第1页完整原始尺寸图片）：
```
https://api.digitale-sammlungen.de/iiif/image/v2/bsb11129280_00001/full/full/0/default.jpg
```

### Image Info
```
https://api.digitale-sammlungen.de/iiif/image/v2/{image_id}/info.json
```

### OCR 文字
```
https://api.digitale-sammlungen.de/ocr/{bsb_id}/{5位页码}
```
- 返回 XML 格式（hOCR）
- 示例：https://api.digitale-sammlungen.de/ocr/bsb11129280/00010

### IIIF Collection（顶层）
```
https://api.digitale-sammlungen.de/iiif/presentation/v2/collection/top
```

## 搜索 API

### MDZ 主站搜索

主站搜索为 Web 界面，URL 格式：
```
https://www.digitale-sammlungen.de/en/search?q={query}&filter={filter}
```
- `q`：搜索关键词，支持中文和拼音
- `filter`：筛选条件，如 `features%3A%22iiif%22` 表示仅显示 IIIF 项目

搜索运算符：
- 通配符：`*`（任意字符）、`?`（单个字符）
- 短语搜索：用引号包裹，如 `"周易"`
- 布尔运算：`AND`、`OR`、`NOT`，或用 `+`（必须包含）、`-`（排除）
- 邻近搜索：`"term1 term2"~n`（n 为最大间隔词数）
- 模糊搜索：`term~`
- 权重：`term^n`（n 为权重因子）

无公开的 JSON 搜索 API。搜索结果通过 JavaScript 渲染（SPA），无法直接从 HTML 获取。

### 东亚专题站搜索

```
https://ostasien.digitale-sammlungen.de/search?q={query}&searchType={type}&locale={locale}
```
- `q`：搜索关键词
- `searchType`：搜索类型，`free`（自由搜索）等
- `locale`：语言，`en` / `de` / `cn`

搜索结果通过 AJAX 动态加载。

### OAI-PMH 元数据收割

```
https://oai.bsb-muenchen.de/doc/en/bavarian-digital-repository
```
支持 OAI-PMH 协议，可用于批量收割数字对象元数据。

## 元数据获取

### 通过 IIIF Manifest 获取（推荐）

请求 IIIF Manifest JSON-LD，从 `.metadata` 数组中提取字段：

```
GET https://api.digitale-sammlungen.de/iiif/presentation/v2/{bsb_id}/manifest
```

返回 JSON-LD，结构示例：
```json
{
  "@context": "http://iiif.io/api/presentation/2/context.json",
  "@type": "sc:Manifest",
  "label": "Ping zhu yuan hai zi ping da quan",
  "metadata": [
    { "label": "Creator", "value": "Guanghanzi (广寒子)" },
    { "label": "Title", "value": "Ping zhu yuan hai zi ping da quan / 评注渊海子平大全" },
    { "label": "Creation", "value": "Fuzhou: Chan shan shu lin, Lao hui xian tang [1812]" },
    { "label": "Extent", "value": "4 juan, 3 ce" },
    { "label": "Language", "value": "Chinese (中文)" },
    { "label": "Location", "value": "Munchen, Bayerische Staatsbibliothek -- L.sin. C 255-1/3" },
    { "label": "Media Type", "value": "Book (书)" },
    { "label": "Rights", "value": "No Copyright - Non-Commercial (NoC-NC/1.0)" }
  ],
  "sequences": [
    {
      "canvases": [
        {
          "@id": "bsb11129280/canvas/1",
          "label": "(0001)",
          "width": 1540,
          "height": 2797,
          "images": [
            {
              "resource": {
                "service": {
                  "@id": "https://api.digitale-sammlungen.de/iiif/image/v2/bsb11129280_00001"
                }
              }
            }
          ]
        }
      ]
    }
  ]
}
```

### 字段映射

| 中文字段 | 提取方式（IIIF Manifest） |
|---------|--------------------------|
| 题名 | `.metadata[]` 中 `label == "Title"` 的 `value` |
| 著者 | `.metadata[]` 中 `label == "Creator"` 的 `value` |
| 出版信息 | `.metadata[]` 中 `label == "Creation"` 的 `value` |
| 卷册 | `.metadata[]` 中 `label == "Extent"` 的 `value` |
| 语言 | `.metadata[]` 中 `label == "Language"` 的 `value` |
| 馆藏信息 | `.metadata[]` 中 `label == "Location"` 的 `value` |
| 版本注记 | `.metadata[]` 中 `label == "Note"` 的 `value` |
| 文献类型 | `.metadata[]` 中 `label == "Media Type"` 的 `value` |
| 权利声明 | `.metadata[]` 中 `label == "Rights"` 的 `value` |
| 总页数 | `.sequences[0].canvases` 数组长度 |
| 页面图片 | `.sequences[0].canvases[n].images[0].resource.service["@id"]` |

## 下载

### IIIF 下载（推荐）

BSB 完整支持 IIIF Image API 2.1 和 Presentation API 2.1，CORS 已启用（`Access-Control-Allow-Origin: *`），可直接从浏览器或任意客户端访问。

**完整下载流程：**

1. 获取 Manifest：
   ```
   GET https://api.digitale-sammlungen.de/iiif/presentation/v2/{bsb_id}/manifest
   ```

2. 遍历 `.sequences[0].canvases` 数组，获取每页的 image service ID：
   ```
   canvases[n].images[0].resource.service["@id"]
   → https://api.digitale-sammlungen.de/iiif/image/v2/bsb11129280_00001
   ```

3. 拼接完整图片 URL：
   ```
   {service_id}/full/full/0/default.jpg
   → https://api.digitale-sammlungen.de/iiif/image/v2/bsb11129280_00001/full/full/0/default.jpg
   ```

4. 如需指定尺寸（如宽度限制为 1000px）：
   ```
   {service_id}/full/1000,/0/default.jpg
   ```

**注意事项：**
- Image API 有每日请求量限制（具体阈值未公布）
- OCR 下载也有每日限制
- 无需认证、无 Cookie 要求、无 Referer 校验
- 无水印

### bookget 支持

bookget 通过 `sammlungen.go` 支持本站下载。

- 源码：https://github.com/deweizhu/bookget/blob/main/app/sammlungen.go
- 支持的 URL 格式：
  - `https://ostasien.digitale-sammlungen.de/view/bsb11129280/1`
  - `https://www.digitale-sammlungen.de/en/view/bsb11129280?page=,1`
- 下载逻辑：
  1. 通过正则 `/view/([A-z\d]+)` 从 URL 提取 `bsb_id`
  2. 构建 IIIF Manifest URL：`https://api.digitale-sammlungen.de/iiif/presentation/v2/{bsb_id}/manifest`
  3. 调用通用 IIIF 下载模块（`iiif.InitWithId()`）完成图片下载

### DaFo 高分辨率订购

通过 DaFo 服务可获取 300 ppi 高分辨率 JPEG：
- 需要填写邮箱注册
- 完成验证码验证
- 最快24小时生成，最长可达4周
- 下载链接保留2周后自动删除
- 可同时请求 OCR 文字文件

### PDF 下载

通过 Mirador 阅读器的下载按钮可获取低分辨率 PDF，支持全本或选择页码范围。

### DFG Metadata (METS/MODS)

```
https://api.digitale-sammlungen.de/dfg/mets/mods/v1/digitalobjects/identifier
```
可获取 DFG 标准格式的元数据。
