# 中国国家图书馆 - 中华古籍资源库

"中华古籍保护计划"重要成果，国家图书馆建设的综合性古籍特藏数字资源发布共享平台，是国内规模最大的古籍数字化资源库。

- 网站链接：http://read.nlc.cn/thematDataSearch/toGujiIndex
- 新平台（智慧化）：https://guji.nlc.cn/（详见 [中华古籍智慧化服务平台](中华古籍智慧化服务平台.md)）
- 分享协议：[免费开放·禁止商用·禁止批量下载](https://www.nlc.cn/web/dzzn/ds_bjyxz/index.shtml)（无需注册登录即可阅览）
- 约 10.6 万部（件）古籍，29 个专题资源库
- 资源类型：善本古籍、普通古籍、甲骨文、敦煌文献、碑帖拓片、西夏文献、赵城金藏、地方志、家谱等
- 不支持 IIIF 协议，可使用 [bookget](https://github.com/deweizhu/bookget) 下载

## 搜索与浏览

在首页搜索框输入关键词即可搜索，也可使用高级搜索按多个字段组合检索：

- 搜索页面：http://read.nlc.cn/thematDataSearch/toGujiIndex
- 高级搜索：http://read.nlc.cn/advanceSearch/gujiSearch
- 无需注册登录即可搜索和阅览

## 每本书能看到什么

| 字段 | 说明 | 示例 |
|------|------|------|
| 题名 | 书名 | 欽定古今圖書集成 |
| 责任者 | 作者/编者 | (清)蔣廷錫，陳夢雷等輯 |
| 出版发行项 | 出版机构+年代 | 內府清雍正4年[1726] |
| 善本书号 | 善本编号 | 12072 |
| 版本项 | 版本类型 | 活字印本 銅活字 |
| 版本书目史注 | 行款版式 | 9行20字，白口，四周雙邊。 |
| 四部分类号 | 四部分类 | 子 類書 |
| 现有藏本附注 | 藏本备注 | （可为空） |
| 丛编项 | 丛书信息 | （可为空） |

不同专题资源库的字段可能有差异（如永青文库、云南古籍等会额外显示提要等字段）。

每本书都可在线翻阅（PDF 阅读器），部分资源支持对照阅读（影印版 + 矢量文字版）。无全文文字下载。

## 示例

- 详情页（多册）：http://read.nlc.cn/allSearch/searchDetail?searchType=1002&showType=1&indexName=data_892&fid=411999021002
- 在线阅读（单册）：http://read.nlc.cn/OutOpenBook/OpenObjectBook?aid=892&bid=96323.0

---

# 开发者文档

## URL 结构

### 详情页（searchDetail）
```
http://read.nlc.cn/allSearch/searchDetail?searchType={searchType}&showType=1&indexName=data_{aid}&fid={fid}
```
- `searchType`：搜索类型（`1002` = 古籍善本，`all` = 全部，`12` = 对照阅读）
- `showType`：显示类型（固定为 `1`）
- `indexName`：数据索引名（如 `data_892`、`data_1080`、`data_403`，数字部分即为 aid）
- `fid`：资源唯一标识符

### 单册阅读页（OpenObjectBook）
```
http://read.nlc.cn/OutOpenBook/OpenObjectBook?aid={aid}&bid={bid}
```
- `aid`：档案/集合 ID（archive ID）
- `bid`：书册 ID（book ID），带小数点，如 `96323.0`

### 单张图片页（OpenObjectPic）
```
http://read.nlc.cn/OutOpenBook/OpenObjectPic?aid={aid}&bid={bid}&lid={lid}&did={did}
```
- `lid`：图片层 ID
- `did`：文档标识符

### 对照阅读页（OpenTwoObjectBook）
```
http://read.nlc.cn/OutOpenBook/OpenTwoObjectBook?aid={aid}&bid={bid}&cid={cid}
```
- `bid`：影印版书册 ID
- `cid`：矢量版（OCR）书册 ID

## 搜索 API

无公开 API，需通过页面搜索。

## 元数据获取

### HTML 结构

页面为服务端渲染，可通过 HTTP GET 获取完整 HTML。

#### 隐藏字段

```html
<input type="hidden" id="title" name="title" value="欽定古今圖書集成">
<input type="hidden" id="author" name="author" value="(清)蔣廷錫，陳夢雷等輯">
<input type="hidden" id="identifier" name="identifier">
<input type="hidden" id="indexName" name="indexName">
```

提取正则：
```regex
<input[^>]+id="title"[^>]+value="([^"]*)"
<input[^>]+id="author"[^>]+value="([^"]*)"
```

#### 封面图片
```css
div.pic img                /* 封面图片 */
```

#### 标题
```css
div.title                  /* 书名标题 */
```

#### 详细元数据区域

所有元数据字段位于 `<div class="XiangXi TB Z_clearfix">` 中，每个字段为 `<label>` 内含两个 `<span>`：

```html
<div class="XiangXi TB Z_clearfix">
    <label>
        <span class="tt">责任者：</span><span class="t1">(清)蔣廷錫，陳夢雷等輯</span>
    </label>
    ...
</div>
```

**CSS 选择器：**
```css
div.XiangXi label           /* 每个元数据字段 */
div.XiangXi span.tt         /* 字段名 */
div.XiangXi span.t1         /* 字段值 */
```

**提取正则（所有字段键值对）：**
```regex
<span class="tt">([^<]+)</span><span class="t1">([^<]*)</span>
```
- 捕获组 1：字段名（如"责任者："）
- 捕获组 2：字段值（如"(清)蔣廷錫，陳夢雷等輯"）
- 注意：部分字段值可能为空字符串

### 字段映射

| 中文字段 | 提取方式 |
|---------|---------|
| 题名 | hidden input `#title` 或 `div.title` |
| 责任者 | hidden input `#author` 或 `span.tt` 含"责任者" |
| 出版发行项 | `span.tt` 含"出版发行项" |
| 善本书号 | `span.tt` 含"善本书号" |
| 版本项 | `span.tt` 含"版本项" |
| 版本书目史注 | `span.tt` 含"版本书目史注" |
| 四部分类号 | `span.tt` 含"四部分类号" |
| 现有藏本附注 | `span.tt` 含"现有藏本附注" |
| 丛编项 | `span.tt` 含"丛编项" |

注意：不同专题资源库（indexName）的字段可能有差异。

### 书册列表提取

书册列表位于 `<div id="multiple" class="YMH2019_New_Book_module1">` 中：

```css
#multiple ul.ul2 li a.aa     /* 册名（如"第1册"） */
#multiple ul.ul2 li a.a1     /* 阅读链接 */
```

提取正则：
```regex
<a class="a1"[^>]+href="(/OutOpenBook/OpenObjectBook\?aid=\d+&bid=[\d.]+)"   /* 阅读链接 */
<a[^>]+class="aa">([^<]+)</a>                                                  /* 册名 */
```

### 判断单册/多册

页面 JavaScript 中的 `flag` 变量：
```regex
var flag = '([01])';
```
- `0` = 一种多册（显示 `#multiple`）
- `1` = 一种一册（显示 `#single`）

### 资源标识符提取
```regex
identifier\s*=\s*["']([^"']+)["']    /* 从 JavaScript 变量 */
fid=([A-Za-z0-9]+)                    /* 从 URL 参数 */
```

## 下载

### PDF 下载

需要先从 OpenObjectBook 页面获取认证参数：

```regex
(tokenKey|timeKey|timeFlag)="([a-zA-Z0-9]+)"
```

PDF 端点：
```
{scheme}://{host}/menhu/OutOpenBook/getReaderNew?aid={aid}&bid={bid}&kime={timeKey}&fime={timeFlag}
```

必需请求头：
```
User-Agent: [配置的UA]
Referer: http://read.nlc.cn/static/webpdf/lib/WebPDFJRWorker.js
Range: bytes=0-1
myreader: {tokenKey}
```

注意事项：
- 下载的 PDF 包含水印
- SSL 验证需禁用（`InsecureSkipVerify: true`）
- 需要 Cookie 管理（CookieJar）

### 图片下载

图片 URL 通过专门的 API 获取，根据 `aid` 值选择不同端点：

| aid 值 | API 端点 |
|--------|---------|
| 495, 952, 467, 1080 | `/allSearch/openBookPic?id={bid}&l_id={lid}&indexName=data_{aid}` |
| 022 | `/allSearch/openPic_noUser?id={bid}&identifier={did}&indexName=data_{aid}` |
| 其他 | `/allSearch/openPic?id={bid}&identifier={did}&indexName=data_{aid}` |

返回的 HTML 中包含图片标签：
```regex
<img\s+src="(http|https)://(read|mylib).nlc.cn([^"]+)"
```

必需请求头：
```
User-Agent: [配置的UA]
Referer: [URL编码的原始页面URL]
```

### bookget 支持

bookget 完整支持此平台。相关源码：
- https://github.com/deweizhu/bookget/blob/main/app/nlc.go

不支持 IIIF 协议，使用平台自有的 API 和 PDF/图片下载方式。
