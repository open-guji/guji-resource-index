# 斯坦福大学图书馆

<!--
  本文件分两部分：
  - 分割线以上：用户文档，面向普通用户，语言简洁易懂，不含技术细节
  - 分割线以下：开发者文档，面向程序员，包含 API、HTML 解析、下载逻辑等技术细节
-->

斯坦福大学图书馆（Stanford University Libraries）是美国西部最重要的东亚研究图书馆之一。其东亚图书馆（East Asia Library）收藏超过 78 万册中、日、韩文印刷品，并通过斯坦福数字仓库（Stanford Digital Repository, SDR）提供部分数字化馆藏的在线访问。斯坦福是 IIIF（国际图像互操作框架）标准的联合创始机构，其数字化资源全面支持 IIIF 协议。

- 网站链接：https://searchworks.stanford.edu/（搜索目录）；https://purl.stanford.edu/（数字仓库持久链接）
- 分享协议：需联系东亚图书馆获取出版或复制许可（eastasialibrary@stanford.edu）
- 数字化古籍数量：待确认（中文在线图书可通过 SearchWorks 检索，总量待确认）
- 资源类型：道教典籍、连环画、近现代文献、照片档案、法律文书、工作单位档案等
- 支持 IIIF 协议，可使用 [bookget](https://github.com/deweizhu/bookget) 等工具下载

## 搜索与浏览

- 搜索页面：https://searchworks.stanford.edu/
- 中文在线图书专用筛选链接：https://searchworks.stanford.edu/?f%5Baccess_facet%5D%5B%5D=Online&f%5Bbuilding_facet%5D%5B%5D=East+Asia&f%5Bformat_main_ssim%5D%5B%5D=Book&f%5Blanguage%5D%5B%5D=Chinese
- 在搜索框输入关键词即可搜索，支持中英文检索
- 搜索结果可按以下维度筛选：
  - 资源类型（Book、Image 等）
  - 访问方式（Online / 在馆）
  - 语言（Chinese、Japanese、Korean 等）
  - 所在馆藏（East Asia Library、SAL3 等）
  - 主题（Topic）
  - 出版年代
- 无需注册登录即可搜索和浏览数字化资源

## 每本书能看到什么

| 字段 | 说明 | 示例 |
|------|------|------|
| 题名 | 书名（罗马拼音 + 中文原名） | Xing ming shuang xiu wan shen gui zhi（性命雙修萬神圭旨） |
| 著者 | 作者/刻者 | Yinzhenren（尹眞人）；刻 錢羽振 |
| 出版年代 | 刊刻或出版年份 | 1669 |
| 出版地 | 出版或刊刻地点 | China |
| 语言 | 文种 | Chinese |
| 物理描述 | 册数、尺寸等 | 4 volumes in 1 case : illustrations ; 28 cm |
| 主题分类 | 四部分类或主题词 | Zi bu > Dao jia lei（子部 > 道家类） |
| OCLC 号 | WorldCat 标识号 | 123019352 |
| 持久链接 | PURL 永久地址 | https://purl.stanford.edu/ps830cb4030 |

- 数字化资源可通过内嵌的 Mirador 阅读器在线翻阅高清图片
- 无直接 PDF 下载功能，但可通过 IIIF 协议获取高清图片
- 无全文文字（OCR）

## 示例

- 详情页（数字仓库）：https://purl.stanford.edu/ps830cb4030
  - 《性命雙修萬神圭旨》卷一，尹眞人著，1669 年刊刻
- 详情页（搜索目录）：https://searchworks.stanford.edu/view/6702046
  - 《春覺齋論畫遺稾》，林紓著，1935 年出版
- IIIF Manifest 示例：https://purl.stanford.edu/ps830cb4030/iiif/manifest
- 在线阅读（Mirador 阅读器）：https://library.stanford.edu/iiif?manifest=https://purl.stanford.edu/ps830cb4030/iiif/manifest

---

# 开发者文档

## URL 结构

### 数字仓库详情页（PURL）
```
https://purl.stanford.edu/{druid}
```
- `druid`：斯坦福数字仓库对象的唯一标识符，格式为 `{2字母}{3数字}{2字母}{4数字}`，例如 `ps830cb4030`

### IIIF Manifest
```
https://purl.stanford.edu/{druid}/iiif/manifest
```
示例：
- https://purl.stanford.edu/ps830cb4030/iiif/manifest
- https://purl.stanford.edu/bk647km0637/iiif/manifest
- https://purl.stanford.edu/gw762st1671/iiif/manifest
- https://purl.stanford.edu/tj200hs5535/iiif/manifest

### IIIF 图片 API
```
https://stacks.stanford.edu/image/iiif/{druid}%2F{image_filename}/{region}/{size}/{rotation}/{quality}.{format}
```
- 完整图片示例：`https://stacks.stanford.edu/image/iiif/ps830cb4030%2Fps830cb4030_sul_eal_1920_9_1532_v1_00001/full/full/0/default.jpg`
- 合规级别：IIIF Image API 2.0，Level 2

### SearchWorks 目录页
```
https://searchworks.stanford.edu/view/{catkey}
```
- `catkey`：MARC 记录编号，纯数字，例如 `6702046`

## 搜索 API

SearchWorks 基于 [Blacklight](https://github.com/projectblacklight/blacklight) 开源框架构建，底层使用 Apache Solr 搜索引擎。Blacklight 原生支持 JSON API。

### 搜索请求
```
GET https://searchworks.stanford.edu/catalog.json?q={query}&f[{facet}][]={value}&per_page={n}&page={p}
```

常用参数：
| 参数 | 说明 | 示例值 |
|------|------|--------|
| `q` | 搜索关键词 | `周易` |
| `search_field` | 搜索字段 | `all_fields`（默认）、`title`、`author` |
| `f[language][]` | 语言筛选 | `Chinese` |
| `f[access_facet][]` | 访问方式 | `Online` |
| `f[building_facet][]` | 馆藏位置 | `East Asia` |
| `f[format_main_ssim][]` | 资源类型 | `Book` |
| `per_page` | 每页条数 | `20` |
| `page` | 页码 | `1` |

### 单条记录 JSON
```
GET https://searchworks.stanford.edu/view/{catkey}.json
```

**注意**：SearchWorks 部署了 Cloudflare Turnstile 反爬机制，JSON API 可能被拦截，需要通过浏览器验证后方可访问。程序化访问可能需要处理此限制。

### 响应结构（单条记录 .json）

关键字段：
```json
{
  "response": {
    "document": {
      "id": "6702046",
      "title_display": "Chun jue zhai lun hua yi gao",
      "vern_title_display": "春覺齋論畫遺稾",
      "author_person_display": "Lin, Shu, 1852-1924",
      "vern_author_person_display": "林紓, 1852-1924",
      "pub_display": "Beiping : Yanjing da xue tu shu guan",
      "pub_date": "1935",
      "language": ["Chinese"],
      "physical": "[2], 37 p. : ill. ; 26 cm.",
      "format_main_ssim": ["Book"],
      "topic_facet": ["Painting, Chinese"],
      "oclc": "28942330",
      "marc_json_struct": "...(完整 MARC JSON)"
    }
  }
}
```

## 元数据获取

### 方式一：SearchWorks JSON API（需处理反爬）
通过 `https://searchworks.stanford.edu/view/{catkey}.json` 获取结构化 JSON 数据。

### 方式二：IIIF Manifest
通过 `https://purl.stanford.edu/{druid}/iiif/manifest` 获取 IIIF Manifest（JSON-LD），其中 `metadata` 数组包含基本元数据。

### 方式三：PURL 页面 HTML 解析
PURL 页面（`https://purl.stanford.edu/{druid}`）为服务端渲染，可直接解析 HTML 提取元数据。

### 字段映射（SearchWorks JSON）

| 中文字段 | JSON 路径 |
|---------|---------|
| 题名（罗马拼音） | `response.document.title_display` |
| 题名（中文） | `response.document.vern_title_display` |
| 著者（罗马拼音） | `response.document.author_person_display` |
| 著者（中文） | `response.document.vern_author_person_display` |
| 出版信息 | `response.document.pub_display` |
| 出版年代 | `response.document.pub_date` |
| 语言 | `response.document.language[]` |
| 物理描述 | `response.document.physical` |
| 资源类型 | `response.document.format_main_ssim[]` |
| 主题 | `response.document.topic_facet[]` |
| OCLC 号 | `response.document.oclc` |
| 索书号 | `response.document.callnum_exact_search` |
| 馆藏位置 | `response.document.building_facet` |

### 字段映射（IIIF Manifest metadata）

IIIF Manifest 中的 `metadata` 为数组，每项包含 `label` 和 `value`：

| label | 对应中文字段 |
|-------|------------|
| Title | 题名 |
| Contributor | 著者/相关人 |
| Format | 物理描述 |
| Language | 语言 |
| Date | 出版/刊刻年代 |
| Subject | 主题分类 |
| Identifier | 标识符（OCLC 号、PURL 等） |

## 下载

### IIIF 下载（推荐）

斯坦福数字仓库全面支持 IIIF Image API 2.0（Level 2），可通过标准 IIIF 协议下载高清图片。

**流程：**
1. 获取 IIIF Manifest：`GET https://purl.stanford.edu/{druid}/iiif/manifest`
2. Manifest 使用 IIIF Presentation API v2（`@context` 包含 `presentation/2/`）
3. 解析 `sequences[0].canvases[]`，每个 canvas 代表一页
4. 从每个 canvas 的 `images[0].resource.service.@id` 获取 Image Service 基础 URL
5. 拼接图片 URL：`{service_id}/full/full/0/default.jpg`

**Image Service 基础 URL 格式：**
```
https://stacks.stanford.edu/image/iiif/{druid}%2F{filename}
```

**完整图片 URL 格式：**
```
https://stacks.stanford.edu/image/iiif/{druid}%2F{filename}/full/full/0/default.jpg
```

**其他尺寸：**
```
# 指定宽度
https://stacks.stanford.edu/image/iiif/{druid}%2F{filename}/full/{width},/0/default.jpg

# info.json（获取完整图片信息，含尺寸、瓦片等）
https://stacks.stanford.edu/image/iiif/{druid}%2F{filename}/info.json
```

### bookget 支持

bookget 通过通用 IIIF 模块支持斯坦福大学图书馆（无专用 stanford.go 源码）。使用方式为直接传入 IIIF Manifest URL：

```bash
bookget https://purl.stanford.edu/ps830cb4030/iiif/manifest
```

bookget 的 IIIF 处理逻辑（`app/iiif.go`）：
- 自动检测 IIIF v2/v3（通过 `@context` 中是否含 `presentation/3/`）
- v2：遍历 `sequences[0].canvases[]` 获取图片
- v3：遍历 `canvases[].items[0].items[0]` 获取图片
- 支持直接下载模式（拼接 `/full/full/0/default.jpg`）和 dezoomify 模式（使用 `/info.json`）
- 请求头包含 User-Agent、Origin、Referer 和 Cookie 管理

### 访问限制

- 无水印
- 无 Referer 校验（待确认）
- PURL 页面和 IIIF Manifest 无需登录即可访问
- SearchWorks JSON API 有 Cloudflare Turnstile 反爬保护
- 图片下载是否有速率限制：待确认
- 部分资源可能有访问限制（取决于版权状态），大部分古籍应为开放访问
