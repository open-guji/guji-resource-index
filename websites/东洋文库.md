# 东洋文库

东洋文库（The Toyo Bunko / 東洋文庫）是日本最大的亚洲研究专业图书馆，位于东京都文京区，由三菱财阀第三代岩崎久弥于1924年创立。馆藏约100万件资料，其中包括5件国宝和7件重要文化财。东洋文库的数字资源通过两个平台提供：**媒体资料库（Media Repository）** 和 **NII 丝绸之路贵重书数字档案**。

- 媒体资料库：https://app.toyobunko-lab.jp/
- NII 贵重书档案：https://dsr.nii.ac.jp/toyobunko/
- 数据库总览：https://toyo-bunko.or.jp/database/
- 分享协议：[使用许可](http://dsr.nii.ac.jp/toyobunko/license/)（NII档案），媒体资料库另有规定
- NII 档案收录 245 部贵重书，共 72,591 页图像（82 位作者）
- 媒体资料库持续增加中，含古籍、地图、照片等
- 资源类型：探险记录、学术研究、历史文献、照片、地图、汉籍善本
- 支持 IIIF 协议，可使用 [bookget](https://github.com/deweizhu/bookget) 等工具下载（NII档案已确认支持）
- 支持日文和英文界面

## 搜索与浏览

东洋文库有两个独立的数字平台，搜索方式各不相同：

### NII 贵重书数字档案（丝绸之路文献）

- 入口：https://dsr.nii.ac.jp/toyobunko/index.html.ja（日文）/ https://dsr.nii.ac.jp/toyobunko/index.html.en（英文）
- 提供全文检索、逐页搜索、图像搜索、地图搜索
- 可按作者列表、语言列表、丛书列表、卷册列表浏览
- 按五大类浏览：探险记录（165册）、学术研究（43册）、历史文献（7册）、照片（12册）、地图（18册）
- 无需注册登录

### 媒体资料库（Omeka S 平台）

- 入口：https://app.toyobunko-lab.jp/
- 支持按关键词搜索、按集合（Item Sets）浏览、按树形结构浏览
- 于2021年6月试运行，2022年6月正式上线
- 无需注册登录

### 其他数据库

- 汉籍数据库（漢籍データベース）：汉籍专用检索
- 东洋文库 OPAC：书目检索系统，预计2028年完成与 CiNii Books 的对接
- ERNEST：学术成果库，收录《东洋学报》等出版物

## 每本书能看到什么

### NII 贵重书档案

| 字段 | 说明 | 示例 |
|------|------|------|
| Title / 題名 | 书名 | 圓明園東長春宮西洋樓圖 |
| Creator / 著者 | 作者 | 朗世寧（Castiglione） |
| Date Issued / 出版年 | 出版年代 | 1785 |
| Extent / 尺寸 | 物理尺寸 | 98x64 cm |
| Language / 言語 | 语言 | Chinese (zho) |
| Volume / 卷 | 卷册 | vol.1 |
| DOI | 数字对象标识符 | 10.20676/00000272 |

提供 IIIF 高清图像查看器（IIIF Curation Viewer），支持高分辨率在线翻阅。提供芝加哥、APA、哈佛、IEEE 等引用格式。

### 媒体资料库

| 字段 | 说明 | 示例 |
|------|------|------|
| タイトル / Title | 书名 | 標題句解孔子家語三卷 |
| Identifier | UUID 标识符 | 5842ff99-34d3-9308-539b-21e83a78bcff |
| Call Mark / 請求記号 | 馆藏号 | 貴重書 三-A-a-5 |
| Creator / 著者 | 作者/编者 | 元王廣謀撰 |
| Date Issued / 出版年 | 出版年代 | 1599（慶長四年） |
| Edition / 版本 | 版本信息 | 德川家康伏見木活字印本 |
| Physical Description | 册数/形制 | 3巻3冊 |
| Provenance / 来源 | 来源文库 | 岩崎文庫 |
| Owner / 所蔵 | 所属机构 | 東洋文庫 |
| Viewing Direction | 阅读方向 | right-to-left |

提供 Mirador 和 Universal Viewer 两种 IIIF 查看器，支持在线翻阅。

## 示例

### NII 贵重书档案

- 详情页：https://dsr.nii.ac.jp/toyobunko/XI-6-A-16/V-1/
- IIIF Manifest：https://dsr.nii.ac.jp/toyobunko/XI-6-A-16/V-1/manifest.json
- IIIF 查看器：https://dsr.nii.ac.jp/toyobunko/viewer/index.html?manifest=https://dsr.nii.ac.jp/toyobunko/V-B-1-64/V-3/manifest.json

### 媒体资料库

- 详情页：https://app.toyobunko-lab.jp/s/main/document/5842ff99-34d3-9308-539b-21e83a78bcff
- 集合页：https://app.toyobunko-lab.jp/s/main/collection/daiminchiri
- IIIF Manifest：https://app.toyobunko-lab.jp/iiif/2/5842ff99-34d3-9308-539b-21e83a78bcff/manifest

---

# 开发者文档

东洋文库的数字资源分布在两个独立平台上，技术栈不同，需分别处理。

## URL 结构

### NII 贵重书档案（dsr.nii.ac.jp）

#### 详情页
```
https://dsr.nii.ac.jp/toyobunko/{book_id}/{volume_id}/
```
- `book_id`：书籍标识符，如 `XI-6-A-16`、`V-B-1-64`、`VIII-5-B2-9`
- `volume_id`：卷册标识符，如 `V-1`、`V-3`

#### IIIF Manifest
```
https://dsr.nii.ac.jp/toyobunko/{book_id}/{volume_id}/manifest.json
```

#### IIIF Image API
```
https://dsr.nii.ac.jp/toyobunko/iiif/{book_id}/{volume_id}/{page_num}.tif/{region}/{size}/{rotation}/{quality}.{format}
```
示例：
```
https://dsr.nii.ac.jp/toyobunko/iiif/XI-6-A-16/V-1/1.tif/full/full/0/default.jpg
```

#### IIIF Curation Viewer
```
https://dsr.nii.ac.jp/toyobunko/viewer/index.html?manifest=https://dsr.nii.ac.jp/toyobunko/{book_id}/{volume_id}/manifest.json&pos={page}&lang={ja|en}
```

### 媒体资料库（app.toyobunko-lab.jp）

#### 详情页
```
https://app.toyobunko-lab.jp/s/main/document/{uuid}
```
- `uuid`：UUID 格式标识符，如 `5842ff99-34d3-9308-539b-21e83a78bcff`

#### 集合页
```
https://app.toyobunko-lab.jp/s/main/collection/{collection_slug}
```
- `collection_slug`：集合别名，如 `daiminchiri`

#### IIIF Manifest（Presentation API 2.0）
```
https://app.toyobunko-lab.jp/iiif/2/{uuid}/manifest
```

#### IIIF Image API（Image API 2.0, Level 1）
```
https://img.toyobunko-lab.jp/iiif/{collection_path}/{file}.tif/{region}/{size}/{rotation}/{quality}.{format}
```
示例：
```
https://img.toyobunko-lab.jp/iiif/100y/tenkanshomoku_02/3-A-a-5/honshi/3-A-a-5-0(1)/3-A-a-5-0(1)_0001.tif/full/full/0/default.jpg
```
注意：图片服务域名为 `img.toyobunko-lab.jp`，与主站域名不同。

## 搜索 API

### NII 贵重书档案

提供全文检索、逐页搜索、图像搜索和地图搜索功能。具体 API 端点待确认，页面搜索功能可能通过表单提交实现。

### 媒体资料库（Omeka S API）

基于 Omeka S 平台，提供标准 REST API：

```
GET https://app.toyobunko-lab.jp/api/items
GET https://app.toyobunko-lab.jp/api/item-sets
GET https://app.toyobunko-lab.jp/api/media
```

支持 Omeka S 标准查询参数：
- `search`：关键词搜索
- `item_set_id`：按集合筛选
- `per_page`：每页数量
- `page`：分页

注意：`/api/item-sets` 在测试中返回 500 错误，可能有访问限制或配置问题。`/api/items` 正常返回。

## 元数据获取

### NII 贵重书档案

元数据可通过 IIIF manifest 获取。manifest 中包含 Dublin Core / DCTERMS 字段：

#### 字段映射

| 中文字段 | 来源 |
|---------|------|
| 题名 | manifest `label` |
| 著者 | manifest `metadata[]` → `dcterms:creator` |
| 出版年 | manifest `metadata[]` → `dcterms:issued` |
| 尺寸 | manifest `metadata[]` → `dcterms:extent` |
| 卷册 | manifest `metadata[]` → `bibo:volume` |
| 归属 | manifest `attribution` |

页面同时提供 JSON-LD 结构化数据（含 DOI）。

### 媒体资料库

通过 Omeka S API 获取：
```
GET https://app.toyobunko-lab.jp/api/items/{id}
```

#### 字段映射

| 中文字段 | JSON 路径 |
|---------|----------|
| 题名 | `dcterms:title[0].@value` |
| 标识符 | `dcterms:identifier[0].@value` |
| 描述 | `dcterms:description[0].@value` |
| 权利信息 | `dcterms:rights[0].@value` |
| 所属机构 | `bibo:owner[0].@value` |
| 馆藏号 | `bibo:number[0].@value` |
| 缩略图 | `thumbnail_display_urls.large` / `.medium` / `.square` |
| 关联媒体 | `o:media[]` |
| 关联数据库 | `dcterms:isReferencedBy[0].@value` |
| 阅读方向 | `bibo:pageStart`（待确认，right-to-left 标记方式） |

## 下载

### IIIF 下载（NII 贵重书档案）

支持 IIIF Presentation API 2.0 和 Image API 2.0（Level 2）。

从 manifest 获取图片流程：
1. 获取 manifest：`https://dsr.nii.ac.jp/toyobunko/{book_id}/{volume_id}/manifest.json`
2. 解析 `sequences[0].canvases[]`
3. 提取每个 canvas 的 `images[0].resource.service.@id`（即 image service ID）
4. 拼接 IIIF Image API 下载最大尺寸：`{service_id}/full/full/0/default.jpg`
5. 或获取 info.json 用于 dezoomify 下载：`{service_id}/info.json`

图像分辨率：单页约 11,295 x 13,824 px，双页展开约 20,334 x 13,748 px。

### IIIF 下载（媒体资料库）

支持 IIIF Presentation API 2.0 和 Image API 2.0（Level 1）。

从 manifest 获取图片流程：
1. 获取 manifest：`https://app.toyobunko-lab.jp/iiif/2/{uuid}/manifest`
2. 解析 `sequences[0].canvases[]`
3. 提取每个 canvas 的 `images[0].resource.service.@id`
4. Image service 位于 `img.toyobunko-lab.jp` 域名
5. 拼接下载：`{service_id}/full/full/0/default.jpg`

图像分辨率：示例约 11,648 x 8,736 px。
注意：Level 1 仅保证支持 `full/full` 和 `full/{width},` 两种尺寸请求模式。

### bookget 支持

bookget 通过 `niiac.go` 支持 NII 贵重书档案（dsr.nii.ac.jp/toyobunko）：
- 源码：https://github.com/deweizhu/bookget/blob/main/app/niiac.go
- 通用 IIIF 源码：https://github.com/deweizhu/bookget/blob/main/app/iiif.go

关键下载逻辑：
1. 从 URL 中用正则 `toyobunko/([^/]+)/([^/]+)` 提取 book_id 和 volume_id
2. 访问详情页，从 HTML 中用正则提取 manifest.json 的 URL
3. 解析 IIIF manifest，遍历 `sequences[].canvases[]`
4. 获取每个 canvas 的 image service URL
5. 支持两种下载模式：
   - 标准模式：直接拼接 `{imageService}/{format}` 下载 JPEG
   - Dezoomify 模式：通过 `{imageService}/info.json` 获取瓦片信息，使用 dezoomify-rs 拼接高分辨率图像
6. 支持断点续传和多线程下载

bookget wiki 示例 URL：
```
http://dsr.nii.ac.jp/toyobunko/XI-6-A-16/V-1/
```

媒体资料库（app.toyobunko-lab.jp）的 bookget 支持情况待确认，但由于其使用标准 IIIF，理论上可通过通用 IIIF 模块处理。
