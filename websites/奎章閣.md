# 奎章閣（Kyujanggak Institute for Korean Studies）

<!--
  本文件分两部分：
  - 分割线以上：用户文档，面向普通用户，语言简洁易懂，不含技术细节
  - 分割线以下：开发者文档，面向程序员，包含 API、HTML 解析、下载逻辑等技术细节
-->

奎章閣是韩国首尔大学下属的韩国学研究机构，前身为朝鲜王朝正祖大王于 1776 年在昌德宫创建的王室图书馆。现收藏超过 30 万件文献资料，包括约 17.5 万册古书、5 万件古文书和 1.8 万块印刷木版，其中朝鲜王朝实录、承政院日记等被列入联合国教科文组织世界记忆名录。通过 e-Kyujanggak 数字平台向全球用户提供检索和浏览服务。

- 网站链接：https://kyujanggak.snu.ac.kr/
- e-Kyujanggak 数字平台：https://kyudb.snu.ac.kr/
- 旧版入口：http://e-kyujanggak.snu.ac.kr/
- 分享协议：数字化资料供学术研究使用，具体条款见首尔大学规定
- 约 300,000 件以上文献资料（含古书、古文书、印版等）
- 资源类型：古书（经史子集）、古文书、印刷木版、古地图、仪轨（王室礼仪记录）
- 不支持 IIIF 协议

## 搜索与浏览

- 搜索页面：https://kyudb.snu.ac.kr/
- 输入关键词即可搜索（支持韩文、汉字）
- 支持按以下维度浏览和筛选：
  - 资料类型：古书、古文书、印版
  - 四部分类：经部、史部、子部、集部
  - 时代
  - 版本类型：木版本、活字本、写本等
- 提供专题浏览：
  - 朝鲜王朝实录
  - 承政院日记
  - 仪轨（王室礼仪图录）
  - 古地图
- 无需注册登录即可检索和浏览

## 每本书能看到什么

| 字段 | 说明 | 示例 |
|------|------|------|
| 书名 | 题名（汉字/韩文） | 卜筮正宗 |
| 请求记号 | 馆藏号 | 古133.5-W1849b-v.1-6 |
| 刊年 | 出版年代 | 光緖15年(1889) |
| 卷册 | 卷数和册数 | 14卷 6冊 |
| 版种 | 版本类型 | 木版本 |
| 크기 | 尺寸 | 23.2x15.1cm |
| 著者 | 作者/编者 | 王維德 |
| 刊行地 | 出版地 | 校經山房 |
| 分类 | 四部分类 | 子部 術數類 |

- 可在线逐页翻阅原文图片
- 支持图片放大缩小
- 部分资料提供 RIS 格式引用下载
- 提供 URL 复制功能（详情页右侧 "URL복사" 链接）
- 部分资料提供 PDF 下载
- 无全文 OCR 文字

## 示例

- 古书详情页：https://kyudb.snu.ac.kr/book/view.do?book_cd=GR35058_00
- 图片浏览：https://kyudb.snu.ac.kr/pf01/rendererImg.do?item_cd=JWS&book_cd=GK12719_00&vol_no=0001&page_no=000a

---

# 开发者文档

## URL 结构

### 古书详情页
```
https://kyudb.snu.ac.kr/book/view.do?book_cd={book_cd}
```
- `book_cd`：古书编码，如 `GR35058_00`
- 前缀字母表示资料类型（如 `GR`、`GK` 等）

### 图片浏览页
```
https://kyudb.snu.ac.kr/pf01/rendererImg.do?item_cd={item_cd}&book_cd={book_cd}&vol_no={vol_no}&page_no={page_no}
```
- `item_cd`：项目编码（如 `JWS`）
- `book_cd`：古书编码
- `vol_no`：册号（4 位零填充，如 `0001`）
- `page_no`：页码（如 `000a`）

### 图片下载
```
https://kyudb.snu.ac.kr/ImageServlet.do?imgFileNm={filename}&path={path}
```
- `imgFileNm`：图片文件名
- `path`：图片路径

### PDF 下载
```
https://kyudb.snu.ac.kr/book/mfPdf.do?book_cd={book_cd}&vol_no={vol_no}
```
- `book_cd`：古书编码
- `vol_no`：册号

## 搜索 API

无公开 REST API，需通过页面表单搜索。

部分内部 AJAX 接口：

### PDF 列表
```
POST https://kyudb.snu.ac.kr/ajax/book/mfPdfList.do
Content-Type: application/x-www-form-urlencoded
```
- 参数：`book_cd`
- 返回：JSON 格式的 PDF 文件列表

## 元数据获取

详情页为传统服务端渲染 HTML 页面，元数据嵌入在 HTML 中。

### 字段映射

| 中文字段 | 提取方式 |
|---------|---------|
| 题名 | HTML 解析，详情页标题区域 |
| 馆藏号 | HTML 解析，"请求记号" 字段 |
| 年代 | HTML 解析，"刊年" 字段 |
| 著者 | HTML 解析，"著者" 字段 |
| 版种 | HTML 解析，"版种" 字段 |
| 尺寸 | HTML 解析，"크기" 字段 |

## 下载

### bookget 支持

bookget 支持奎章閣数字平台的图片和 PDF 下载。

- 源码：https://github.com/deweizhu/bookget/blob/main/app/kyudbsnu.go
- 支持的 URL 格式：
  ```
  https://kyudb.snu.ac.kr/book/view.do?book_cd=GR35058_00
  https://kyudb.snu.ac.kr/pf01/rendererImg.do?item_cd=JWS&book_cd=GK12719_00&vol_no=0001&page_no=000a
  ```

#### 下载流程（基于 bookget 源码分析）

bookget 支持两种模式：

**模式 1：PDF 下载**

1. 检测详情页中是否存在 `name="mfpdf_link"` 表单元素
2. 如果存在，调用 PDF 列表 API：
   ```
   POST /ajax/book/mfPdfList.do
   ```
3. 解析返回的 JSON 获取各册 PDF URL
4. 构造下载链接：
   ```
   /book/mfPdf.do?book_cd={book_cd}&vol_no={vol_no}
   ```
5. 多线程下载 PDF 文件

**模式 2：图片下载**

1. 从详情页 HTML 中提取卷册列表（解析 `<option value=...>` 元素）
2. 逐册访问浏览器页面，提取各页图片信息
3. 从页面 onclick 事件中提取翻页参数
4. 构造图片下载 URL：
   ```
   /ImageServlet.do?imgFileNm={filename}&path={path}
   ```
5. 通过替换模板中的文件名和路径参数生成每页图片 URL

#### 必需的 HTTP 请求头

| 请求头 | 值 | 说明 |
|--------|-----|------|
| User-Agent | 自定义浏览器 UA | 必须设置 |
| Referer | 来源页面 URL | 必须设置为奎章閣页面 |
| Content-Type | application/x-www-form-urlencoded | POST 请求必须 |
| Cookie | 会话 Cookie | 通过 Cookie Jar 维护 |

### 注意事项

- 不支持 IIIF 协议
- 部分资料可能仅限现场阅览（详情页会显示提示）
- 图片下载需要先解析 HTML 获取文件路径，无法直接构造 URL
- 存在请求间隔限制，建议设置适当的延时
