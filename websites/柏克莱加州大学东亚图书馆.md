# 柏克莱加州大学东亚图书馆 - EAL Chinese Rare Books

柏克莱加州大学（UC Berkeley）C. V. Starr 东亚图书馆的中文善本数字化馆藏，托管于 UC Berkeley Digital Collections 平台（基于 Invenio 系统）。该馆是北美最大的宋元刻本收藏地之一，拥有 43 部宋元版本，共 366 册。近年来与四川大学合作、由阿里巴巴基金会资助，正在大规模数字化近万种 1912 年前的中文古籍，每年约处理 50 万页。

- 网站链接：https://digicoll.lib.berkeley.edu/
- 古籍集合：https://digicoll.lib.berkeley.edu/search?p=collection%3A%27EAL+Chinese+Rare+Books%27&ln=en
- 分享协议：公共领域资料可自由使用（[使用条款见详情页声明](https://digicoll.lib.berkeley.edu/record/73448?ln=en)："Researchers may make free and open use of UC Berkeley Library's digitized public domain materials"）
- 约 355 部已上线古籍（持续增加中，最终目标近万种）
- 资源类型：宋元刻本、明清刻本、手稿、抄本等善本古籍
- 部分资源支持 IIIF 协议（图片类资源有完整 IIIF Image API；PDF 类资源通过 IIIF Manifest 提供 PDF 下载链接）
- 可使用 [bookget](https://github.com/deweizhu/bookget) 下载

## 搜索与浏览

- 搜索页面：https://digicoll.lib.berkeley.edu/search?cc=EAL+Chinese+Rare+Books&ln=en
- 在搜索框输入关键词即可搜索，支持中英文
- 搜索结果可按以下方式排序：相关度、最新、年代、题名、著者（正序/倒序）
- 可按年代范围滑块筛选（1306–1883）
- 可选择每页显示 10、25、50 或 100 条结果
- 无需注册登录

## 每本书能看到什么

打开一本书的详情页，可以看到：

| 字段 | 说明 | 示例 |
|------|------|------|
| Title | 题名（罗马拼音 + 中文） | Chong guang bu zhu Huangdi nei jing su wen, er shi si juan / 重廣補註黃帝内經素問, 二十四卷 |
| Creator | 著者 | Wang Bing (fl. 762), Gu Congde, Liu Chenggan (1882-1963) |
| Published | 出版信息（地点、出版者、年代） | [China] : Gu Congde, Ming Jiajing geng xu (1550) |
| Subject | 主题分类 | Medicine, Chinese -- Early works to 1800 |
| Physical Description | 形制/册数 | 1 online resource (12 v.) |
| Type | 资源类型 | Text |
| Language | 语种 | Chinese |
| Collection | 所属集合 | EAL Chinese Rare Books |
| Archive | 馆藏机构 | East Asian Library |

- 可在详情页通过内置阅读器在线翻阅
- 大部分古籍以 PDF 格式提供，可直接下载各册 PDF
- 有"Copy IIIF Manifest"按钮可复制 IIIF Manifest 链接
- 支持导出元数据为 BibTeX、MARCXML、Dublin Core、EndNote、MODS、NLM、RefWorks 等格式

## 示例

- 详情页：https://digicoll.lib.berkeley.edu/record/73448?ln=en （重廣補註黃帝内經素問，明嘉靖刻本，12 册）
- 集合浏览：https://digicoll.lib.berkeley.edu/search?p=collection%3A%27EAL+Chinese+Rare+Books%27&sf=title&so=a&ln=en

---

# 开发者文档

## 平台技术栈

网站基于 **Invenio** 数字仓储系统（CERN 开发的开源数字图书馆平台），支持 IIIF 和多种元数据导出格式。

## URL 结构

### 详情页
```
https://digicoll.lib.berkeley.edu/record/{record_id}?ln=en
```
- `record_id`：数字 ID，如 `73448`、`91443`、`91514`

### IIIF Manifest（Presentation API 3.0）
```
https://digicoll.lib.berkeley.edu/record/{record_id}/export/iiif_manifest
```
也可通过旧版路径访问（Presentation API 2.0）：
```
https://digicoll.lib.berkeley.edu/nanna/iiif/{record_id}/manifest
```

### IIIF Image API（仅图片类资源）
```
https://digicoll.lib.berkeley.edu/nanna/api/multimedia/image/v2/recid:{record_id}-{bucket_id}_{file_id}.jpg/{region}/{size}/{rotation}/{quality}.{format}
```
- Image API 版本：IIIF Image API 2.0，Level 2
- 瓦片大小：1024px
- 缩放因子：1, 2, 4, 8, 16, 32

### 元数据导出（MARCXML）
```
https://digicoll.lib.berkeley.edu/record/{record_id}?ln=en&of=xm
```
- `of=xm`：MARCXML 格式输出

### 其他导出格式
```
https://digicoll.lib.berkeley.edu/record/{record_id}/export/{format}
```
可用 format 值：`hx`（BibTeX）、`xm`（MARCXML）、`xoaidc`（Dublin Core）、`xe`（EndNote）、`xn`（NLM）等。

## 搜索 API

基于 Invenio 的搜索接口，使用 GET 请求：

```
GET https://digicoll.lib.berkeley.edu/search?p={query}&cc=EAL+Chinese+Rare+Books&sf={sort_field}&so={sort_order}&rg={per_page}&jrec={start_from}&ln=en&of={output_format}
```

### 参数说明

| 参数 | 说明 | 示例值 |
|------|------|--------|
| `p` | 搜索关键词，支持 Invenio 查询语法 | `collection:'EAL Chinese Rare Books'` |
| `cc` | 集合名 | `EAL+Chinese+Rare+Books` |
| `sf` | 排序字段 | `title`、`year`、`creator`、`latest first` |
| `so` | 排序方向 | `a`（升序）、`d`（降序） |
| `rg` | 每页结果数 | `10`、`25`、`50`、`100` |
| `jrec` | 起始记录号（分页） | `1`、`11`、`21` |
| `ln` | 界面语言 | `en` |
| `of` | 输出格式 | `xm`（MARCXML）、`xoaidc`（Dublin Core） |
| `rm` | 排名方式 | 留空为相关度 |

### 搜索示例
```
https://digicoll.lib.berkeley.edu/search?p=collection%3A%27EAL+Chinese+Rare+Books%27&sf=title&so=a&rg=25&jrec=1&ln=en
```

## 文件列表 API

获取某条记录的所有文件列表（JSON 格式）：

```
GET https://digicoll.lib.berkeley.edu/api/v1/file?recid={record_id}&file_types=[]&hidden_types=["pdf;pdfa","hocr"]&ln=en&hr=1
```

### 响应结构
```json
[
  {
    "name": "000007910404211550_0A000.pdf",
    "url": "https://digicoll.lib.berkeley.edu/record/73448/files/000007910404211550_0A000.pdf",
    "size": 22038528,
    "description": "重廣補註黃帝内經素問 序/目錄"
  }
]
```

每个文件对象包含 `name`（文件名）、`url`（下载地址）、`size`（字节数）、`description`（卷册描述，中文）。

## 元数据获取

### 方式一：MARCXML（推荐）

请求 `?of=xm` 获取 MARCXML 格式：
```
GET https://digicoll.lib.berkeley.edu/record/{record_id}?ln=en&of=xm
```

### 方式二：IIIF Manifest

请求 IIIF Manifest（Presentation API 3.0），元数据在 `metadata` 数组中：
```
GET https://digicoll.lib.berkeley.edu/record/{record_id}/export/iiif_manifest
```

### 字段映射（MARC 字段）

| 中文字段 | MARC 字段 | 说明 |
|---------|-----------|------|
| 题名 | 245$a + 245$b | 题名 + 副题名 |
| 著者 | 700$a | 附加著者（可多个） |
| 出版地 | 260$a | 出版/刊刻地点 |
| 出版者 | 260$b | 出版者/刊刻者 |
| 出版年 | 260$c 或 269$a | 年代描述 或 数字年份 |
| 形制 | 300$a | 册数、页数 |
| 主题 | 650$a | 主题标引 |
| 语种 | 041$a | 语言代码 |
| 馆藏 | 852$a | 馆藏地 |
| 中文题名 | 880（对应 245） | 880 字段为并列中文著录 |
| 中文著者 | 880（对应 700） | 880 字段为并列中文著录 |

说明：880 字段（Alternate Graphic Representation）存放中文原文信息，通过 `$6` 子字段与对应的拉丁化字段关联。

## 下载

### 资源类型区分

Berkeley 的古籍有两种存储方式：
1. **PDF 文件**（大多数古籍）：每册一个 PDF，通过文件 API 获取下载链接
2. **图片文件**（海报、单页资料等）：JPG 格式，通过 IIIF Image API 访问

### PDF 类资源下载流程

1. 调用文件列表 API 获取所有 PDF URL：
   ```
   GET https://digicoll.lib.berkeley.edu/api/v1/file?recid={record_id}&file_types=[]&hidden_types=["pdf;pdfa","hocr"]&ln=en&hr=1
   ```
2. 遍历响应中的 `url` 字段，直接 HTTP GET 下载

PDF 直接下载 URL 格式：
```
https://digicoll.lib.berkeley.edu/record/{record_id}/files/{filename}.pdf
```

### 图片类资源下载（IIIF）

1. 获取 IIIF Manifest：
   ```
   GET https://digicoll.lib.berkeley.edu/record/{record_id}/export/iiif_manifest
   ```
2. 解析 manifest 中的 `items[]` → `items[]`（annotation pages）→ `items[]`（annotations）→ `body.service[].id`
3. 拼接 IIIF Image API URL：
   ```
   {service_id}/full/full/0/default.jpg       # 完整尺寸
   {service_id}/full/1024,/0/default.jpg      # 限宽 1024
   {service_id}/info.json                      # 图片元信息
   ```

### bookget 支持

bookget 通过 `app/berkeley.go` 支持此网站。

已注册域名：`digicoll.lib.berkeley.edu`

关键逻辑（基于源码分析）：
1. URL 正则提取 record ID：`(?i)record/([A-z0-9_-]+)`
2. 调用文件列表 API：`/api/v1/file?recid={id}&file_types=[]&hidden_types=["pdf;pdfa","hocr"]&ln=en&hr=1`
3. 遍历返回的文件列表，逐个下载
4. 文件按序号命名（0001、0002...）
5. 需要设置 Referer 头，使用 Cookie Jar 维持会话

相关源码：
- https://github.com/deweizhu/bookget/blob/main/app/berkeley.go

### 注意事项

- 无需认证即可下载公共领域资料
- 建议设置 Referer 头为 `https://digicoll.lib.berkeley.edu/`
- PDF 文件普遍较大（单册数十 MB），全书可达数百 MB
- 下载时建议控制并发，避免触发限流
- 图片类 IIIF 资源支持 Level 2，可按需裁剪和缩放
