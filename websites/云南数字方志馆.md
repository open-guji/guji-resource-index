# 云南数字方志馆

云南数字方志馆是云南省地方志编纂委员会办公室建设的地方志数字化平台，也是"一部手机读云南"项目的核心组成部分。平台系统收录云南省各级地方志书、年鉴及相关省情资料，涵盖旧志（清代及以前）和新志（1949年后第一轮、第二轮修志成果）。2020年12月上线。

- 网站链接：http://dfz.yn.gov.cn/record/home
- 分享协议：免费公开访问，无需注册登录
- 资源类型：地方志（旧志、新志）、综合年鉴、省情资料
- 旧志约 310 余种（云南现存历代旧志总量）
- 不支持 IIIF 协议
- 支持 [bookget](https://github.com/deweizhu/bookget) 下载（图片格式）

## 搜索与浏览

- 数字方志馆主页：http://dfz.yn.gov.cn/record/home
- 旧志浏览页：http://dfz.yn.gov.cn/record/main/local-record/old
- 新志浏览页：http://dfz.yn.gov.cn/record/main/local-record/new/states
- 网站为 SPA 单页应用，需启用 JavaScript
- 可按旧志、新志、年鉴等大类浏览
- 旧志按地区（州、府、县）分类
- 新志按行政区划分类（省级、州市级、县区级）
- 无需注册登录即可浏览和阅读

## 每本书能看到什么

| 字段 | 说明 | 示例 |
|------|------|------|
| 书名 | 方志名称 | 待确认 |
| 页数 | 总页数 | 待确认 |
| 分类 | 旧志/新志/年鉴 | 旧志 |

网站提供在线逐页翻阅影像（图片形式），部分内容提供 PDF 格式阅读。旧志以扫描影像为主，新志部分可能有全文文字。

## 示例

- 旧志阅读页：http://dfz.yn.gov.cn/record/pdf?id=old060001
- 旧志列表页：http://dfz.yn.gov.cn/record/main/local-record/old

---

# 开发者文档

## URL 结构

### 网站首页
```
http://dfz.yn.gov.cn/record/home
```

### 旧志分类页
```
http://dfz.yn.gov.cn/record/main/local-record/old
```

### 新志分类页
```
http://dfz.yn.gov.cn/record/main/local-record/new/states
```

### 阅读页
```
http://dfz.yn.gov.cn/record/pdf?id={book_id}
```
- `book_id`：书籍标识符，如 `old060001`（旧志以 `old` 开头）

## 搜索 API

网站为 SPA 应用，具体搜索 API 端点待确认。数据通过后端 API 异步加载，HTML 源码中无实际内容。

## 元数据获取

### 获取书籍信息和页面列表 API

```
GET {scheme}://{host}/api/record/pageAndCatalogInfo/getBookInfoByBookId?bookId={book_id}
```

**请求参数：**
- `bookId`：书籍ID，如 `old060001`

**响应结构（JSON）：**

```json
{
  "bookId": "old060001",
  "bookName": "书名",
  "totalPage": 123,
  "childCatalogList": [],
  "pageInfoList": [
    {
      "pageId": "页面ID",
      "pageNum": 1,
      "height": 1200.0,
      "width": 800.0,
      "pdfUrl": "PDF地址",
      "imgUrl": "图片地址",
      "content": "文字内容（如有）"
    }
  ]
}
```

### 字段映射

| 中文字段 | JSON 路径 |
|---------|---------|
| 书名 | `bookName` |
| 书籍ID | `bookId` |
| 总页数 | `totalPage` |
| 目录 | `childCatalogList` |
| 页面列表 | `pageInfoList` |
| 页面ID | `pageInfoList[].pageId` |
| 页码 | `pageInfoList[].pageNum` |
| 图片高度 | `pageInfoList[].height` |
| 图片宽度 | `pageInfoList[].width` |
| PDF地址 | `pageInfoList[].pdfUrl` |
| 图片地址 | `pageInfoList[].imgUrl` |

## 下载

### 图片下载流程

云南数字方志馆的图片下载需要两步：

**第1步：获取页面图片 URL 列表**

调用 `getBookInfoByBookId` API，从 `pageInfoList` 中提取每页的 `imgUrl` 字段。

**第2步：获取实际下载地址**

图片 URL 不能直接下载，需要通过以下 API 获取真实下载地址：

```
GET http://{host}/api/readRight/path/old040001?key={encoded_img_url}
```
- `key`：对 `imgUrl` 进行 URL 编码后的值

**响应结构：**
```json
{
  "url": "实际图片下载地址"
}
```

**第3步：下载图片**

使用返回的 `url` 下载图片，需携带以下请求头：
- `User-Agent`：标准浏览器 UA
- `Referer`：URL 编码后的阅读页地址

### 注意事项

- 图片地址需要通过中间 API 转换，不能直接访问 `imgUrl`
- 下载时需要携带 Referer 头
- 支持 Cookie 认证（通过 CookieFile 配置）

### bookget 支持

bookget 通过 `app/yndfz.go` 支持此网站。

关键逻辑：
1. 从 URL 中正则提取 `id` 参数：`id=([A-Za-z0-9]+)`
2. 调用 `/api/record/pageAndCatalogInfo/getBookInfoByBookId` 获取所有页面信息
3. 遍历 `pageInfoList`，提取每页的 `imgUrl`
4. 对每个 `imgUrl`，调用 `/api/readRight/path/old040001?key=` 获取真实下载地址
5. 使用真实地址下载图片，携带 Referer 和 User-Agent 请求头
6. 图片按顺序编号保存（0001、0002...）

相关源码：
- https://github.com/deweizhu/bookget/blob/main/app/yndfz.go
- https://github.com/deweizhu/bookget/blob/main/model/yndfz/yndfz.go
