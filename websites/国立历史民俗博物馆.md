# 国立历史民俗博物馆 (khirin-a)

<!--
  本文件分两部分：
  - 分割线以上：用户文档，面向普通用户，语言简洁易懂，不含技术细节
  - 分割线以下：开发者文档，面向程序员，包含 API、HTML 解析、下载逻辑等技术细节
-->

日本国立历史民俗博物馆（国立歴史民俗博物館，简称"历博"）建设的 khirin-a 数字影像档案，提供馆藏珍贵历史文献的高清数字影像。馆藏约 26.9 万件资料，其中 khirin-a 平台公开了包括宋版古籍（国宝级）、锦绘（浮世绘版画）、古文书等在内的多个专题数据库。

- 网站链接：https://khirin-a.rekihaku.ac.jp/
- 数据库总览：https://www.rekihaku.ac.jp/doc/t-db-index.html
- 分享协议：[CC BY 4.0](https://creativecommons.org/licenses/by/4.0/)（馆藏资料）；合作机构资料遵循各自协议
- 资源类型：宋版古籍（国宝）、锦绘版画、古文书、民俗调查卡片、延喜式抄本等
- 支持 IIIF 协议，可使用 [bookget](https://github.com/deweizhu/bookget) 等工具下载

## 搜索与浏览

khirin-a 平台按专题数据库组织，用户选择感兴趣的数据库后浏览其中的资料：

- 数据库列表：https://khirin-a.rekihaku.ac.jp/database
- 各数据库内按分页浏览，每页显示缩略图和标题
- 无需注册登录即可浏览大部分内容

### 主要古籍相关数据库

| 数据库 | 说明 |
|--------|------|
| 宋版史记（黄善夫刊本） | 国宝，南宋庆元年间（约1195-1201）刊本《史记》全130卷，共约90册 |
| 宋版汉书（庆元刊本） | 国宝，南宋庆元年间刊本《汉书》 |
| 宋版春秋经传集解 | 重要文化财，宋版木活字刊本 |
| 馆藏锦绘 | 浮世绘彩色版画，支持英文和罗马字检索 |
| 土御门家本延喜式 | 重要文化财，平安时代法令集抄本 |
| 聆涛阁集古帖 | 江户商人吉田家编辑的古物图录 |

此外还有多个古文书数据库（下�的坂家文书、梁川伊达家文书、町野家文书等）。

### 数据库总览（rekihaku 本体）

博物馆另有更多数据库在主站提供：https://www.rekihaku.ac.jp/doc/t-db-index.html
- 馆藏资料数据库：约 329,795 件（含图像）
- 中世文书、近世文书、武器甲冑等专题数据库
- 记录类全文数据库（古代日记等，部分需注册或到馆利用）

## 每本书能看到什么

以宋版史记为例：

| 字段 | 说明 | 示例 |
|------|------|------|
| 资料名 | 资料标题 | 宋版史記（黄善夫刊本）第一冊 |
| 时代 | 制作年代 | 南宋 |
| 所蔵館 | 收藏机构 | 国立歴史民俗博物館 |
| 利用条件 | 使用协议 | CC BY 4.0 |
| 関連リンク | RDF 资源链接 | khirin-ld 链接 |
| IIIF マニフェスト | IIIF manifest 链接 | 可复制用于外部查看器 |

- 每件资料提供 IIIF 高清影像查看器，支持缩放和翻页
- 可通过 IIIF manifest 在 Mirador 等外部查看器中打开
- 无直接 PDF 下载
- 无 OCR 全文

## 示例

- 宋版史记第一册：https://khirin-a.rekihaku.ac.jp/sohanshiki/h-172-1
- 宋版史记数据库首页：https://khirin-a.rekihaku.ac.jp/database/sohanshiki
- 宋版汉书数据库首页：https://khirin-a.rekihaku.ac.jp/database/sohankanjo
- IIIF Manifest 示例：https://khirin-a.rekihaku.ac.jp/manifests/sohan_shiki/H-172-01.json

---

# 开发者文档

## URL 结构

### 数据库列表页
```
https://khirin-a.rekihaku.ac.jp/database
```

### 专题数据库首页
```
https://khirin-a.rekihaku.ac.jp/database/{collection_id}
```
- `collection_id`：数据库标识，如 `sohanshiki`（宋版史记）、`sohankanjo`（宋版汉书）、`nmjh_nishikie`（锦绘）、`engishiki`（延喜式）等

### 资料详情页
```
https://khirin-a.rekihaku.ac.jp/{collection_id}/{item_id}
```
- `collection_id`：同上
- `item_id`：资料标识，如 `h-172-1`（小写连字符格式）
- 示例：`https://khirin-a.rekihaku.ac.jp/sohanshiki/h-172-1`

### IIIF Manifest
```
https://khirin-a.rekihaku.ac.jp/manifests/{manifest_path}/{ITEM_ID}.json
```
- `manifest_path`：manifest 路径，如 `sohan_shiki`（注意与 collection_id 的 `sohanshiki` 不同，有下划线）
- `ITEM_ID`：大写连字符格式，如 `H-172-01`（注意数字前补零）
- 示例：`https://khirin-a.rekihaku.ac.jp/manifests/sohan_shiki/H-172-01.json`

### khirin 关联数据系统
```
https://khirin-ld.rekihaku.ac.jp/rdf/{template_id}/{item_id}
```
- 关联数据（RDF/Linked Data）系统，提供结构化元数据
- 另有 `khirin-c.rekihaku.ac.jp`（旧版界面）和 `khirin-t.rekihaku.ac.jp`（专题工具如数字延喜式）

## 搜索 API

无已知的公开搜索 JSON API。数据库列表页和各专题数据库均为服务端渲染的 HTML 页面，通过分页浏览。

## 元数据获取

### 从详情页获取

详情页为服务端渲染 HTML 页面，包含：
- iframe 嵌入 IIIF 查看器，其 `src` 属性含 `manifest=` 参数
- 元数据字段以 HTML 表格或列表形式展示

### 从 IIIF Manifest 获取

IIIF manifest JSON 中包含 `metadata` 数组，存储书志信息。

### 从 Linked Data 获取

khirin-ld 系统提供 RDF 格式的结构化元数据，URL 格式：
```
https://khirin-ld.rekihaku.ac.jp/rdf/{template_id}/{item_id}
```

### 字段映射

| 中文字段 | 获取方式 |
|---------|---------|
| 资料名 | 详情页 HTML / IIIF manifest `metadata` |
| 时代 | 详情页 HTML / IIIF manifest `metadata` |
| 所蔵館 | 详情页 HTML |
| 利用条件 | 详情页 HTML（CC BY 4.0） |

## 下载

### IIIF 下载

支持 IIIF Presentation API，manifest 格式：
```
https://khirin-a.rekihaku.ac.jp/manifests/{manifest_path}/{ITEM_ID}.json
```

从 manifest 获取图片流程：
1. 获取 manifest JSON
2. 解析 `sequences[].canvases[]`（IIIF v2）或 `items[]`（v3）
3. 提取每个 canvas 的图片服务 URL
4. 拼接 IIIF Image API 参数下载

### bookget 支持

bookget 有专门的 `khirin.go` 源码支持此网站：
- 源码：https://github.com/deweizhu/bookget/blob/main/app/khirin.go

**bookget 下载逻辑（基于 khirin.go 分析）：**

1. **URL 解析**：使用正则 `ac.jp/([A-z\d_-]+)/([A-z\d_-]+)` 从 URL 提取两段 ID，合并为 `bookId`（如 `sohanshiki.h-172-1`）
2. **获取 Manifest**：
   - 先获取详情页 HTML
   - 从页面中查找 iframe 的 `src` 属性
   - 从 iframe src 中提取 `manifest=` 参数值得到 manifest URL
   - 如果 manifest 路径不是完整 URL，则拼接域名前缀
3. **图片下载**：
   - 解析 manifest 获取图片服务 ID
   - 支持两种模式：
     - dezoomify 模式：通过 info.json 端点获取图片信息，使用 IIIF dezoomify 工具下载高清拼接图
     - 普通模式：拼接配置的格式参数到服务 ID 后下载

**批量下载 URL 格式（bookget wiki）：**
```
https://khirin-a.rekihaku.ac.jp/sohanshiki/h-172-(1-90)
https://khirin-a.rekihaku.ac.jp/sohankanjo/h-173-(1-61)
```
- 使用括号 `(start-end)` 指定卷册范围，bookget 自动展开为多个 URL

### 注意事项

- 需设置 User-Agent 和 Referer 请求头
- 支持 Cookie jar 保持会话
- CC BY 4.0 协议需注明出处
- 馆藏以外的合作机构资料使用条件可能不同
